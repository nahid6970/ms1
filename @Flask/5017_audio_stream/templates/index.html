<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Audio Streamer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .control-section {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: #f8f9fa;
            overflow: hidden;
            position: relative;
        }
        
        .control-section h3 {
            color: #444;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .setup-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }
        
        .setup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }
        
        .start-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .stop-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .stop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .hear-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        .hear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .hear-btn.playing {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .setting-group {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .setting-group label {
            min-width: 120px;
            font-weight: 600;
            color: #555;
            flex-shrink: 0;
        }
        
        select, input[type="range"] {
            flex: 1;
            min-width: 0;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            max-width: 100%;
            box-sizing: border-box;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        select option {
            padding: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
                max-width: calc(100vw - 20px);
                overflow-x: hidden;
            }
            
            .setting-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                overflow: hidden;
            }
            
            .setting-group label {
                min-width: auto;
                text-align: left;
            }
            
            select {
                width: 100%;
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                max-width: calc(100vw - 80px); /* Ensure it fits within viewport */
                overflow: hidden;
            }
            
            select option {
                font-size: 14px;
                padding: 8px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
                padding: 15px;
                font-size: 16px;
                max-width: 100%;
                overflow: hidden;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .control-section {
                padding: 15px;
                margin: 15px 0;
                overflow: hidden;
            }
            
            .quality-indicator {
                margin-left: 0;
                margin-top: 5px;
                display: block;
                text-align: center;
            }
            
            .step {
                font-size: 13px;
                padding: 8px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                padding: 15px;
                border-radius: 10px;
            }
            
            .setting-group {
                margin: 10px 0;
            }
            
            .setting-group label {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            select, input[type="range"] {
                width: 100%;
                max-width: 100%;
                font-size: 16px;
            }
            
            .quality-indicator {
                font-size: 11px;
                padding: 3px 6px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            button {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        select:focus, input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        input[type="range"] {
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            padding: 0;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            font-size: 18px;
        }
        
        .status.streaming {
            background: linear-gradient(45deg, #4CAF50, #81C784);
            color: white;
        }
        
        .status.stopped {
            background: linear-gradient(45deg, #f44336, #e57373);
            color: white;
        }
        
        .status.ready {
            background: linear-gradient(45deg, #9C27B0, #BA68C8);
            color: white;
        }
        
        .audio-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        audio {
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
        }
        
        .stream-url {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .quality-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .quality-low { background: #ffeb3b; color: #333; }
        .quality-medium { background: #ff9800; color: white; }
        .quality-high { background: #4caf50; color: white; }
        
        .setup-instructions {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .setup-instructions.error {
            background: #ffebee;
            border-color: #f44336;
        }
        
        .step {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ PC Audio Streamer</h1>
        
        <div id="status" class="status stopped">
            Virtual Audio Setup Required
        </div>
        
        <div class="control-section">
            <h3>üîß Virtual Audio Setup</h3>
            <div class="button-group">
                <button class="setup-btn" onclick="downloadVirtualCable()">üì• Download VB-Audio Cable</button>
                <button class="start-btn" onclick="startStream()">Start Streaming</button>
                <button class="stop-btn" onclick="stopStream()">Stop Streaming</button>
            </div>
            
            <div class="setup-instructions" id="setupInstructions">
                <h4>üìã Setup Instructions:</h4>
                <div class="step">
                    <strong>Step 1:</strong> Download and install VB-Audio Virtual Cable (free software)
                </div>
                <div class="step">
                    <strong>Step 2:</strong> After installation, go to Windows Sound Settings:
                    <br>‚Ä¢ Right-click speaker icon ‚Üí Open Sound settings
                    <br>‚Ä¢ Select "CABLE Input" as your output device
                </div>
                <div class="step">
                    <strong>Step 3:</strong> Your system audio will now route through the virtual cable
                </div>
                <div class="step">
                    <strong>Step 4:</strong> Click "Start Streaming" - the app will automatically use "CABLE Output" to capture the audio
                </div>
                <div class="step">
                    <strong>Step 5:</strong> Access the stream from your Android at: <strong>http://YOUR_PC_IP:5017</strong>
                </div>
            </div>
            
            <div class="audio-controls">
                <audio id="audioPlayer" controls style="display: none;">
                    <source id="audioSource" src="" type="audio/wav">
                    Your browser does not support audio streaming.
                </audio>
                <div class="stream-url" id="streamUrl" style="display: none;">
                    Stream URL: <span id="urlText"></span>
                </div>
            </div>
        </div>
        
        <div class="control-section">
            <h3>‚öôÔ∏è Audio Settings</h3>
            
            <div class="setting-group">
                <label for="sampleRate">Sample Rate:</label>
                <select id="sampleRate" onchange="updateSettings()">
                    <option value="22050">22kHz (Fast)</option>
                    <option value="44100" selected>44kHz (CD Quality)</option>
                    <option value="48000">48kHz (Pro)</option>
                </select>
                <span class="quality-indicator quality-medium" id="sampleQuality">Medium</span>
            </div>
            
            <div class="setting-group">
                <label for="bitrate">Bitrate:</label>
                <input type="range" id="bitrate" min="64" max="320" value="128" step="32" onchange="updateBitrate()">
                <span id="bitrateValue">128k</span>
                <span class="quality-indicator quality-medium" id="bitrateQuality">Medium</span>
            </div>
            
            <div class="setting-group">
                <label for="channels">Channels:</label>
                <select id="channels" onchange="updateSettings()">
                    <option value="1">Mono (Fast)</option>
                    <option value="2" selected>Stereo (Better)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="chunkSize">Buffer:</label>
                <select id="chunkSize" onchange="updateSettings()">
                    <option value="512">512 (Low Delay)</option>
                    <option value="1024" selected>1024 (Balanced)</option>
                    <option value="2048">2048 (Stable)</option>
                </select>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="hear-btn" onclick="applyAndListen()" style="font-size: 18px; padding: 15px 30px;">
                    üéµ Apply Settings & Listen
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="hear-btn" onclick="toggleAudio()" id="hearBtn" style="display: none; font-size: 16px; padding: 12px 25px;">
                    üéß Hear Stream
                </button>
            </div>
        </div>
        
        <div class="control-section">
            <h3>üì± Connection Info</h3>
            <p><strong>Server Port:</strong> 5017</p>
            <p><strong>Stream Endpoint:</strong> /audio_stream</p>
            <p><strong>Android Access:</strong> http://YOUR_PC_IP:5017</p>
            <p><strong>Current Setup Status:</strong> <span id="setupStatus">Checking...</span></p>
        </div>
    </div>

    <script>
        let isStreaming = false;
        let virtualCableReady = false;
        
        function downloadVirtualCable() {
            window.open('https://vb-audio.com/Cable/', '_blank');
        }
        
        function checkSetup() {
            fetch('/check_setup')
                .then(response => response.json())
                .then(data => {
                    virtualCableReady = data.virtual_cable_available;
                    document.getElementById('setupStatus').textContent = 
                        virtualCableReady ? 'Virtual Cable Ready ‚úÖ' : 'Virtual Cable Not Found ‚ùå';
                    
                    const instructions = document.getElementById('setupInstructions');
                    if (virtualCableReady) {
                        instructions.className = 'setup-instructions';
                        instructions.innerHTML = `
                            <h4>‚úÖ Virtual Cable Detected!</h4>
                            <div class="step">
                                <strong>Quick Setup:</strong> Set "CABLE Input" as your Windows default audio device, then click "Start Streaming"
                            </div>
                            <div class="step">
                                To change audio output: Right-click speaker icon ‚Üí Open Sound settings ‚Üí Select "CABLE Input" as output device
                            </div>
                        `;
                    } else {
                        instructions.className = 'setup-instructions error';
                    }
                })
                .catch(error => {
                    console.error('Error checking setup:', error);
                });
        }
        
        function updateStatus(streaming) {
            const status = document.getElementById('status');
            const audioPlayer = document.getElementById('audioPlayer');
            const streamUrl = document.getElementById('streamUrl');
            const urlText = document.getElementById('urlText');
            const hearBtn = document.getElementById('hearBtn');
            
            isStreaming = streaming;
            
            if (streaming) {
                status.textContent = 'Stream Active üî¥';
                status.className = 'status streaming';
                
                // Show hear button and stream URL
                const streamUrlPath = window.location.origin + '/audio_stream';
                document.getElementById('audioSource').src = streamUrlPath;
                urlText.textContent = streamUrlPath;
                hearBtn.style.display = 'inline-block';
                streamUrl.style.display = 'block';
                audioPlayer.load();
            } else if (virtualCableReady) {
                status.textContent = 'Ready to Stream üü¢';
                status.className = 'status ready';
                hearBtn.style.display = 'none';
                streamUrl.style.display = 'none';
                audioPlayer.pause();
                hearBtn.textContent = 'üéß Hear Stream';
                hearBtn.className = 'hear-btn';
            } else {
                status.textContent = 'Setup Required ‚öôÔ∏è';
                status.className = 'status stopped';
                hearBtn.style.display = 'none';
                streamUrl.style.display = 'none';
            }
        }
        
        function startStream() {
            if (!virtualCableReady) {
                alert('Please install VB-Audio Virtual Cable first and restart the application.');
                return;
            }
            
            fetch('/start_stream', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'started') {
                        updateStatus(true);
                    } else {
                        alert('Failed to start stream: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error starting stream');
                });
        }
        
        function stopStream() {
            fetch('/stop_stream', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    updateStatus(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function toggleAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            const hearBtn = document.getElementById('hearBtn');
            
            if (audioPlayer.paused) {
                // Force reload the audio source to get fresh stream
                const streamUrlPath = window.location.origin + '/audio_stream?t=' + Date.now();
                document.getElementById('audioSource').src = streamUrlPath;
                audioPlayer.load();
                
                audioPlayer.play().then(() => {
                    hearBtn.textContent = 'üîá Stop Hearing';
                    hearBtn.className = 'hear-btn playing';
                }).catch(error => {
                    console.error('Error playing audio:', error);
                    alert('Error playing audio. Make sure the stream is active and try refreshing.');
                });
            } else {
                audioPlayer.pause();
                hearBtn.textContent = 'üéß Hear Stream';
                hearBtn.className = 'hear-btn';
            }
        }
        
        function applyAndListen() {
            // First update settings
            updateSettings();
            
            // Wait a moment for settings to apply
            setTimeout(() => {
                const audioPlayer = document.getElementById('audioPlayer');
                const hearBtn = document.getElementById('hearBtn');
                
                // If currently playing, stop first
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                }
                
                // If stream is active, restart audio with new settings
                if (isStreaming) {
                    // Reload audio with new settings
                    const streamUrlPath = window.location.origin + '/audio_stream?t=' + Date.now();
                    document.getElementById('audioSource').src = streamUrlPath;
                    audioPlayer.load();
                    
                    // Start playing with new settings
                    audioPlayer.play().then(() => {
                        if (hearBtn.style.display !== 'none') {
                            hearBtn.textContent = 'üîá Stop Hearing';
                            hearBtn.className = 'hear-btn playing';
                        }
                    }).catch(error => {
                        console.error('Error playing audio:', error);
                        alert('Error applying new settings. Try stopping and starting the stream.');
                    });
                } else {
                    alert('Please start streaming first, then use this button to apply settings and listen.');
                }
            }, 500);
        }
        
        function updateSettings() {
            const settings = {
                sample_rate: parseInt(document.getElementById('sampleRate').value),
                channels: parseInt(document.getElementById('channels').value),
                chunk_size: parseInt(document.getElementById('chunkSize').value),
                bitrate: parseInt(document.getElementById('bitrate').value)
            };
            
            fetch('/update_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Settings updated:', data);
                updateQualityIndicators();
            })
            .catch(error => {
                console.error('Error updating settings:', error);
            });
        }
        
        function updateBitrate() {
            const bitrate = document.getElementById('bitrate').value;
            document.getElementById('bitrateValue').textContent = bitrate + 'k';
            updateSettings();
        }
        
        function updateQualityIndicators() {
            const sampleRate = parseInt(document.getElementById('sampleRate').value);
            const bitrate = parseInt(document.getElementById('bitrate').value);
            
            // Update sample rate quality indicator
            const sampleQuality = document.getElementById('sampleQuality');
            if (sampleRate <= 22050) {
                sampleQuality.textContent = 'Low';
                sampleQuality.className = 'quality-indicator quality-low';
            } else if (sampleRate <= 44100) {
                sampleQuality.textContent = 'Medium';
                sampleQuality.className = 'quality-indicator quality-medium';
            } else {
                sampleQuality.textContent = 'High';
                sampleQuality.className = 'quality-indicator quality-high';
            }
            
            // Update bitrate quality indicator
            const bitrateQuality = document.getElementById('bitrateQuality');
            if (bitrate <= 96) {
                bitrateQuality.textContent = 'Low';
                bitrateQuality.className = 'quality-indicator quality-low';
            } else if (bitrate <= 192) {
                bitrateQuality.textContent = 'Medium';
                bitrateQuality.className = 'quality-indicator quality-medium';
            } else {
                bitrateQuality.textContent = 'High';
                bitrateQuality.className = 'quality-indicator quality-high';
            }
        }
        
        // Check setup and stream status on page load
        window.onload = function() {
            checkSetup();
            
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    updateStatus(data.streaming);
                    updateQualityIndicators();
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        };
        
        // Auto-refresh status every 5 seconds
        setInterval(function() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.streaming !== isStreaming) {
                        updateStatus(data.streaming);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }, 5000);
    </script>
</body>
</html>