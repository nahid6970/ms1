MergeAllExplorerWindows()

MergeAllExplorerWindows() {
    ; Get the target window to merge everything into
    mainWindow := WinActive("ahk_class CabinetWClass")
    if (!mainWindow)
        mainWindow := WinExist("ahk_class CabinetWClass")
    
    if (!mainWindow) {
        Run("explorer.exe")
        return
    }

    pathsToOpen := []
    sourceHwnds := Map()

    ; Collect all paths from all explorer tabs
    shellApp := ComObject("Shell.Application")
    
    for window in shellApp.Windows {
        try {
            if (window.Name != "Windows Explorer" && window.Name != "File Explorer")
                continue
                
            thisHwnd := 0
            try {
                thisHwnd := window.HWND
            } catch {
                continue
            }
            
            if (!thisHwnd || thisHwnd == 0)
                continue

            if (thisHwnd != mainWindow) {
                path := ""
                try {
                    path := window.Document.Folder.Self.Path
                } catch {
                    try {
                        path := window.LocationURL
                    } catch {
                        path := window.LocationName
                    }
                }
                
                if (path != "" && path != "This PC") {
                    pathsToOpen.Push(path)
                    sourceHwnds[thisHwnd] := true
                }
            }
        } catch {
            continue
        }
    }

    if (pathsToOpen.Length == 0 && sourceHwnds.Count == 0) {
        return
    }

    ; Backup clipboard
    clipSaved := ClipboardAll()

    WinActivate("ahk_id " . mainWindow)
    if (!WinWaitActive("ahk_id " . mainWindow, , 2)) {
        A_Clipboard := clipSaved
        return
    }

    ; --- DELIBERATE AND STABLE NAVIGATION ---
    for p in pathsToOpen {
        cleanPath := p
        
        if InStr(cleanPath, "file:///") {
            cleanPath := StrReplace(cleanPath, "file:///", "")
            cleanPath := StrReplace(cleanPath, "/", "\")
            cleanPath := StrReplace(cleanPath, "%20", " ")
        }
        
        ; 1. Create a new tab and wait for animation to complete
        Send("^t")
        Sleep(800) ; Increased for stability
        
        ; 2. Focus address bar
        Send("^l")
        Sleep(400)
        
        ; 3. Clear existing text just in case
        Send("^a") ; Select all
        Sleep(100)
        Send("{BackSpace}")
        Sleep(200)
        
        ; 4. Update clipboard and PASTE
        A_Clipboard := cleanPath
        Sleep(200) ; Give OS time to register clipboard change
        Send("^v")
        Sleep(400) ; Crucial: Wait for the text to actually appear in the box
        
        ; 5. Navigation
        Send("{Enter}")
        Sleep(1000) ; Wait for navigation to commit before moving to the next tab
    }

    ; Restore original clipboard
    A_Clipboard := clipSaved

    ; Close other windows
    for hwnd, _ in sourceHwnds {
        try {
            if WinExist("ahk_id " . hwnd) {
                WinClose("ahk_id " . hwnd)
                if (WinExist("ahk_id " . hwnd)) {
                    Sleep(500)
                    WinKill("ahk_id " . hwnd)
                }
            }
        }
    }

    WinActivate("ahk_id " . mainWindow)
}