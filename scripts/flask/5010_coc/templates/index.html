<!DOCTYPE html>
<html>

<head>
  <title>Event Schedule</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="shortcut icon" href="https://wallpapers.com/images/hd/clash-of-clans-character-logo-jntfmwifvnxhgrwg-2.png"
    type="image/x-icon">
  <style>
    @import url("https://www.nerdfonts.com/assets/css/webfont.css");

    html,
    body {
      background-color: #c0c0c0;
      font-family: jetbrainsmono nfp, monospace;
      font-size: 2rem;
    }

    .countdown {
      font-size: 1.5rem !important;
      font-weight: bold;
      border-radius: 5px;
      background-color: #808080;
      color: #ffffff;
      display: inline-block;
      margin-left: 10px;
      margin-bottom: 0px;
      text-transform: lowercase;
    }
    
    .countdown-text {
      font-size: 1.5rem !important;
      font-weight: bold;
    }

    .countdown.expired {
      background-color: #ffffff;
      color: #ffffff;
    }

    .countdown.live {
      color: rgb(0, 0, 0);
      background-color: #bad6c1;
    }

    .event-card {
      min-width: 250px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: white;
      margin: 5px;
    }
  </style>
  <script>
    function updateCountdowns() {
      document.querySelectorAll('.countdown').forEach(el => {
        const time = new Date(el.dataset.time);
        const now = new Date();
        const diff = time - now;
        const eventId = el.dataset.eventId;
        const textSpan = el.querySelector('.countdown-text');
        const originalDurationSeconds = parseInt(el.dataset.originalDuration) || 0;
        
        if (diff <= 0) {
          if (textSpan) textSpan.innerText = "✔️";
          el.classList.add('expired');
          el.classList.remove('live');
          const progressBar = document.getElementById('progress' + eventId);
          if (progressBar) progressBar.style.width = '100%';
          return;
        }
        
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        
        let result = '';
        if (d > 0) result += `${d}d `;
        if (h > 0 || d > 0) result += `${h}h `;
        result += `${m}m`;
        if (d === 0 && h === 0) result += ` ${s}s`;
        
        if (textSpan) textSpan.innerText = result.trim();
        el.classList.add('live');
        el.classList.remove('expired');
        
        // Calculate progress based on original duration from server
        if (originalDurationSeconds > 0) {
          const remainingSeconds = diff / 1000;
          const elapsedSeconds = originalDurationSeconds - remainingSeconds;
          const progress = Math.min(Math.max((elapsedSeconds / originalDurationSeconds) * 100, 0), 100);
          
          const progressBar = document.getElementById('progress' + eventId);
          if (progressBar) {
            progressBar.style.width = progress + '%';
          }
        }
      });
    }
    setInterval(updateCountdowns, 1000);
    window.onload = function() {
      updateCountdowns();
      restoreSpeedSelections();
      
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('shown.bs.modal', function(e) {
          const input = modal.querySelector('input[type="text"]');
          if (input) {
            input.focus();
            input.select();
            
            // Auto-apply speed when input changes
            const eventId = input.id.replace('durationInput', '');
            const speedSelect = document.getElementById('speedMultiplier' + eventId);
            
            // Store original value when modal opens
            input.dataset.originalValue = input.value;
            
            input.addEventListener('blur', function() {
              // Only apply if value changed and speed is not 1X
              if (speedSelect && speedSelect.value !== '1' && input.value !== input.dataset.originalValue) {
                applySpeedMultiplier(eventId);
              }
            });
          }
        });
      });
    };

    function applySpeedMultiplier(eventId) {
      const input = document.getElementById('durationInput' + eventId);
      const speedSelect = document.getElementById('speedMultiplier' + eventId);
      const multiplier = parseFloat(speedSelect.value);
      const duration = input.value.trim();
      
      // Save the selected speed to localStorage
      localStorage.setItem('speed_' + eventId, multiplier);
      
      const dMatch = duration.match(/(\d+)\s*d/);
      const hMatch = duration.match(/(\d+)\s*h/);
      const mMatch = duration.match(/(\d+)\s*m/);
      
      let days = dMatch ? parseInt(dMatch[1]) : 0;
      let hours = hMatch ? parseInt(hMatch[1]) : 0;
      let minutes = mMatch ? parseInt(mMatch[1]) : 0;
      
      let totalMinutes = (days * 24 * 60) + (hours * 60) + minutes;
      let newTotalMinutes = Math.floor(totalMinutes / multiplier);
      
      let newDays = Math.floor(newTotalMinutes / (24 * 60));
      let newHours = Math.floor((newTotalMinutes % (24 * 60)) / 60);
      let newMinutes = newTotalMinutes % 60;
      
      let result = '';
      if (newDays > 0) result += `${newDays}d `;
      if (newHours > 0 || newDays > 0) result += `${newHours}h `;
      result += `${newMinutes}m`;
      
      input.value = result.trim();
    }
    
    function restoreSpeedSelections() {
      document.querySelectorAll('[id^="speedMultiplier"]').forEach(select => {
        const eventId = select.id.replace('speedMultiplier', '');
        const savedSpeed = localStorage.getItem('speed_' + eventId);
        if (savedSpeed) {
          select.value = savedSpeed;
        }
      });
    }

    function sendToGoogleTimer(e, eventName, eventTime) {
      e.stopPropagation();
      e.preventDefault();
      
      const time = new Date(eventTime);
      const now = new Date();
      const diff = time - now;
      
      if (diff <= 0) {
        alert('Timer has already expired!');
        return;
      }
      
      // Round up to nearest second to avoid losing time
      const totalSeconds = Math.ceil(diff / 1000);
      const days = Math.floor(totalSeconds / 86400);
      const hours = Math.floor((totalSeconds % 86400) / 3600);
      const minutes = Math.ceil((totalSeconds % 3600) / 60);
      
      // Use custom URL scheme to open Android app
      const url = `coctimer://set?days=${days}&hours=${hours}&minutes=${minutes}&name=${encodeURIComponent(eventName)}&speed=1`;
      
      window.location.href = url;
    }
  </script>
</head>

<body class="container-fluid mt-4">
  <div class="d-flex justify-content-center gap-2 mb-4">
    <a href="/add-event" class="btn btn-success">Add Event</a>
    <a href="/teams" class="btn btn-secondary">Manage Teams</a>
  </div>
  <div class="row justify-content-center">
    {% for event in upcoming_events %}
    <div class="col-12 mb-4">
      <div class="card w-100" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#editEventModal{{ event.id }}">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="d-flex flex-row align-items-center">
            <div><strong>{{ event.team1.name }}</strong></div>
          </div>
          <div class="d-flex flex-row gap-2 align-items-center">
            <span class="countdown" data-time="{{ event.event_time.isoformat() }}" data-event-id="{{ event.id }}" data-original-duration="{{ event.original_duration_seconds }}" style="border-radius: 5px; display: inline-block; position: relative; overflow: hidden; background-color: #9e9e9e;">
              <div class="countdown-progress" id="progress{{ event.id }}" style="position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, #bad6c1 0%, #71ff89 100%); width: 0%; transition: width 1s linear; z-index: 0;"></div>
              <span class="countdown-text" style="padding: 5px 10px; position: relative; z-index: 1; display: block;"></span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal{{ event.id }}" tabindex="-1"
  aria-labelledby="editEventModalLabel{{ event.id }}" aria-hidden="true">
  <div class="modal-dialog" style="max-width: 95vw; width: auto; min-width: 500px; margin-top: 2rem;">
    <div class="modal-content">
      <div class="modal-body text-center" style="padding: 1.5rem;">
        <form action="{{ url_for('edit_event', event_id=event.id) }}" method="POST" style="width: 100%;">
          <div class="mb-3 d-flex justify-content-center align-items-stretch gap-2" style="flex-wrap: nowrap;">
            <input style="font-size: 2rem; padding: 1rem; width: auto; min-width: 300px;" type="text" class="form-control text-center" id="durationInput{{ event.id }}" name="duration"
              value="{{ event.duration_str_for_modal }}" placeholder="0d 0h 0m" required>
            <select style="font-size: 1.5rem; padding: 1rem; width: 150px; flex-shrink: 0;" class="form-select" id="speedMultiplier{{ event.id }}" onchange="applySpeedMultiplier({{ event.id }})">
              <option value="1">1X</option>
              <option value="10">10X</option>
              <option value="24">24X</option>
            </select>
          </div>
          <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-success" onclick="sendToGoogleTimer(event, '{{ event.team1.name }}', '{{ event.event_time.isoformat() }}');" style="font-size: 1.5rem; padding: 0.75rem 2rem;">⏰</button>
            <button type="submit" class="btn btn-primary" style="font-size: 1.5rem; padding: 0.75rem 2rem;">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

    {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
