<!DOCTYPE html>
<html>

<head>
  <title>Home</title>
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/4021/4021539.png" type="image/x-icon">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../static/style.css">
</head>

<body>
  <div class="sidebar-container" id="sidebar-container">
    <div class="top-center-controls" id="sidebar-buttons-container">
      <!-- Sidebar buttons will be dynamically loaded here -->
    </div>
    <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle Sidebar">
      <i class="nf nf-fa-chevron_right"></i>
    </button>
  </div>

  <div class="flex-container2">

    <div class="toggle-container" style="margin-left: 25px;">
      <label class="switch">
        <input type="checkbox" id="edit-mode-toggle">
        <span class="slider round"></span>
      </label>
      <span style="color: white; margin-left: 10px;">Modify</span>
    </div>

    <!-- Updated styling for better edit mode control -->
    <style>
      .dragging {
        opacity: 0.5;
      }

      .reorder-buttons {
        display: none;
        flex-direction: column;
        gap: 2px;
        margin-left: 5px;
      }

      .edit-mode .reorder-buttons {
        display: none;
      }

      .reorder-btn {
        background: #333;
        color: white;
        background-color: rgb(255, 218, 54);
        border: none;
        padding: 2px 6px;
        cursor: pointer;
        font-size: 12px;
        border-radius: 3px;
      }

      .reorder-btn:hover {
        background: #555;
      }

      /* Group reorder buttons - only visible in edit mode */
      .group-reorder-buttons {
        display: none;
        gap: 5px;
        margin-left: 10px;
      }

      .edit-mode .group-reorder-buttons {
        display: flex;
      }

      .link-item {
        cursor: move;
      }

      /* Notification badge styles */
      .notification-button-container {
        position: relative;
        display: inline-block;
      }

      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #ff4444;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: bold;
        min-width: 18px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      .notification-badge.zero {
        display: none !important;
      }

      /* Copy notification styles */
      .copy-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-width: 300px;
        word-wrap: break-word;
      }

      .copy-notification.show {
        opacity: 1;
        transform: translateX(0);
      }

      .copy-notification.success {
        background-color: #4CAF50;
        border-left: 4px solid #45a049;
      }

      .copy-notification.error {
        background-color: #f44336;
        border-left: 4px solid #da190b;
      }

      .copy-notification.info {
        background-color: #2196F3;
        border-left: 4px solid #0b7dda;
      }

      /* Add animation for better visual feedback */
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }

        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Preview note button styles */
      .preview-note-button {
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
        height: fit-content;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .preview-note-button:hover {
        background: #1976D2;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .preview-note-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .preview-note-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
    </style>

    <div id="links-container"
      style="display: flex; width: 100%; flex-wrap: wrap; justify-content: left; flex-direction: row;">
    </div>

    <div id="edit-group-popup" class="popup-container hidden">
      <div class="Menu">
        <span class="close-button">&times;</span>
        <h3>Group Settings</h3>
        <form id="edit-group-form" style="display: flex; flex-direction: column; gap: 10px; width: 400px;">
          <input type="hidden" id="edit-group-original-name">
          <label for="edit-group-name">Group Name:</label>
          <input type="text" id="edit-group-name" placeholder="Enter group name (leave empty for 'Ungrouped')" required>
          <div style="display: flex; gap: 20px; align-items: center; margin: 10px 0;">
            <label style="font-weight: 500;">Display Style:</label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-group-display" id="edit-group-display-flex" value="flex" checked>
              Flex
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-group-display" id="edit-group-display-list" value="list-item">
              List Item
            </label>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="edit-group-collapsible">
              <input type="checkbox" id="edit-group-collapsible">
              Enable Collapsible Toggle (shows at top when enabled)
            </label>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="edit-group-horizontal-stack">
              <input type="checkbox" id="edit-group-horizontal-stack">
              Stack Horizontally
            </label>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="edit-group-password-protect">
              <input type="checkbox" id="edit-group-password-protect">
              Require Password to Extend
            </label>
          </div>
          <div id="collapsible-rename-section" style="display: none;">
            <h4 style="color: white; margin: 15px 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px;">Top
              Group Display Settings</h4>

            <label for="edit-group-top-name">Display Name (optional):</label>
            <input type="text" id="edit-group-top-name"
              placeholder="Custom name for top display (leave empty to use group name)">

            <h4 style="color: white; margin: 15px 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px;">Top
              Group Color Settings</h4>

            <div style="display: flex; gap: 10px;">
              <input type="text" id="edit-group-top-bg-color" placeholder="Background Color (e.g., #2d2d2d or blue)">
              <input type="text" id="edit-group-top-text-color" placeholder="Text Color (e.g., #ffffff or white)">
            </div>

            <div style="display: flex; gap: 10px;">
              <input type="text" id="edit-group-top-border-color" placeholder="Border Color (e.g., #444444 or gray)">
              <input type="text" id="edit-group-top-hover-color" placeholder="Hover Color (e.g., #3a3a3a or darkgray)">
            </div>
          </div>

          <h4 style="color: white; margin: 15px 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px;">Popup
            Content Styling</h4>

          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-group-popup-bg-color" placeholder="Popup Background Color (e.g., #31343a)">
            <input type="text" id="edit-group-popup-text-color" placeholder="Popup Text Color (e.g., #ffffff)">
          </div>

          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-group-popup-border-color" placeholder="Popup Border Color (e.g., #555555)">
            <input type="text" id="edit-group-popup-border-radius" placeholder="Popup Border Radius (e.g., 8px)">
          </div>

          <div id="horizontal-stack-styling-section" style="display: none;">
            <h4 style="color: white; margin: 15px 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px;">
              Horizontal Stack Group Colors</h4>

            <div style="display: flex; gap: 10px;">
              <input type="text" id="edit-group-horizontal-bg-color"
                placeholder="Horizontal Stack Background Color (e.g., #2d2d2d)">
              <input type="text" id="edit-group-horizontal-text-color"
                placeholder="Horizontal Stack Text Color (e.g., #ffffff)">
            </div>

            <div style="display: flex; gap: 10px;">
              <input type="text" id="edit-group-horizontal-border-color"
                placeholder="Horizontal Stack Border Color (e.g., #0056b3)">
              <input type="text" id="edit-group-horizontal-hover-color"
                placeholder="Horizontal Stack Hover Color (e.g., #3a3a3a)">
            </div>
          </div>

          <button type="submit">Save Group Settings</button>
        </form>
      </div>
    </div>

    <div id="add-link-popup" class="popup-container hidden">
      <div class="Menu">
        <span class="close-button">&times;</span>
        <h3>Add New Link</h3>
        <form id="add-link-form" style="display: flex; flex-direction: column; gap: 10px; width: 400px;">
          <input type="text" id="link-name" placeholder="Name">
          <input type="text" id="link-group" placeholder="Group (optional)">
          <input type="url" id="link-url" placeholder="URL">

          <div style="display: flex; gap: 20px; align-items: center; margin: 10px 0;">
            <label style="font-weight: 500;">Click Action:</label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="link-click-action" id="link-action-url" value="url" checked>
              Open URL
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="link-click-action" id="link-action-note" value="note">
              Open Note
            </label>
          </div>

          <div style="display: flex; gap: 20px; align-items: center; margin: 10px 0;">
            <label style="font-weight: 500;">Default Type:</label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="link-default-type" id="link-type-text" value="text" checked>
              Text
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="link-default-type" id="link-type-nerd-font" value="nerd-font">
              Nerd Font
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="link-default-type" id="link-type-img" value="img">
              Image
            </label>
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="link-text" placeholder="Text (primary option)">
            <input type="text" id="link-icon-class" placeholder="Icon Class (e.g., nf nf-cod-mail)">
            <input type="url" id="link-img-src" placeholder="Image URL (if no text/icon)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="link-color" placeholder="Color (e.g., #f46613 or red)">
            <input type="text" id="link-background-color" placeholder="Background Color">
          </div>
          <input type="text" id="link-font-size" placeholder="Font Size (e.g., 16px)">
          <div style="display: flex; gap: 10px;">
            <input type="text" id="link-li-bg-color" placeholder="List Item BG Color">
            <input type="text" id="link-li-hover-color" placeholder="List Item Hover Color">
          </div>
          <input type="text" id="link-border-radius" placeholder="Border Radius">
          <input type="text" id="link-title" placeholder="Title (for tooltip)">
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="link-note"
              placeholder="Note (optional) - Supports Markdown: **bold**, *italic*, `code`, # Header" rows="3"
              style="resize: vertical; font-family: inherit; flex: 1;"></textarea>
            <button type="button" id="preview-note-btn" class="preview-note-button" title="Preview Note as Markdown">
              <i class="nf nf-md-eye"></i>
            </button>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="link-hidden">
              <input type="checkbox" id="link-hidden">
              Hide this item
            </label>
          </div>
          <button type="submit">Add Link</button>
        </form>
      </div>
    </div>

    <div id="edit-link-popup" class="popup-container hidden">
      <div class="Menu">
        <span class="close-button">&times;</span>
        <h3>Edit Link</h3>
        <form id="edit-link-form" style="display: flex; flex-direction: column; gap: 10px; width: 400px;">
          <input type="hidden" id="edit-link-index">
          <input type="text" id="edit-link-name" placeholder="Name">
          <input type="text" id="edit-link-group" placeholder="Group (optional)">
          <input type="url" id="edit-link-url" placeholder="URL">

          <div style="display: flex; gap: 20px; align-items: center; margin: 10px 0;">
            <label style="font-weight: 500;">Click Action:</label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-link-click-action" id="edit-link-action-url" value="url" checked>
              Open URL
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-link-click-action" id="edit-link-action-note" value="note">
              Open Note
            </label>
          </div>

          <div style="display: flex; gap: 20px; align-items: center; margin: 10px 0;">
            <label style="font-weight: 500;">Default Type:</label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-link-default-type" id="edit-link-type-text" value="text" checked>
              Text
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-link-default-type" id="edit-link-type-nerd-font" value="nerd-font">
              Nerd Font
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" name="edit-link-default-type" id="edit-link-type-img" value="img">
              Image
            </label>
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-link-text" placeholder="Text (primary option)">
            <input type="text" id="edit-link-icon-class" placeholder="Icon Class (e.g., nf nf-cod-mail)">
            <input type="url" id="edit-link-img-src" placeholder="Image URL (if no text/icon)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-link-width" placeholder="Width (e.g., 50)">
            <input type="text" id="edit-link-height" placeholder="Height (e.g., 50)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-link-color" placeholder="Color (e.g., #f46613 or red)">
            <input type="text" id="edit-link-background-color" placeholder="Background Color">
          </div>
          <input type="text" id="edit-link-font-size" placeholder="Font Size (e.g., 16px)">
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-link-li-bg-color" placeholder="List Item BG Color">
            <input type="text" id="edit-link-li-hover-color" placeholder="List Item Hover Color">
          </div>
          <input type="text" id="edit-link-border-radius" placeholder="Border Radius">
          <input type="text" id="edit-link-title" placeholder="Title (for tooltip)">
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="edit-link-note"
              placeholder="Note (optional) - Supports Markdown: **bold**, *italic*, `code`, # Header" rows="3"
              style="resize: vertical; font-family: inherit; flex: 1;"></textarea>
            <button type="button" id="edit-preview-note-btn" class="preview-note-button"
              title="Preview Note as Markdown">
              <i class="nf nf-md-eye"></i>
            </button>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="edit-link-hidden">
              <input type="checkbox" id="edit-link-hidden">
              Hide this item
            </label>
          </div>
          <button type="submit">Save Changes</button>
        </form>
      </div>
    </div>

    <div id="group_type_box-popup" class="popup-container hidden">
      <div class="group_type_box expanded">
        <span class="close-button">&times;</span>
        <h3>Group Items</h3>
        <div class="popup-content-inner" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      </div>
    </div>

    <div id="add-sidebar-button-popup" class="popup-container hidden">
      <div class="Menu">
        <span class="close-button">&times;</span>
        <h3>Add Sidebar Button</h3>
        <form id="add-sidebar-button-form" style="display: flex; flex-direction: column; gap: 10px; width: 450px;">
          <input type="text" id="sidebar-button-name" placeholder="Button Name" required>
          <input type="url" id="sidebar-button-url" placeholder="URL" required>

          <label for="sidebar-button-display-type">Display Type:</label>
          <select id="sidebar-button-display-type">
            <option value="icon">Icon (Nerd Font)</option>
            <option value="image">Image</option>
          </select>

          <div id="icon-settings">
            <input type="text" id="sidebar-button-icon" placeholder="Icon Class (e.g., nf nf-fa-home)">
          </div>

          <div id="image-settings" style="display: none;">
            <input type="url" id="sidebar-button-img-src" placeholder="Image URL">
          </div>

          <h4 style="color: white; margin: 15px 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px;">Colors &
            Styling</h4>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="sidebar-button-text-color" placeholder="Text/Icon Color (e.g., #000000)">
            <input type="text" id="sidebar-button-bg-color" placeholder="Background Color (e.g., #ffffff)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="sidebar-button-hover-color" placeholder="Hover Color (e.g., #e0e0e0)">
            <input type="text" id="sidebar-button-border-color" placeholder="Border Color (e.g., #cccccc)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="sidebar-button-border-radius" placeholder="Border Radius (e.g., 4px, 50%)">
            <input type="text" id="sidebar-button-font-size" placeholder="Font Size (e.g., 16px, 1.2em)">
          </div>

          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="sidebar-button-notification">
              <input type="checkbox" id="sidebar-button-notification">
              Has Notification Badge
            </label>
          </div>
          <div id="notification-settings" style="display: none;">
            <input type="text" id="sidebar-button-notification-api" placeholder="Notification API endpoint">
            <input type="text" id="sidebar-button-mark-seen-api" placeholder="Mark as seen API endpoint">
          </div>
          <button type="submit">Add Button</button>
        </form>
      </div>
    </div>

    <div id="edit-sidebar-button-popup" class="popup-container hidden">
      <div class="Menu">
        <span class="close-button">&times;</span>
        <h3>Edit Sidebar Button</h3>
        <form id="edit-sidebar-button-form" style="display: flex; flex-direction: column; gap: 10px; width: 450px;">
          <input type="hidden" id="edit-sidebar-button-index">
          <input type="text" id="edit-sidebar-button-name" placeholder="Button Name" required>
          <input type="url" id="edit-sidebar-button-url" placeholder="URL" required>

          <label for="edit-sidebar-button-display-type">Display Type:</label>
          <select id="edit-sidebar-button-display-type">
            <option value="icon">Icon (Nerd Font)</option>
            <option value="image">Image</option>
          </select>

          <div id="edit-icon-settings">
            <input type="text" id="edit-sidebar-button-icon" placeholder="Icon Class (e.g., nf nf-fa-home)">
          </div>

          <div id="edit-image-settings" style="display: none;">
            <input type="url" id="edit-sidebar-button-img-src" placeholder="Image URL">
          </div>

          <h4 style="color: white; margin: 15px 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px;">Colors &
            Styling</h4>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-sidebar-button-text-color" placeholder="Text/Icon Color (e.g., #000000)">
            <input type="text" id="edit-sidebar-button-bg-color" placeholder="Background Color (e.g., #ffffff)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-sidebar-button-hover-color" placeholder="Hover Color (e.g., #e0e0e0)">
            <input type="text" id="edit-sidebar-button-border-color" placeholder="Border Color (e.g., #cccccc)">
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="edit-sidebar-button-border-radius" placeholder="Border Radius (e.g., 4px, 50%)">
            <input type="text" id="edit-sidebar-button-font-size" placeholder="Font Size (e.g., 16px, 1.2em)">
          </div>>

          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="edit-sidebar-button-notification">
              <input type="checkbox" id="edit-sidebar-button-notification">
              Has Notification Badge
            </label>
          </div>
          <div id="edit-notification-settings" style="display: none;">
            <input type="text" id="edit-sidebar-button-notification-api" placeholder="Notification API endpoint">
            <input type="text" id="edit-sidebar-button-mark-seen-api" placeholder="Mark as seen API endpoint">
          </div>
          <button type="submit">Save Changes</button>
        </form>
      </div>
    </div>




    <script src="../static/context-menu.js"></script>
    <script src="../static/links-handler.js"></script>
    <script src="../static/sidebar-handler.js"></script>
    <script src="../static/main.js"></script>

    <script>
      // Handle file:// URLs by intercepting clicks
      document.addEventListener('click', function (e) {
        const link = e.target.closest('a');
        if (link && link.href && link.href.startsWith('file:///')) {
          e.preventDefault();
          const filePath = link.href.replace('file:///', '');

          fetch(`/open-file?path=${encodeURIComponent(filePath)}`)
            .then(response => response.json())
            .then(data => {
              if (!data.success) {
                console.error('Failed to open file:', data.error);
                alert('Failed to open file: ' + data.error);
              }
            })
            .catch(error => {
              console.error('Error opening file:', error);
              alert('Error opening file: ' + error);
            });
        }
      });

      // Function to apply color preview to input fields
      function applyColorPreview(input) {
        const value = input.value.trim();
        if (value) {
          // Check if it's a valid color (hex, rgb, named color, etc.)
          const tempDiv = document.createElement('div');
          tempDiv.style.color = value;
          if (tempDiv.style.color || value.match(/^#[0-9A-Fa-f]{3,6}$/)) {
            input.style.backgroundColor = value;
            // Determine text color based on background brightness
            const brightness = getBrightness(value);
            input.style.color = brightness > 128 ? '#000000' : '#ffffff';
          } else {
            // Reset if invalid color
            input.style.backgroundColor = '';
            input.style.color = '';
          }
        } else {
          // Reset if empty
          input.style.backgroundColor = '';
          input.style.color = '';
        }
      }

      // Function to calculate brightness of a color
      function getBrightness(color) {
        let r, g, b;

        if (color.startsWith('#')) {
          // Hex color
          const hex = color.slice(1);
          if (hex.length === 3) {
            r = parseInt(hex[0] + hex[0], 16);
            g = parseInt(hex[1] + hex[1], 16);
            b = parseInt(hex[2] + hex[2], 16);
          } else {
            r = parseInt(hex.slice(0, 2), 16);
            g = parseInt(hex.slice(2, 4), 16);
            b = parseInt(hex.slice(4, 6), 16);
          }
        } else {
          // For other color formats, use a temporary element
          const tempDiv = document.createElement('div');
          tempDiv.style.color = color;
          document.body.appendChild(tempDiv);
          const computedColor = window.getComputedStyle(tempDiv).color;
          document.body.removeChild(tempDiv);

          const match = computedColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
          if (match) {
            r = parseInt(match[1]);
            g = parseInt(match[2]);
            b = parseInt(match[3]);
          } else {
            return 128; // Default to medium brightness
          }
        }

        // Calculate brightness using luminance formula
        return (r * 299 + g * 587 + b * 114) / 1000;
      }

      // Function to check if an input field is color-related
      function isColorField(input) {
        return input.type === 'text' && (
          input.placeholder.toLowerCase().includes('color') ||
          input.id.toLowerCase().includes('color') ||
          input.name && input.name.toLowerCase().includes('color')
        );
      }

      // Function to apply color preview to all color fields in a container
      function applyColorPreviewToContainer(container) {
        const inputs = container.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
          if (isColorField(input)) {
            applyColorPreview(input);

            // Add event listeners if not already added
            if (!input.hasAttribute('data-color-preview-enabled')) {
              input.setAttribute('data-color-preview-enabled', 'true');

              input.addEventListener('input', function () {
                applyColorPreview(this);
              });

              input.addEventListener('change', function () {
                applyColorPreview(this);
              });

              input.addEventListener('blur', function () {
                applyColorPreview(this);
              });
            }
          }
        });
      }

      // Apply color preview on page load
      document.addEventListener('DOMContentLoaded', function () {
        applyColorPreviewToContainer(document);

        // Use MutationObserver to detect when popups are opened and fields are populated
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            // Check for added nodes (popups opening)
            mutation.addedNodes.forEach(function (node) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                applyColorPreviewToContainer(node);
              }
            });

            // Check for attribute changes (value changes)
            if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
              const target = mutation.target;
              if (isColorField(target)) {
                applyColorPreview(target);
              }
            }
          });
        });

        // Start observing
        observer.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['value']
        });

        // Override the value setter to detect programmatic changes
        const originalValueSetter = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').set;
        Object.defineProperty(HTMLInputElement.prototype, 'value', {
          set: function (newValue) {
            originalValueSetter.call(this, newValue);
            // Apply color preview if this is a color field
            if (isColorField(this)) {
              setTimeout(() => applyColorPreview(this), 0);
            }
          },
          get: Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').get
        });

        // Also check periodically for dynamically populated fields as backup
        setInterval(function () {
          const colorInputs = document.querySelectorAll('input[type="text"]');
          colorInputs.forEach(input => {
            if (isColorField(input)) {
              const currentValue = input.value.trim();
              const hasPreview = input.style.backgroundColor;

              // If field has a value but no background color preview
              if (currentValue && !hasPreview) {
                applyColorPreview(input);
              } else if (!currentValue && hasPreview) {
                // Clear preview if field is empty
                input.style.backgroundColor = '';
                input.style.color = '';
              }
            }
          });
        }, 200);
      });

      // Global event listener for immediate updates
      document.addEventListener('input', function (e) {
        if (isColorField(e.target)) {
          applyColorPreview(e.target);
        }
      });

      // Listen for popup visibility changes
      const popupObserver = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target;
            if (target.classList.contains('popup-container') && !target.classList.contains('hidden')) {
              // Popup just opened, apply color previews after a short delay
              setTimeout(() => {
                applyColorPreviewToContainer(target);
              }, 100);
            }
          }
        });
      });

      // Observe all popup containers
      document.querySelectorAll('.popup-container').forEach(popup => {
        popupObserver.observe(popup, { attributes: true, attributeFilter: ['class'] });
      });

      // Also listen for focus events on color fields to ensure they get updated
      document.addEventListener('focus', function (e) {
        if (isColorField(e.target)) {
          setTimeout(() => applyColorPreview(e.target), 0);
        }
      }, true);

      // Handle note preview button clicks
      document.addEventListener('click', function (e) {
        if (e.target.id === 'preview-note-btn' || e.target.closest('#preview-note-btn')) {
          e.preventDefault();
          const noteContent = document.getElementById('link-note').value;
          previewNote(noteContent);
        } else if (e.target.id === 'edit-preview-note-btn' || e.target.closest('#edit-preview-note-btn')) {
          e.preventDefault();
          const noteContent = document.getElementById('edit-link-note').value;
          previewNote(noteContent);
        }
      });

      // Function to preview note in new window
      function previewNote(content) {
        if (!content || !content.trim()) {
          alert('No note content to preview');
          return;
        }

        const encodedContent = encodeURIComponent(content);
        const previewUrl = `/preview-note?content=${encodedContent}`;

        // Open in new window
        const previewWindow = window.open(
          previewUrl,
          'notePreview',
          'width=900,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
        );

        if (!previewWindow) {
          alert('Please allow popups to preview notes');
        }
      }
    </script>



  </div>
</body>

</html>