<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel-like Data Table</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for visual capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Cell Context Menu -->
    <div id="cellContextMenu" class="context-menu">
        <div class="context-menu-item" id="ctxBold" onclick="toggleCellBold()">
            <span class="checkmark">‚úì</span>
            <span>Bold</span>
        </div>
        <div class="context-menu-item" id="ctxItalic" onclick="toggleCellItalic()">
            <span class="checkmark">‚úì</span>
            <span>Italic</span>
        </div>
        <div class="context-menu-item" onclick="showUnifiedBorderOptions()">
            <span>üî≤</span>
            <span>Border Options</span>
        </div>
        <div class="context-menu-item" id="ctxCenter" onclick="toggleCellCenter()">
            <span class="checkmark">‚úì</span>
            <span>Center Align</span>
        </div>
        <div class="context-menu-item" id="ctxComplete" onclick="toggleCellComplete()">
            <span class="checkmark">‚úì</span>
            <span>Mark Complete</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="showUnifiedColorPicker()">
            <span>üé®</span>
            <span>Cell Colors</span>
        </div>
        <div class="context-menu-item" onclick="setCellFontSize()">
            <span>üìè</span>
            <span>Font Size</span>
        </div>
        <div class="context-menu-item" onclick="setCellRank()">
            <span>üèÜ</span>
            <span>Set Sort Rank</span>
        </div>
        <div class="context-menu-item" onclick="clearCellFormatting()">
            <span>üßπ</span>
            <span>Clear Formatting</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="ctxMerge" onclick="mergeCells()">
            <span>‚äû</span>
            <span>Merge Cells</span>
        </div>
        <div class="context-menu-item" id="ctxUnmerge" onclick="unmergeCell()">
            <span>‚äü</span>
            <span>Unmerge Cell</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="exportCellToPDF()">
            <span>üìÑ</span>
            <span>Export Cell to PDF</span>
        </div>
    </div>

    <div class="container">
        <div class="sheet-tabs">
            <button class="btn-menu" onclick="toggleSidebar()" title="Open Navigation">‚ò∞</button>
            <div class="current-sheet-info">
                <span id="currentSheetTitle" class="current-sheet-title">Sheet1</span>
                <span id="currentCategoryTitle" class="current-category-title">Uncategorized</span>
            </div>

            <div class="sheet-controls">
                <button onclick="openSettings()" class="btn-sheet-action" title="Settings">‚öôÔ∏è</button>
                <div id="rowCount" class="load-time-indicator" title="Total number of rows in current sheet"
                    style="display: none;">
                    <span>#Ô∏è‚É£</span>
                    <span id="rowCountValue">--</span>
                </div>
                <div id="loadTime" class="load-time-indicator" title="Page load time">
                    <span>‚è±Ô∏è</span>
                    <span id="loadTimeValue">--</span>
                </div>
            </div>
        </div>

        <!--Sidebar Navigation -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="sidebar">
            <div class="sidebar-toolbar">
                <button onclick="showAddCategoryModal()" class="btn-sidebar-action" title="Add Category">
                    <span>üìÅ+</span> Add Category
                </button>
            </div>
            <div id="sidebarTree" class="sidebar-tree">
                <!-- Tree content will be rendered here -->
            </div>
        </div>

        <!-- Tree Context Menu -->
        <div id="treeContextMenu" class="context-menu">
            <!-- Content will be dynamically populated -->
        </div>

        <!-- Sub-Sheet Navigation Bar -->
        <div class="subsheet-bar" id="subsheetBar">
            <div class="subsheet-tabs" id="subsheetTabs">
                <!-- Sub-sheets will be rendered here -->
            </div>
        </div>

        <div class="toolbar">
            <div class="button-group">
                <button onclick="addColumn()" class="btn-icon" title="Add Column">‚¨áÔ∏è</button>
                <button onclick="addRowWithPrompt()" class="btn-icon" title="Add Row (Alt+N for quick add)">‚û°Ô∏è</button>
                <button onclick="saveData()" class="btn-icon" title="Save Data">üíæ</button>
                <button onclick="loadData()" class="btn-icon" title="Refresh">üîÑ</button>

                <label class="btn-icon-toggle" title="Enable text wrapping - Press Enter for new lines">
                    <input type="checkbox" id="wrapToggle" onchange="toggleRowWrap()">
                    <span>‚Ü©Ô∏è</span>
                </label>

                <label class="btn-icon-toggle" title="Show or hide row numbers">
                    <input type="checkbox" id="rowToggle" onchange="toggleRowNumbers()" checked>
                    <span>#Ô∏è‚É£</span>
                </label>

                <label class="btn-icon-toggle" title="Enable or disable markdown preview">
                    <input type="checkbox" id="markdownToggle" onchange="toggleMarkdownPreview()" checked>
                    <span>üìù</span>
                </label>

                <button onclick="deleteEmptyRows()" class="btn-icon-toggle btn-delete-empty"
                    title="Delete all empty rows">
                    <span>#Ô∏è‚É£</span>
                </button>

                <button onclick="toggleAllCollapsibles()" class="btn-icon-toggle" id="toggleCollapsiblesBtn"
                    title="Show/hide all collapsible text">
                    <span>üëÅÔ∏è</span>
                </button>

                <button onclick="copySheetContent()" class="btn-icon" id="btnCopyContent"
                    title="Copy Current Sheet Content">
                    <span>üìã</span>
                </button>

                <div class="separator"></div>

                <button onclick="prevSingleRow()" class="btn-icon" id="btnPrevRow" title="Previous Row" disabled>
                    <span>‚¨ÖÔ∏è</span>
                </button>
                <button onclick="toggleSingleRowMode()" class="btn-icon-toggle" id="btnSingleRowMode"
                    title="Toggle Single Row View">
                    <span>üìñ</span>
                </button>
                <button onclick="nextSingleRow()" class="btn-icon" id="btnNextRow" title="Next Row" disabled>
                    <span>‚û°Ô∏è</span>
                </button>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchTable()"
                    title="Search in all cells">
                <button onclick="clearSearch()" class="btn-clear-search" title="Clear search">√ó</button>
            </div>

            <div class="font-size-control">
                <span class="font-size-label">Font:</span>
                <button onclick="adjustFontSize(-1)" class="btn-font-size" title="Decrease font size">‚àí</button>
                <span id="fontSizeDisplay" class="font-size-display">100%</span>
                <button onclick="adjustFontSize(1)" class="btn-font-size" title="Increase font size">+</button>
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead id="tableHead">
                    <tr id="headerRow"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Column Settings Modal -->
    <div id="columnModal" class="modal">
        <div class="modal-content column-modal">
            <div class="modal-header">
                <h2 id="columnModalTitle">Add Column</h2>
                <span class="close" onclick="closeColumnModal()">&times;</span>
            </div>
            <form id="columnForm">
                <input type="hidden" id="editingColumnIndex" value="-1">

                <div class="form-group">
                    <label for="columnName">Column Name</label>
                    <input type="text" id="columnName" class="form-input"
                        placeholder="Leave empty for auto (A, B, C...)" autofocus>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="columnType">Data Type</label>
                        <select id="columnType" class="form-input">
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="email">Email</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="columnWidth">Width (px)</label>
                        <input type="number" id="columnWidth" class="form-input" value="150" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="columnFont">Font</label>
                        <select id="columnFont" class="form-input">
                            <option value="">Default</option>
                            <option value="JetBrains Mono">JetBrains Mono</option>
                            <option value="Arial">Arial</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Agency FB">Agency FB</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="columnFontSize">Font Size (px)</label>
                        <input type="number" id="columnFontSize" class="form-input" value="18" min="8" max="72">
                    </div>
                </div>

                <div class="form-group">
                    <label for="columnColor">Background Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="columnColor" class="color-input" value="#ffffff">
                        <input type="text" id="columnColorText" class="form-input color-text" value="#FFFFFF" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label for="columnTextColor">Text Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="columnTextColor" class="color-input" value="#000000">
                        <input type="text" id="columnTextColorText" class="form-input color-text" value="#000000"
                            readonly>
                    </div>
                </div>

                <!-- Header Styling Section -->
                <div class="form-section-header">
                    <h3>Header Styling</h3>
                </div>

                <div class="form-group">
                    <label for="headerBgColor">Header Background Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="headerBgColor" class="color-input" value="#f8f9fa">
                        <input type="text" id="headerBgColorText" class="form-input color-text" value="#F8F9FA"
                            readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label for="headerTextColor">Header Text Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="headerTextColor" class="color-input" value="#333333">
                        <input type="text" id="headerTextColorText" class="form-input color-text" value="#333333"
                            readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label>Header Text Style</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="headerBold">
                            <span>Bold</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="headerItalic">
                            <span>Italic</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="headerCenter">
                            <span>Center Align</span>
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeColumnModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="columnSubmitBtn">Add Column</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Sheet Modal -->
    <div id="renameModal" class="modal">
        <div class="modal-content rename-modal">
            <div class="modal-header">
                <h2>Rename Sheet</h2>
                <span class="close" onclick="closeRenameModal()">&times;</span>
            </div>
            <form id="renameForm">
                <div class="form-group">
                    <label for="sheetName">Sheet Name</label>
                    <input type="text" id="sheetName" class="form-input" placeholder="Enter sheet name" required
                        autofocus>
                </div>
                <div class="form-group">
                    <label for="sheetNickname">Nickname (optional, for easier searching)</label>
                    <input type="text" id="sheetNickname" class="form-input"
                        placeholder="e.g., English name for Bangla sheet">
                    <small style="color: #666; font-size: 12px;">Nickname won't be displayed but can be used to search
                        with *</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRenameModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content rename-modal">
            <div class="modal-header">
                <h2>Add Category</h2>
                <span class="close" onclick="closeAddCategoryModal()">&times;</span>
            </div>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" class="form-input"
                        placeholder="e.g., Bengali, English, History" required autofocus>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Category Modal -->
    <div id="renameCategoryModal" class="modal">
        <div class="modal-content rename-modal">
            <div class="modal-header">
                <h2>Rename Category</h2>
                <span class="close" onclick="closeRenameCategoryModal()">&times;</span>
            </div>
            <form id="renameCategoryForm">
                <div class="form-group">
                    <label for="newCategoryName">New Category Name</label>
                    <input type="text" id="newCategoryName" class="form-input" placeholder="Enter new category name"
                        required autofocus>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRenameCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Move to Category Modal -->
    <div id="moveToCategoryModal" class="modal">
        <div class="modal-content rename-modal">
            <div class="modal-header">
                <h2>Move Sheet to Category</h2>
                <span class="close" onclick="closeMoveToCategoryModal()">&times;</span>
            </div>
            <form id="moveToCategoryForm">
                <div class="form-group">
                    <label for="targetCategory">Select Category</label>
                    <select id="targetCategory" class="form-input">
                        <option value="">Uncategorized</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMoveToCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <h3 class="settings-section-title">üé® Appearance</h3>

                    <div class="settings-item" style="padding: 12px 0;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <label for="gridLineColor" class="settings-label" style="margin: 0; min-width: 100px;">Grid
                                Line Color</label>
                            <input type="color" id="gridLineColor" value="#dddddd"
                                oninput="syncGridLineColor(this.value)"
                                style="width: 40px; height: 32px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 2px;">
                                <span style="color: #666; font-size: 13px;">#</span>
                                <input type="text" id="gridLineColorText" value="DDDDDD" maxlength="6"
                                    placeholder="DDDDDD" oninput="syncGridLineColor('#' + this.value)"
                                    style="width: 70px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; text-transform: uppercase;">
                            </div>
                            <button class="btn-reset" onclick="resetGridLineColor()"
                                style="padding: 6px 12px; font-size: 12px;">Reset</button>
                        </div>
                    </div>

                    <div class="settings-item" style="margin-top: 20px;">
                        <div class="settings-item-header">
                            <label for="vrindaFontToggle" class="settings-label">Use Vrinda Font for Bangla</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="vrindaFontToggle" onchange="toggleVrindaFont(this.checked)"
                                    checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="settings-description">Enable Vrinda font for better Bangla text rendering. Disable if
                            you prefer larger default fonts.</p>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">üé® Custom Color Syntax</h3>
                    <p class="settings-description" style="margin-bottom: 15px;">Add custom color highlight syntaxes.
                        Use any characters (e.g., ++, $$, %%, etc.) with custom colors.</p>

                    <div id="customColorSyntaxList" class="custom-syntax-list">
                        <!-- Custom syntaxes will be rendered here -->
                    </div>

                    <button class="btn btn-secondary btn-full-width" onclick="addCustomColorSyntax()"
                        style="margin-top: 10px;">
                        ‚ûï Add Custom Syntax
                    </button>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">üìö Help & Documentation</h3>
                    <button class="btn btn-primary btn-full-width" onclick="showMarkdownGuide()">
                        üìù View Markdown Guide
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Guide Modal -->
    <div id="markdownGuideModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Markdown Formatting Guide</h2>
                <span class="close" onclick="closeMarkdownGuide()">&times;</span>
            </div>
            <div style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Text Formatting</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">**bold text**</td>
                            <td style="padding: 8px;"><strong>bold text</strong></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">@@italic text@@</td>
                            <td style="padding: 8px;"><em>italic text</em></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">__underline__</td>
                            <td style="padding: 8px;"><u>underline</u></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">_R_red underline__
                            </td>
                            <td style="padding: 8px;"><u
                                    style="text-decoration-color: #ff0000; text-decoration-thickness: 2px;">red
                                    underline</u></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">~~strikethrough~~
                            </td>
                            <td style="padding: 8px;"><del>strikethrough</del></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">^superscript^</td>
                            <td style="padding: 8px;">text<sup>superscript</sup></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">~subscript~</td>
                            <td style="padding: 8px;">text<sub>subscript</sub></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                \(\sqrt{25}\)</td>
                            <td style="padding: 8px;"><span id="sqrtPreview"></span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                Select: a/b ‚Üí Click button</td>
                            <td style="padding: 8px;"><span id="fracPreview"></span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                Select: a*b/c ‚Üí Click button</td>
                            <td style="padding: 8px;"><span id="fracPreview2"></span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                Select: (a+b)/(c+d) ‚Üí Click button</td>
                            <td style="padding: 8px;"><span id="fracPreview3"></span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">##heading##</td>
                            <td style="padding: 8px;"><span style="font-size: 1.3em; font-weight: 600;">heading</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">#2#big text#/#</td>
                            <td style="padding: 8px;"><span style="font-size: 2em; font-weight: 600;">big text</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">..small text..</td>
                            <td style="padding: 8px;"><span style="font-size: 0.75em;">small text</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">_.wavy underline._
                            </td>
                            <td style="padding: 8px;"><span style="text-decoration: underline wavy;">wavy
                                    underline</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">#R#border box#/#</td>
                            <td style="padding: 8px;"><span
                                    style="border: 2px solid #ff0000; padding: 2px 6px; border-radius: 4px;">border
                                    box</span>
                            </td>
                        </tr>
                    </table>
                    <p
                        style="font-size: 12px; color: #666; margin-top: 10px; padding: 10px; background: #e7f3ff; border-left: 3px solid #007bff;">
                        <strong>üí° Smart Math Tip:</strong> Select text like <code>a/b</code>, <code>a*b/c</code>, or
                        <code>(a+b)/(c+d)</code>,
                        press <strong>F3</strong>, and click the fraction button to automatically convert to proper math
                        notation!
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Code & Highlights</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">`inline code`</td>
                            <td style="padding: 8px;"><code>inline code</code></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">==highlight==</td>
                            <td style="padding: 8px;"><span
                                    style="background: black; color: white; padding: 2px 4px; border-radius: 3px;">highlight</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">-----</td>
                            <td style="padding: 8px;">
                                <hr style="border: none; border-top: 2px solid #ccc; margin: 4px 0; width: 100%;">
                            </td>
                        </tr>
                    </table>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Use 5 or more dashes (-----) on a single line to create a horizontal separator.<br>
                        <strong>With colors:</strong> <code>-----R</code> (red bg), <code>-----R-W</code> (red bg +
                        white text),
                        <code>R-----G</code> (red line + green bg), <code>-----#f00-#fff</code> (hex colors)
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Lists</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">- item</td>
                            <td style="padding: 8px;">‚Ä¢ item</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">-- subitem</td>
                            <td style="padding: 8px; padding-left: 24px;">‚ó¶ subitem</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">--- sub-subitem</td>
                            <td style="padding: 8px; padding-left: 48px;">‚ñ™ sub-subitem</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa;">1. item</td>
                            <td style="padding: 8px;">1. item</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Links & Collapsible Text</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                {link:https://google.com}Google{/}</td>
                            <td style="padding: 8px;"><a href="https://google.com" target="_blank"
                                    style="color: #007bff; text-decoration: underline;">Google</a></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                https://google.com[Google]</td>
                            <td style="padding: 8px;"><a href="https://google.com" target="_blank"
                                    style="color: #007bff; text-decoration: underline;">Google</a></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                url[==Link Highlight==]</td>
                            <td style="padding: 8px;"><a href="#" target="_blank"
                                    style="color: #007bff; text-decoration: underline;"><mark>Link Highlight</mark></a>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                {% raw %}{{hidden text}}{% endraw %}</td>
                            <td style="padding: 8px;">
                                <span style="display: inline-flex; align-items: center; gap: 4px;">
                                    <button
                                        style="background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 2px 6px; font-size: 14px;">üëÅÔ∏è</button>
                                    <span style="color: #666;">(click eye to show/hide)</span>
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Word Connectors</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                [1]Subject some words [1]Verb</td>
                            <td style="padding: 8px;">Auto-colored bracket line (blue for [1])</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                [1-R]Word1 text [1-R]Word2</td>
                            <td style="padding: 8px;">Custom color: Red bracket line</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                [1]A [1]B [2-G]C [2-G]D</td>
                            <td style="padding: 8px;">Multiple: blue [1] and green [2-G]</td>
                        </tr>
                    </table>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        <strong>Syntax:</strong> <code>[number]Word</code> or <code>[number-COLOR]Word</code><br>
                        <strong>Colors:</strong> R=Red, G=Green, B=Blue, Y=Yellow, O=Orange, P=Purple, C=Cyan, W=White,
                        K=Black, GR=Gray
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Custom Colors</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                {fg:red}red text{/}</td>
                            <td style="padding: 8px;"><span
                                    style="color: red; padding: 2px 6px; border-radius: 4px; display: inline-block;">red
                                    text</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                {bg:yellow}highlighted{/}</td>
                            <td style="padding: 8px;"><span
                                    style="background-color: yellow; padding: 2px 6px; border-radius: 4px; display: inline-block;">highlighted</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                {fg:white;bg:blue}badge{/}</td>
                            <td style="padding: 8px;"><span
                                    style="color: white; background-color: blue; padding: 2px 6px; border-radius: 4px; display: inline-block;">badge</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                {fg:#28cb5d}hex color{/}</td>
                            <td style="padding: 8px;"><span
                                    style="color: #28cb5d; padding: 2px 6px; border-radius: 4px; display: inline-block;">hex
                                    color</span></td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Grid Tables</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                Table*3<br>A, B, C<br>1, 2, 3</td>
                            <td style="padding: 8px;">
                                <div style="display: grid; grid-template-columns: repeat(3, auto); gap: 4px;">
                                    <div style="border: 1px solid #ced4da; padding: 2px;">A</div>
                                    <div style="border: 1px solid #ced4da; padding: 2px;">B</div>
                                    <div style="border: 1px solid #ced4da; padding: 2px;">C</div>
                                    <div style="border: 1px solid #ced4da; padding: 2px;">1</div>
                                    <div style="border: 1px solid #ced4da; padding: 2px;">2</div>
                                    <div style="border: 1px solid #ced4da; padding: 2px;">3</div>
                                </div>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                Table*2_red_2px<br>Item, Price</td>
                            <td style="padding: 8px;">
                                <div style="display: grid; grid-template-columns: repeat(2, auto); gap: 4px;">
                                    <div style="border: 2px solid red; padding: 2px;">Item</div>
                                    <div style="border: 2px solid red; padding: 2px;">Price</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Syntax: <code>Table*Columns_Color_Width</code> (e.g., <code>Table*5_blue_2px</code>). Color and
                        Width are optional.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Pipe Tables</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                | Name | Age | City |<br>
                                |------|-----|------|<br>
                                | John | 25 | NYC |
                            </td>
                            <td style="padding: 8px;">
                                <div class="md-grid" style="--cols: 3;">
                                    <div class="md-cell md-header">Name</div>
                                    <div class="md-cell md-header">Age</div>
                                    <div class="md-cell md-header">City</div>
                                    <div class="md-cell">John</div>
                                    <div class="md-cell">25</div>
                                    <div class="md-cell">NYC</div>
                                </div>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 11px;">
                                | :R-A:Name | :G-A:Age |<br>
                                |-----------|----------|<br>
                                | John | 25 |
                            </td>
                            <td style="padding: 8px;">
                                <div class="md-grid" style="--cols: 2;">
                                    <div class="md-cell md-header" style="border-right-color: #ff0000 !important;">Name
                                    </div>
                                    <div class="md-cell md-header">Age</div>
                                    <div class="md-cell" style="border-right-color: #ff0000 !important;">John</div>
                                    <div class="md-cell" style="border-right-color: #00ff00 !important;">25</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Use pipes <code>|</code> to separate columns. Add <code>|---|---|</code> separator for headers.
                        Use <code>:R-A:</code> for colored column separators (R, G, B, Y, O, P, C, W, K, GR).
                        Press <strong>F3 ‚Üí üìä</strong> to auto-format tables.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Timeline/Flowchart</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                Timeline*Event Name<br>- Item 1<br>- Item 2</td>
                            <td style="padding: 8px;">
                                <div style="display: flex; gap: 12px; align-items: flex-start;">
                                    <div style="flex: 0 0 100px; font-weight: 600;">Event Name</div>
                                    <div style="width: 2px; background: #999; height: 40px;"></div>
                                    <div style="flex: 1;">‚Ä¢ Item 1<br>‚Ä¢ Item 2</div>
                                </div>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-family: monospace; background: #f8f9fa; font-size: 12px;">
                                TimelineC*Centered<br>- Item 1<br>- Item 2</td>
                            <td style="padding: 8px;">
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div style="flex: 0 0 100px; font-weight: 600;">Centered</div>
                                    <div style="width: 2px; background: #999; height: 40px;"></div>
                                    <div style="flex: 1;">‚Ä¢ Item 1<br>‚Ä¢ Item 2</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        <strong>Syntax:</strong> <code>Timeline*Name</code> (top) or <code>TimelineC*Name</code>
                        (center)<br>
                        <strong>Colors:</strong> <code>Timeline-R*Name</code> for red separator (R/G/B/Y/O/P/C/W/K/GR)
                    </p>
                </div>

                <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
                    <strong>üí° Tips:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>You can combine multiple formats</li>
                        <li>Colors support: named colors (red, blue), hex (#ff0000), rgb(255,0,0)</li>
                        <li>Use wrap mode for multi-line content</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- F1 Quick Navigation Popup -->
    <div id="f1Popup" class="f1-popup-overlay">
        <div class="f1-popup">
            <div class="f1-search-box">
                <button class="f1-search-mode-toggle" id="f1SearchModeToggle" onclick="toggleF1SearchMode()"
                    title="Toggle search mode">
                    <span id="f1SearchModeIcon">üîç</span>
                </button>
                <input type="text" id="f1SearchInput" placeholder="Search sheets..." onkeyup="filterF1Sheets()"
                    onkeydown="handleF1SearchKeydown(event)">
                <button class="f1-close" onclick="closeF1Popup()" title="Close (Esc)">&times;</button>
            </div>
            <div class="f1-content">
                <div class="f1-categories">
                    <div class="f1-category-title">
                        <span>Categories</span>
                        <div class="f1-category-actions">
                            <button class="f1-category-action-btn" onclick="showAddCategoryModal()"
                                title="Add new category">‚ûï</button>
                            <button class="f1-category-action-btn" onclick="moveCategoryUpInF1()"
                                title="Move selected category up">‚¨ÜÔ∏è</button>
                            <button class="f1-category-action-btn" onclick="moveCategoryDownInF1()"
                                title="Move selected category down">‚¨áÔ∏è</button>
                        </div>
                    </div>
                    <div id="f1CategoryList" class="f1-category-list"></div>
                </div>
                <div class="f1-sheets">
                    <div class="f1-sheets-title">
                        <span>Sheets</span>
                        <div class="f1-button-group">
                            <button class="f1-add-separator-btn" onclick="toggleF1SubSheets()" id="toggleSubSheetsBtn"
                                title="Show/Hide Sub-sheets" style="opacity: 1;">
                                üìÇ
                            </button>
                            <button class="f1-add-separator-btn" onclick="addF1Sheet()" title="Add new sheet">
                                ‚ûï Sheet
                            </button>
                            <button class="f1-add-separator-btn" onclick="addSeparatorAtCursor()"
                                title="Add separator (click then click between sheets)">
                                ‚ûï Separator
                            </button>
                        </div>
                    </div>
                    <div id="f1SheetList" class="f1-sheet-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- F1 Context Menus -->
    <div id="f1CategoryContextMenu" class="context-menu">
        <!-- Populated dynamically -->
    </div>
    <div id="f1SheetContextMenu" class="context-menu">
        <!-- Populated dynamically -->
    </div>

    <!-- F2 Recent Sheets Popup -->
    <div id="f2Popup" class="f1-popup-overlay">
        <div class="f1-popup" style="max-width: 400px;">
            <div class="f1-search-box" style="border-bottom: 1px solid #00ff9d;">
                <span
                    style="color: #00ff9d; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;">Recent
                    Sheets</span>
                <button class="f1-close" onclick="closeF2Popup()" title="Close (Esc)">&times;</button>
            </div>
            <div class="f1-search-box">
                <input type="text" id="f2SearchInput" placeholder="Filter recent sheets..." onkeyup="filterF2Sheets()"
                    style="flex: 1;">
            </div>
            <div class="f1-content" style="min-height: 300px;">
                <div id="f2SheetsList" class="f2-sheets-list"></div>
            </div>
        </div>
    </div>

    <!-- Quick Markdown Formatter (F3) -->
    <div id="quickFormatter" class="quick-formatter">
        <div class="quick-formatter-title">Quick Format <span style="font-size: 11px; color: #666;">(Right-click to
                select multiple)</span></div>
        <div id="selectionStats" class="selection-stats">0 lines ‚Ä¢ 0 words ‚Ä¢ 0 chars</div>
        <div class="quick-formatter-options">
            <button class="format-btn" onclick="applyQuickFormat('**', '**', event)"
                oncontextmenu="return toggleFormatSelection('**', '**', event)" title="Bold (Right-click to select)">
                <strong>B</strong>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('@@', '@@', event)"
                oncontextmenu="return toggleFormatSelection('@@', '@@', event)" title="Italic (Right-click to select)">
                <em>I</em>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('__', '__', event)"
                oncontextmenu="return toggleFormatSelection('__', '__', event)"
                title="Underline (Right-click to select)">
                <u>U</u>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('~~', '~~', event)"
                oncontextmenu="return toggleFormatSelection('~~', '~~', event)"
                title="Strikethrough (Right-click to select)">
                <del>S</del>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('##', '##', event)"
                oncontextmenu="return toggleFormatSelection('##', '##', event)" title="Heading (Right-click to select)">
                <span style="font-size: 1.2em; font-weight: 600;">H</span>
            </button>
            <button class="format-btn" onclick="applyVariableFontSize(event)" title="Variable Font Size - #2#text#/#">
                <span style="font-size: 1.5em; font-weight: 600;">H+</span>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('..', '..', event)"
                oncontextmenu="return toggleFormatSelection('..', '..', event)"
                title="Small Text (Right-click to select)">
                <span style="font-size: 0.75em;">S</span>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('_.', '._', event)"
                oncontextmenu="return toggleFormatSelection('_.', '._', event)"
                title="Wavy Underline (Right-click to select)">
                <span style="text-decoration: underline wavy;">W</span>
            </button>
            <button class="format-btn" onclick="applyBorderBox(event)" title="Border Box - #R#text#/#">
                <span style="border: 2px solid #ff0000; padding: 1px 4px; border-radius: 3px; font-size: 11px;">‚ñ°</span>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('`', '`', event)"
                oncontextmenu="return toggleFormatSelection('`', '`', event)" title="Code (Right-click to select)">
                <code>C</code>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('^', '^', event)"
                oncontextmenu="return toggleFormatSelection('^', '^', event)"
                title="Superscript (Right-click to select)">
                X<sup>2</sup>
            </button>
            <button class="format-btn" onclick="applyQuickFormat('~', '~', event)"
                oncontextmenu="return toggleFormatSelection('~', '~', event)" title="Subscript (Right-click to select)">
                X<sub>2</sub>
            </button>
            <button class="format-btn" onclick="applySqrtFormat(event)" title="Square Root - \(\sqrt{value}\)">
                ‚àö
            </button>
            <button class="format-btn" onclick="applyHatFormat(event)"
                title="Smart Math - Converts a/b, a*b/c, (a+b)/(c+d) to LaTeX">
                <span style="position: relative; display: inline-block;">
                    <span
                        style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 8px;">a</span>
                    <span style="font-size: 16px;">‚Äï</span>
                    <span
                        style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); font-size: 8px;">b</span>
                </span>
            </button>
            <button class="format-btn" onclick="applyLinkFormat(event)" title="Link">
                üîó
            </button>
            <button class="format-btn" onclick="searchGoogle(event)" title="Search in Google">
                üîç
            </button>
            <button class="format-btn" onclick="searchGoogleWithExtra(event)"
                oncontextmenu="return editSearchExtraText(event)" title="Search with Extra Text (Right-click to edit)">
                üîç+
            </button>
            <button class="format-btn" onclick="sortLines(event)" title="Sort Lines Alphabetically">
                üî§
            </button>
            <button class="format-btn" onclick="formatPipeTable(event)" title="Format Pipe Table - Align columns">
                üìä
            </button>
            <button class="format-btn" onclick="linesToComma(event)" title="Convert Lines to Comma-Separated">
                ‚û°Ô∏è
            </button>
            <button class="format-btn" onclick="commaToLines(event)" title="Convert Comma-Separated to Lines">
                ‚¨áÔ∏è
            </button>
            <button class="format-btn" onclick="selectAllMatchingFromFormatter(event)"
                title="Select All Matching - Edit all occurrences at once">
                üéØ
            </button>
            <button class="format-btn"
                onclick="applyQuickFormat('{% raw %}{{{% endraw %}', '{% raw %}}}{% endraw %}', event)"
                oncontextmenu="return toggleFormatSelection('{% raw %}{{{% endraw %}', '{% raw %}}}{% endraw %}', event)"
                title="Hide Text (Right-click to select)">
                üëÅÔ∏è
            </button>
            <button class="format-btn" onclick="applyQuickFormat('[[', ']]', event)"
                oncontextmenu="return toggleFormatSelection('[[', ']]', event)"
                title="Correct Answer - Green when revealed (Right-click to select)"
                style="background: #29e372; color: black; font-size: 11px; font-weight: 600;">
                ‚úì
            </button>
            <button class="format-btn" onclick="removeFormatting(event)" title="Remove All Formatting">
                üßπ
            </button>
        </div>

        <div class="quick-formatter-separator"></div>
        <div class="quick-formatter-title" style="font-size: 12px; margin-top: 8px;">Text Case</div>
        <div class="quick-formatter-options">
            <button class="format-btn" onclick="changeTextCase('upper', event)" title="UPPERCASE">
                ABC
            </button>
            <button class="format-btn" onclick="changeTextCase('lower', event)" title="lowercase">
                abc
            </button>
            <button class="format-btn" onclick="changeTextCase('proper', event)" title="Proper Case">
                Abc
            </button>
        </div>

        <div class="quick-formatter-separator"></div>
        <div class="quick-formatter-title" style="font-size: 12px; margin-top: 8px;">Quick Highlights</div>
        <div class="quick-formatter-options">
            <button class="format-btn" onclick="applyQuickFormat('==', '==', event)"
                oncontextmenu="return toggleFormatSelection('==', '==', event)"
                title="Black Highlight (Right-click to select)"
                style="background: black; color: white; font-size: 12px; font-weight: 600;">
                Black
            </button>
            <button class="format-btn" onclick="applyQuickFormat('!!', '!!', event)"
                oncontextmenu="return toggleFormatSelection('!!', '!!', event)"
                title="Red Highlight (Right-click to select)"
                style="background: #ff0000; color: white; font-size: 12px; font-weight: 600;">
                Red
            </button>
            <button class="format-btn" onclick="applyQuickFormat('??', '??', event)"
                oncontextmenu="return toggleFormatSelection('??', '??', event)"
                title="Blue Highlight (Right-click to select)"
                style="background: #0000ff; color: white; font-size: 12px; font-weight: 600;">
                Blue
            </button>
            <!-- Custom syntax buttons will be inserted here dynamically -->
            <button class="format-btn format-btn-color" onclick="showColorPicker(event)"
                oncontextmenu="return toggleColorSelection(event)" title="Custom Color (Right-click to select)"
                id="customColorPickerBtn">
                üé®
            </button>
        </div>
        <div id="colorPickerSection" class="color-picker-section" style="display: none;">
            <div class="color-swatches-container">
                <div class="color-swatches-header">
                    <span>Presets</span>
                    <button class="btn-add-swatch" onclick="addCurrentColorToSwatches()"
                        title="Save current colors">+</button>
                </div>
                <div id="colorSwatches" class="color-swatches"></div>
            </div>
            <div class="color-history-container">
                <div class="color-history-header">
                    <span>Most Used</span>
                </div>
                <div id="colorHistory" class="color-history"></div>
            </div>
            <div class="color-picker-row">
                <label>Text:</label>
                <input type="color" id="quickFgColor" value="#000000" onchange="applyColorFormat()">
            </div>
            <div class="color-picker-row">
                <label>Background:</label>
                <input type="color" id="quickBgColor" value="#ffff00" onchange="applyColorFormat()">
                <label
                    style="margin-left: 10px; display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="noBgCheckbox" style="cursor: pointer;" onchange="applyColorFormat()">
                    <span>Don't use BG</span>
                </label>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Render KaTeX examples in Markdown Guide when modal is opened
        document.addEventListener('DOMContentLoaded', function () {
            // Add event listener to render KaTeX when guide is shown
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    const modal = document.getElementById('markdownGuideModal');
                    if (modal && modal.style.display === 'block') {
                        // Render square root example
                        const sqrtPreview = document.getElementById('sqrtPreview');
                        if (sqrtPreview && window.katex) {
                            try {
                                katex.render('\\sqrt{25}', sqrtPreview, { throwOnError: false });
                            } catch (e) {
                                sqrtPreview.textContent = '‚àö25';
                            }
                        }

                        // Render fraction examples
                        const fracPreview = document.getElementById('fracPreview');
                        if (fracPreview && window.katex) {
                            try {
                                katex.render('\\frac{a}{b}', fracPreview, { throwOnError: false });
                            } catch (e) {
                                fracPreview.textContent = 'a/b';
                            }
                        }

                        const fracPreview2 = document.getElementById('fracPreview2');
                        if (fracPreview2 && window.katex) {
                            try {
                                katex.render('\\frac{a\\times b}{c}', fracPreview2, { throwOnError: false });
                            } catch (e) {
                                fracPreview2.textContent = 'a√ób/c';
                            }
                        }

                        const fracPreview3 = document.getElementById('fracPreview3');
                        if (fracPreview3 && window.katex) {
                            try {
                                katex.render('\\frac{(a+b)}{(c+d)}', fracPreview3, { throwOnError: false });
                            } catch (e) {
                                fracPreview3.textContent = '(a+b)/(c+d)';
                            }
                        }
                    }
                });
            });

            const modal = document.getElementById('markdownGuideModal');
            if (modal) {
                observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
        });
    </script>
</body>

</html>