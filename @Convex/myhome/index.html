<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyHome - Bookmark Manager</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div id="app">
    <div id="sidebar"></div>
    <div id="main-content">
      <div id="top-groups"></div>
      <div id="links-container"></div>
    </div>
    <button id="add-link-btn" class="floating-btn">+</button>
  </div>

  <div id="edit-popup" class="popup-overlay" style="display: none;">
    <div class="popup-content edit-form-popup">
      <button class="close-popup">&times;</button>
      <h2 id="popup-title">Add Link</h2>
      <form id="link-form">
        <div class="form-buttons">
          <button type="submit">Save</button>
        </div>
        <div class="form-fields">
          <h3>Basic</h3>
          <input type="text" id="link-name" placeholder="Name" required>
          <input type="text" id="link-url" placeholder="URL">
          <input type="text" id="link-group" placeholder="Group">
          <input type="text" id="link-icon" placeholder="Icon (nf nf-fa-home or SVG)">
          <label><input type="checkbox" id="link-hidden"> Hidden (edit mode only)</label>
          <label><input type="checkbox" id="link-password"> Password protect</label>
          
          <h3>Display Type</h3>
          <select id="link-display">
            <option value="flex">Flex Grid</option>
            <option value="list-item">List</option>
            <option value="collapsible">Collapsible (Top)</option>
          </select>
          
          <h3>Top Group Style (for collapsible)</h3>
          <input type="text" id="top-name" placeholder="Top Display Name">
          <input type="text" id="top-bg-color" placeholder="Top BG Color" class="color-input">
          <input type="text" id="top-text-color" placeholder="Top Text Color" class="color-input">
          <input type="text" id="top-font-size" placeholder="Top Font Size (18px)">
          <input type="text" id="top-font-family" placeholder="Top Font Family">
          
          <h3>Popup Style (for collapsible)</h3>
          <input type="text" id="popup-bg-color" placeholder="Popup BG Color" class="color-input">
          <input type="text" id="popup-text-color" placeholder="Popup Text Color" class="color-input">
          <input type="text" id="popup-border-color" placeholder="Popup Border Color" class="color-input">
          
          <h3>Item Style</h3>
          <input type="text" id="li-bg-color" placeholder="Item BG Color" class="color-input">
          <input type="text" id="li-hover-color" placeholder="Item Hover Color" class="color-input">
          <input type="text" id="li-border-color" placeholder="Item Border Color" class="color-input">
          <input type="text" id="li-width" placeholder="Item Width (200px)">
          <input type="text" id="li-height" placeholder="Item Height (100px)">
          <input type="text" id="li-font-size" placeholder="Item Font Size (16px)">
          <input type="text" id="li-font-family" placeholder="Item Font Family">
        </div>
      </form>
    </div>
  </div>

  <div id="context-menu" class="context-menu" style="display: none;"></div>

  <script type="module">
    import { ConvexHttpClient } from "https://esm.sh/convex@1.16.0/browser";
    
    // Replace with your Convex URL after running: npx convex dev
    const CONVEX_URL = "https://agreeable-kangaroo-285.convex.cloud";
    const client = new ConvexHttpClient(CONVEX_URL);
    
    window.convexClient = client;
    let editMode = false;
    let allLinks = [];
    let draggedElement = null;
    let draggedIndex = null;
    let passwordCache = {};
    
    async function loadLinks() {
      try {
        allLinks = await client.query("links:getLinks");
        renderLinks(allLinks);
      } catch (error) {
        console.error("Error loading links:", error);
      }
    }
    
    async function loadSidebar() {
      try {
        const buttons = await client.query("sidebar:getButtons");
        renderSidebar(buttons);
      } catch (error) {
        console.error("Error loading sidebar:", error);
      }
    }
    
    window.addLink = async function(linkData) {
      try {
        await client.mutation("links:addLink", { link: linkData });
        await loadLinks();
      } catch (error) {
        console.error("Error adding link:", error);
      }
    };
    
    window.updateLink = async function(id, linkData) {
      try {
        await client.mutation("links:updateLink", { id, link: linkData });
        await loadLinks();
      } catch (error) {
        console.error("Error updating link:", error);
      }
    };
    
    window.deleteLink = async function(id) {
      try {
        await client.mutation("links:deleteLink", { id });
        await loadLinks();
      } catch (error) {
        console.error("Error deleting link:", error);
      }
    };
    
    window.reorderLinks = async function(linksArray) {
      try {
        await client.mutation("links:reorderLinks", { links: linksArray });
      } catch (error) {
        console.error("Error reordering links:", error);
      }
    };
    
    function renderLinks(links) {
      const container = document.getElementById('links-container');
      const topGroups = document.getElementById('top-groups');
      container.innerHTML = '';
      topGroups.innerHTML = '';
      
      const visibleLinks = editMode ? links : links.filter(l => !l.hidden);
      
      const groupedLinks = {};
      visibleLinks.forEach((link, idx) => {
        const group = link.group || 'Ungrouped';
        if (!groupedLinks[group]) groupedLinks[group] = [];
        groupedLinks[group].push({...link, originalIndex: idx});
      });
      
      Object.entries(groupedLinks).forEach(([groupName, groupLinks]) => {
        const firstLink = groupLinks[0];
        
        if (firstLink.collapsible) {
          renderTopGroup(groupName, groupLinks, topGroups);
        } else if (firstLink.display_style === 'flex') {
          renderFlexGroup(groupName, groupLinks, container);
        } else {
          renderListGroup(groupName, groupLinks, container);
        }
      });
    }
    
    function renderTopGroup(groupName, links, container) {
      const button = document.createElement('button');
      button.className = 'top-group-button';
      const firstLink = links[0];
      
      const displayName = firstLink.top_name || groupName;
      if (displayName.startsWith('<svg')) {
        button.innerHTML = displayName;
      } else if (displayName.startsWith('nf ')) {
        button.innerHTML = `<i class="${displayName}"></i>`;
      } else {
        button.textContent = displayName;
      }
      
      applyGradient(button, firstLink.top_bg_color, 'background');
      if (firstLink.top_text_color) button.style.color = firstLink.top_text_color;
      if (firstLink.top_font_size) button.style.fontSize = firstLink.top_font_size;
      if (firstLink.top_font_family) button.style.setProperty('font-family', firstLink.top_font_family, 'important');
      
      button.onclick = () => {
        if (firstLink.password_protect && !passwordCache[groupName]) {
          const pwd = prompt('Enter password:');
          if (pwd !== '182358') {
            alert('Wrong password!');
            return;
          }
          passwordCache[groupName] = pwd;
        }
        showPopup(groupName, links, firstLink);
      };
      
      if (editMode) {
        button.oncontextmenu = (e) => {
          e.preventDefault();
          showContextMenu(e, links[0], links[0].originalIndex);
        };
      } else {
        button.oncontextmenu = (e) => {
          e.preventDefault();
          showContextMenu(e, links[0], links[0].originalIndex);
        };
      }
      
      container.appendChild(button);
    }
    
    function renderFlexGroup(groupName, links, container) {
      const section = document.createElement('div');
      section.className = 'flex-group';
      section.innerHTML = `<h2>${groupName}</h2>`;
      
      const grid = document.createElement('div');
      grid.className = 'flex-grid';
      
      links.forEach(link => {
        const card = document.createElement('div');
        card.className = 'flex-card';
        card.draggable = editMode;
        card.dataset.linkIndex = link.originalIndex;
        
        const a = document.createElement('a');
        a.href = link.url || '#';
        if (link.url) a.target = '_blank';
        
        // Handle icon/name display
        if (link.icon_class) {
          if (link.icon_class.startsWith('<svg')) {
            a.innerHTML = link.icon_class + (link.name ? `<span>${link.name}</span>` : '');
          } else if (link.icon_class.startsWith('nf ')) {
            a.innerHTML = `<i class="${link.icon_class}"></i><span>${link.name}</span>`;
          } else {
            a.textContent = link.name;
          }
        } else {
          a.textContent = link.name;
        }
        
        // Apply styles to anchor, not card
        if (link.li_font_size) a.style.fontSize = link.li_font_size;
        if (link.li_font_family) a.style.setProperty('font-family', link.li_font_family, 'important');
        
        card.appendChild(a);
        
        // Apply card styles
        applyGradient(card, link.li_bg_color, 'background');
        if (link.li_border_color) {
          card.style.border = `2px solid ${link.li_border_color}`;
        }
        if (link.li_border_radius) card.style.borderRadius = link.li_border_radius;
        if (link.li_width) card.style.width = link.li_width;
        if (link.li_height) card.style.height = link.li_height;
        
        // Hover effect
        if (link.li_hover_color) {
          const originalBg = card.style.backgroundColor || link.li_bg_color;
          card.addEventListener('mouseenter', () => {
            card.style.backgroundColor = link.li_hover_color;
          });
          card.addEventListener('mouseleave', () => {
            if (originalBg) card.style.backgroundColor = originalBg;
          });
        }
        
        if (editMode) {
          card.ondragstart = handleDragStart;
          card.ondragover = handleDragOver;
          card.ondrop = handleDrop;
          card.ondragend = handleDragEnd;
          
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-btn';
          editBtn.textContent = '✏️';
          editBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            openEditPopup(link);
          };
          card.appendChild(editBtn);
        }
        
        card.oncontextmenu = (e) => {
          e.preventDefault();
          showContextMenu(e, link, link.originalIndex);
        };
        
        grid.appendChild(card);
      });
      
      section.appendChild(grid);
      container.appendChild(section);
    }
    
    function renderListGroup(groupName, links, container) {
      const section = document.createElement('div');
      section.className = 'list-group';
      
      const header = document.createElement('h2');
      header.textContent = groupName;
      header.style.cursor = 'pointer';
      header.style.userSelect = 'none';
      
      const firstLink = links[0];
      if (firstLink.top_bg_color) header.style.backgroundColor = firstLink.top_bg_color;
      if (firstLink.top_text_color) header.style.color = firstLink.top_text_color;
      
      header.onclick = () => {
        showListPopup(groupName, links, firstLink);
      };
      
      section.appendChild(header);
      container.appendChild(section);
    }
    
    function showListPopup(groupName, links, styleLink) {
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      
      const content = document.createElement('div');
      content.className = 'popup-content list-popup';
      
      if (styleLink.popup_bg_color) content.style.backgroundColor = styleLink.popup_bg_color;
      if (styleLink.popup_text_color) content.style.color = styleLink.popup_text_color;
      if (styleLink.popup_border_color) content.style.borderColor = styleLink.popup_border_color;
      
      content.innerHTML = `
        <button class="close-popup">&times;</button>
        <h2>${groupName}</h2>
        <div class="popup-list"></div>
      `;
      
      const listContainer = content.querySelector('.popup-list');
      
      links.forEach(link => {
        const item = document.createElement('a');
        item.className = 'popup-list-item';
        item.href = link.url || '#';
        if (link.url) item.target = '_blank';
        
        if (link.icon_class) {
          if (link.icon_class.startsWith('<svg')) {
            item.innerHTML = link.icon_class + (link.name ? `<span>${link.name}</span>` : '');
          } else if (link.icon_class.startsWith('nf ')) {
            item.innerHTML = `<i class="${link.icon_class}"></i><span>${link.name}</span>`;
          } else {
            item.textContent = link.name;
          }
        } else {
          item.textContent = link.name;
        }
        
        if (link.horizontal_font_size) item.style.fontSize = link.horizontal_font_size;
        if (link.horizontal_font_family) item.style.setProperty('font-family', link.horizontal_font_family, 'important');
        if (link.horizontal_bg_color) item.style.backgroundColor = link.horizontal_bg_color;
        if (link.horizontal_border_color) item.style.borderColor = link.horizontal_border_color;
        
        if (link.horizontal_hover_color) {
          const originalBg = item.style.backgroundColor || link.horizontal_bg_color;
          item.addEventListener('mouseenter', () => {
            item.style.backgroundColor = link.horizontal_hover_color;
          });
          item.addEventListener('mouseleave', () => {
            if (originalBg) item.style.backgroundColor = originalBg;
          });
        }
        
        listContainer.appendChild(item);
      });
      
      popup.appendChild(content);
      content.querySelector('.close-popup').onclick = () => popup.remove();
      popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
      
      document.body.appendChild(popup);
    }
    
    function showPopup(groupName, links) {
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.innerHTML = `
        <div class="popup-content">
          <button class="close-popup">&times;</button>
          <h2>${groupName}</h2>
          <div class="popup-links"></div>
        </div>
      `;
      
      const linksContainer = popup.querySelector('.popup-links');
      links.forEach(link => {
        const item = document.createElement('a');
        item.href = link.url;
        item.textContent = link.name;
        item.className = 'popup-link';
        linksContainer.appendChild(item);
      });
      
      popup.querySelector('.close-popup').onclick = () => popup.remove();
      popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
      
      document.body.appendChild(popup);
    }
    
    function applyGradient(element, colorValue, type) {
      if (!colorValue) return;
      
      if (colorValue.startsWith('slide:') || colorValue.startsWith('rotate:')) {
        const parts = colorValue.split(':').map(s => s.trim());
        const mode = parts[0];
        const hasAngle = parts.length > 2 && parts[1].includes('deg');
        const angle = hasAngle ? parts[1] : '45deg';
        const colors = hasAngle ? parts.slice(2).join(',') : parts.slice(1).join(',');
        
        const gradient = `linear-gradient(${angle}, ${colors})`;
        if (type === 'background') {
          element.style.background = gradient;
          element.style.backgroundSize = '200% 200%';
          if (mode === 'slide') {
            element.style.animation = 'gradientSlide 3s ease infinite';
          } else {
            element.style.animation = 'gradientRotate 3s ease infinite';
          }
        }
      } else {
        if (type === 'background') {
          element.style.backgroundColor = colorValue;
        }
      }
    }
    
    function handleDragStart(e) {
      draggedElement = this;
      draggedIndex = parseInt(this.dataset.linkIndex);
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
    
    async function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (draggedElement !== this) {
        const targetIndex = parseInt(this.dataset.linkIndex);
        await reorderLink(draggedIndex, targetIndex);
      }
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      draggedElement = null;
      draggedIndex = null;
    }
    
    async function reorderLink(oldIndex, newIndex) {
      const links = [...allLinks];
      const [movedLink] = links.splice(oldIndex, 1);
      links.splice(newIndex, 0, movedLink);
      
      const reorderData = links.map((link, idx) => ({
        id: link._id,
        order: idx
      }));
      
      await window.reorderLinks(reorderData);
      await loadLinks();
    }
    
    function showContextMenu(e, link, index) {
      const menu = document.getElementById('context-menu');
      menu.innerHTML = '';
      menu.style.display = 'block';
      menu.style.left = e.pageX + 'px';
      menu.style.top = e.pageY + 'px';
      
      const items = [
        { label: 'Open in New Tab', action: () => window.open(link.url, '_blank') },
        { label: 'Edit', action: () => openEditPopup(link) },
        { label: 'Duplicate', action: () => duplicateLink(link) },
        { label: 'Delete', action: () => deleteLink(link._id) }
      ];
      
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item.label;
        btn.onclick = () => {
          item.action();
          menu.style.display = 'none';
        };
        menu.appendChild(btn);
      });
      
      document.addEventListener('click', () => menu.style.display = 'none', { once: true });
    }
    
    async function duplicateLink(link) {
      const duplicate = {
        name: link.name + ' (Copy)',
        url: link.url,
        group: link.group,
        icon_class: link.icon_class,
        hidden: link.hidden,
        password_protect: link.password_protect,
        display_style: link.display_style,
        collapsible: link.collapsible,
        top_name: link.top_name,
        top_bg_color: link.top_bg_color,
        top_text_color: link.top_text_color,
        top_font_size: link.top_font_size,
        top_font_family: link.top_font_family,
        popup_bg_color: link.popup_bg_color,
        popup_text_color: link.popup_text_color,
        popup_border_color: link.popup_border_color,
        li_bg_color: link.li_bg_color,
        li_hover_color: link.li_hover_color,
        li_border_color: link.li_border_color,
        li_border_radius: link.li_border_radius,
        li_width: link.li_width,
        li_height: link.li_height,
        li_font_size: link.li_font_size,
        li_font_family: link.li_font_family,
      };
      await window.addLink(duplicate);
      await loadLinks();
    }
    
    async function deleteLink(id) {
      if (!confirm('Delete this link?')) return;
      await window.deleteLink(id);
      await loadLinks();
    }
    
    function renderSidebar(buttons) {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = '';
      
      buttons.forEach(button => {
        const btn = document.createElement('a');
        btn.href = button.url;
        btn.className = 'sidebar-button';
        btn.textContent = button.name;
        
        if (button.bg_color) btn.style.backgroundColor = button.bg_color;
        if (button.text_color) btn.style.color = button.text_color;
        if (button.font_size) btn.style.fontSize = button.font_size;
        
        sidebar.appendChild(btn);
      });
    }
    
    loadLinks();
    loadSidebar();
    
    setInterval(loadLinks, 30000);
    
    // F1 toggle edit mode
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F1') {
        e.preventDefault();
        editMode = !editMode;
        document.body.classList.toggle('edit-mode', editMode);
        loadLinks();
      }
    });
    
    // Add link button
    let editingLinkId = null;
    
    document.getElementById('add-link-btn').onclick = () => {
      editingLinkId = null;
      document.getElementById('popup-title').textContent = 'Add Link';
      document.getElementById('link-form').reset();
      document.getElementById('edit-popup').style.display = 'flex';
    };
    
    function openEditPopup(link) {
      editingLinkId = link._id;
      document.getElementById('popup-title').textContent = 'Edit Link';
      document.getElementById('link-name').value = link.name || '';
      document.getElementById('link-url').value = link.url || '';
      document.getElementById('link-group').value = link.group || '';
      document.getElementById('link-icon').value = link.icon_class || '';
      document.getElementById('link-hidden').checked = link.hidden || false;
      document.getElementById('link-password').checked = link.password_protect || false;
      document.getElementById('link-display').value = link.display_style || 'flex';
      document.getElementById('top-name').value = link.top_name || '';
      document.getElementById('top-bg-color').value = link.top_bg_color || '';
      document.getElementById('top-text-color').value = link.top_text_color || '';
      document.getElementById('top-font-size').value = link.top_font_size || '';
      document.getElementById('top-font-family').value = link.top_font_family || '';
      document.getElementById('popup-bg-color').value = link.popup_bg_color || '';
      document.getElementById('popup-text-color').value = link.popup_text_color || '';
      document.getElementById('popup-border-color').value = link.popup_border_color || '';
      document.getElementById('li-bg-color').value = link.li_bg_color || '';
      document.getElementById('li-hover-color').value = link.li_hover_color || '';
      document.getElementById('li-border-color').value = link.li_border_color || '';
      document.getElementById('li-width').value = link.li_width || '';
      document.getElementById('li-height').value = link.li_height || '';
      document.getElementById('li-font-size').value = link.li_font_size || '';
      document.getElementById('li-font-family').value = link.li_font_family || '';
      
      applyColorPreviews();
      document.getElementById('edit-popup').style.display = 'flex';
    }
    
    document.querySelector('#edit-popup .close-popup').onclick = () => {
      document.getElementById('edit-popup').style.display = 'none';
    };
    
    document.getElementById('edit-popup').onclick = (e) => {
      if (e.target.id === 'edit-popup') {
        document.getElementById('edit-popup').style.display = 'none';
      }
    };
    
    // Color preview
    function applyColorPreviews() {
      document.querySelectorAll('.color-input').forEach(input => {
        input.addEventListener('input', updateColorPreview);
        updateColorPreview.call(input);
      });
    }
    
    function updateColorPreview() {
      const value = this.value.trim();
      if (value && value.match(/^#[0-9A-Fa-f]{3,6}$/)) {
        this.style.backgroundColor = value;
        const brightness = getBrightness(value);
        this.style.color = brightness > 128 ? '#000' : '#fff';
      } else {
        this.style.backgroundColor = '';
        this.style.color = '';
      }
    }
    
    function getBrightness(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return (r * 299 + g * 587 + b * 114) / 1000;
    }
    
    applyColorPreviews();
    
    document.getElementById('link-form').onsubmit = async (e) => {
      e.preventDefault();
      
      const linkData = {
        name: document.getElementById('link-name').value,
        url: document.getElementById('link-url').value,
        group: document.getElementById('link-group').value,
        icon_class: document.getElementById('link-icon').value || undefined,
        hidden: document.getElementById('link-hidden').checked,
        password_protect: document.getElementById('link-password').checked,
        display_style: document.getElementById('link-display').value,
        collapsible: document.getElementById('link-display').value === 'collapsible',
        top_name: document.getElementById('top-name').value || undefined,
        top_bg_color: document.getElementById('top-bg-color').value || undefined,
        top_text_color: document.getElementById('top-text-color').value || undefined,
        top_font_size: document.getElementById('top-font-size').value || undefined,
        top_font_family: document.getElementById('top-font-family').value || undefined,
        popup_bg_color: document.getElementById('popup-bg-color').value || undefined,
        popup_text_color: document.getElementById('popup-text-color').value || undefined,
        popup_border_color: document.getElementById('popup-border-color').value || undefined,
        li_bg_color: document.getElementById('li-bg-color').value || undefined,
        li_hover_color: document.getElementById('li-hover-color').value || undefined,
        li_border_color: document.getElementById('li-border-color').value || undefined,
        li_width: document.getElementById('li-width').value || undefined,
        li_height: document.getElementById('li-height').value || undefined,
        li_font_size: document.getElementById('li-font-size').value || undefined,
        li_font_family: document.getElementById('li-font-family').value || undefined,
      };
      
      if (editingLinkId) {
        await window.updateLink(editingLinkId, linkData);
      } else {
        await window.addLink(linkData);
      }
      
      document.getElementById('edit-popup').style.display = 'none';
      await loadLinks();
    };
  </script>
</body>
</html>
