{% extends "base.html" %}

{% block title %}Add New Item - Startup Manager{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-plus"></i> Add New Item</h1>
    <p>Add a new application or command to your startup collection</p>
</div>

<div class="controls">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to List
    </a>
</div>

<div class="status" id="status"></div>

<div class="section" style="max-width: 800px; margin: 0 auto;">
    <form id="add-form">
        <div class="form-group">
            <label class="form-label" for="name">
                <i class="fas fa-tag"></i> Name *
            </label>
            <input type="text" id="name" class="form-input" placeholder="Enter item name" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="type">
                <i class="fas fa-list"></i> Type
            </label>
            <select id="type" class="form-select">
                <option value="App">Application</option>
                <option value="Command">Command</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" for="executable_type">
                <i class="fas fa-cog"></i> Executable Type
            </label>
            <select id="executable_type" class="form-select" onchange="updatePathPlaceholder()">
                <option value="other">Other</option>
                <option value="pythonw">Python (pythonw)</option>
                <option value="pwsh">PowerShell</option>
                <option value="cmd">Command Prompt</option>
                <option value="powershell">Windows PowerShell</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" for="path">
                <i class="fas fa-folder"></i> Path *
            </label>
            <div class="form-row">
                <div class="form-group">
                    <input type="text" id="path" class="form-input" placeholder="Enter or browse for executable path" required>
                </div>
                <button type="button" onclick="browsePath()" class="btn btn-secondary">
                    <i class="fas fa-folder-open"></i> Browse
                </button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="command">
                <i class="fas fa-terminal"></i> Arguments/Command
            </label>
            <input type="text" id="command" class="form-input" placeholder="Enter command line arguments (optional)">
            <small style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px; display: block;">
                Additional arguments or parameters to pass to the executable
            </small>
        </div>

        <div class="form-group" style="margin-top: 32px;">
            <button type="submit" class="btn btn-primary" style="margin-right: 12px;">
                <i class="fas fa-save"></i> Save Item
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const commonPaths = {
    pythonw: "C:\\Users\\nahid\\scoop\\apps\\python312\\current\\pythonw.exe",
    pwsh: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
    cmd: "C:\\Windows\\System32\\cmd.exe",
    powershell: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
};

function updatePathPlaceholder() {
    const executableType = document.getElementById('executable_type').value;
    const pathInput = document.getElementById('path');
    
    if (commonPaths[executableType]) {
        pathInput.value = commonPaths[executableType];
        pathInput.placeholder = commonPaths[executableType];
    } else {
        pathInput.placeholder = "Enter or browse for executable path";
    }
}

function browsePath() {
    // Note: File browsing in web browsers requires a file input
    // This is a placeholder - in a real implementation, you might want to:
    // 1. Use a file input dialog
    // 2. Implement a server-side file browser
    // 3. Use a desktop app wrapper like Electron
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.exe,.bat,.cmd,.ps1,.py,.ahk';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            // In a real browser environment, we can only get the filename, not the full path
            // This is a security limitation
            document.getElementById('path').value = file.name;
            showStatus('Note: Please enter the full path manually due to browser security restrictions', 'error');
        }
    };
    
    input.click();
}

document.getElementById('add-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('name').value.trim(),
        type: document.getElementById('type').value,
        path: document.getElementById('path').value.trim(),
        command: document.getElementById('command').value.trim(),
        executable_type: document.getElementById('executable_type').value
    };
    
    // Validate required fields
    if (!formData.name || !formData.path) {
        showStatus('Name and Path are required fields', 'error');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    
    try {
        const result = await apiCall('/add', 'POST', formData);
        
        if (result.success) {
            showStatus('Item added successfully! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showStatus(`Failed to add item: ${result.error}`, 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        showStatus(`Error adding item: ${error.message}`, 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Initialize path placeholder
updatePathPlaceholder();
</script>
{% endblock %}