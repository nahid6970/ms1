{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-rocket"></i> Startup Manager</h1>
    <p>Manage your Windows startup applications and commands</p>
</div>

<div class="controls">
    <button onclick="openModal('add-modal')" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add New Item
    </button>
    <button onclick="refreshItems()" class="btn btn-secondary" id="refresh-btn">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <button onclick="copyRegistryPath()" class="btn btn-secondary">
        <i class="fas fa-copy"></i> Copy Registry Path
    </button>
</div>

<div class="status" id="status"></div>

<div class="sections">
    <div class="section">
        <h2 class="section-title">
            <i class="fas fa-terminal"></i> Commands ({{ commands|length }})
        </h2>
        <div id="commands-list">
            {% if commands %}
                {% for item in commands %}
                <div class="item" data-name="{{ item.name }}">
                    <div class="item-header">
                        <div class="item-name">
                            <button class="toggle-btn {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                    onclick="toggleStartup('{{ item.name }}', this)">
                                <i class="fas {{ 'fa-check-circle' if item.is_enabled else 'fa-circle' }}"></i>
                            </button>
                            <span class="item-title {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                  onclick="launchItem('{{ item.name }}')">
                                {{ item.name }}
                            </span>
                        </div>
                        <div class="item-actions">
                            <button onclick="openEditModal('{{ item.name }}')" class="btn btn-secondary btn-small">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteItem('{{ item.name }}')" class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div><strong>Type:</strong> {{ item.ExecutableType|title }}</div>
                        <div class="path">{{ item.paths[0] }}</div>
                        {% if item.Command %}
                        <div><strong>Args:</strong> {{ item.Command }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-terminal"></i>
                    <p>No commands configured</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">
            <i class="fas fa-desktop"></i> Applications ({{ apps|length }})
        </h2>
        <div id="apps-list">
            {% if apps %}
                {% for item in apps %}
                <div class="item" data-name="{{ item.name }}">
                    <div class="item-header">
                        <div class="item-name">
                            <button class="toggle-btn {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                    onclick="toggleStartup('{{ item.name }}', this)">
                                <i class="fas {{ 'fa-check-circle' if item.is_enabled else 'fa-circle' }}"></i>
                            </button>
                            <span class="item-title {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                  onclick="launchItem('{{ item.name }}')">
                                {{ item.name }}
                            </span>
                        </div>
                        <div class="item-actions">
                            <button onclick="openEditModal('{{ item.name }}')" class="btn btn-secondary btn-small">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteItem('{{ item.name }}')" class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div class="path">{{ item.paths[0] }}</div>
                        {% if item.Command %}
                        <div><strong>Args:</strong> {{ item.Command }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-desktop"></i>
                    <p>No applications configured</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="add-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-plus"></i> Add New Item
            </h2>
            <button class="modal-close" onclick="closeModal('add-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="add-form">
            <div class="form-group">
                <label class="form-label" for="add-name">
                    <i class="fas fa-tag"></i> Name *
                </label>
                <input type="text" id="add-name" class="form-input" placeholder="Enter item name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-type">
                    <i class="fas fa-list"></i> Type
                </label>
                <select id="add-type" class="form-select">
                    <option value="App">Application</option>
                    <option value="Command">Command</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-executable-type">
                    <i class="fas fa-cog"></i> Executable Type
                </label>
                <select id="add-executable-type" class="form-select" onchange="updateAddPathPlaceholder()">
                    <option value="other">Other</option>
                    <option value="pythonw">Python (pythonw)</option>
                    <option value="pwsh">PowerShell</option>
                    <option value="cmd">Command Prompt</option>
                    <option value="powershell">Windows PowerShell</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-path">
                    <i class="fas fa-folder"></i> Path *
                </label>
                <input type="text" id="add-path" class="form-input" placeholder="Enter executable path" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-command">
                    <i class="fas fa-terminal"></i> Arguments/Command
                </label>
                <input type="text" id="add-command" class="form-input" placeholder="Enter command line arguments (optional)">
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" onclick="saveNewItem()" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Item
            </button>
            <button type="button" onclick="closeModal('add-modal')" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-edit"></i> Edit Item
            </h2>
            <button class="modal-close" onclick="closeModal('edit-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="edit-form">
            <input type="hidden" id="edit-original-name">
            
            <div class="form-group">
                <label class="form-label" for="edit-name">
                    <i class="fas fa-tag"></i> Name *
                </label>
                <input type="text" id="edit-name" class="form-input" placeholder="Enter item name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-type">
                    <i class="fas fa-list"></i> Type
                </label>
                <select id="edit-type" class="form-select">
                    <option value="App">Application</option>
                    <option value="Command">Command</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-executable-type">
                    <i class="fas fa-cog"></i> Executable Type
                </label>
                <select id="edit-executable-type" class="form-select" onchange="updateEditPathPlaceholder()">
                    <option value="other">Other</option>
                    <option value="pythonw">Python (pythonw)</option>
                    <option value="pwsh">PowerShell</option>
                    <option value="cmd">Command Prompt</option>
                    <option value="powershell">Windows PowerShell</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-path">
                    <i class="fas fa-folder"></i> Path *
                </label>
                <input type="text" id="edit-path" class="form-input" placeholder="Enter executable path" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-command">
                    <i class="fas fa-terminal"></i> Arguments/Command
                </label>
                <input type="text" id="edit-command" class="form-input" placeholder="Enter command line arguments (optional)">
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" onclick="saveEditItem()" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Item
            </button>
            <button type="button" onclick="closeModal('edit-modal')" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function toggleStartup(itemName, button) {
    const item = button.closest('.item');
    const icon = button.querySelector('i');
    const title = item.querySelector('.item-title');
    
    // Show loading state
    item.classList.add('loading');
    icon.className = 'fas fa-spinner fa-spin';
    
    try {
        const result = await apiCall(`/api/toggle/${encodeURIComponent(itemName)}`, 'POST');
        
        if (result.success) {
            const isEnabled = result.action === 'enabled';
            
            // Update button state
            button.className = `toggle-btn ${isEnabled ? 'enabled' : 'disabled'}`;
            icon.className = `fas ${isEnabled ? 'fa-check-circle' : 'fa-circle'}`;
            
            // Update title state
            title.className = `item-title ${isEnabled ? 'enabled' : 'disabled'}`;
            
            showStatus(`${itemName} ${result.action}`, 'success');
        } else {
            showStatus(`Failed to toggle ${itemName}: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error toggling ${itemName}: ${error.message}`, 'error');
    } finally {
        item.classList.remove('loading');
    }
}

async function launchItem(itemName) {
    showStatus(`Launching ${itemName}...`, 'success');
    
    try {
        const result = await apiCall(`/api/launch/${encodeURIComponent(itemName)}`, 'POST');
        
        if (result.success) {
            showStatus(`${itemName} launched successfully`, 'success');
        } else {
            showStatus(`Failed to launch ${itemName}: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error launching ${itemName}: ${error.message}`, 'error');
    }
}

async function deleteItem(itemName) {
    if (!confirm(`Are you sure you want to delete '${itemName}'?`)) {
        return;
    }
    
    try {
        const result = await apiCall(`/api/delete/${encodeURIComponent(itemName)}`, 'DELETE');
        
        if (result.success) {
            // Remove item from DOM
            const item = document.querySelector(`[data-name="${itemName}"]`);
            if (item) {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '0';
                item.style.transform = 'translateX(-20px)';
                setTimeout(() => item.remove(), 300);
            }
            
            showStatus(`${itemName} deleted successfully`, 'success');
        } else {
            showStatus(`Failed to delete ${itemName}: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error deleting ${itemName}: ${error.message}`, 'error');
    }
}

async function refreshItems() {
    const refreshBtn = document.getElementById('refresh-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        // Simple page reload for now - could be made more sophisticated
        setTimeout(() => {
            window.location.reload();
        }, 500);
    } catch (error) {
        showStatus(`Error refreshing: ${error.message}`, 'error');
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

async function copyRegistryPath() {
    const registryPath = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run";
    
    try {
        const success = await copyToClipboard(registryPath);
        if (success) {
            showStatus('Registry path copied to clipboard', 'success');
        } else {
            showStatus('Failed to copy registry path', 'error');
        }
    } catch (error) {
        showStatus('Failed to copy registry path', 'error');
    }
}

// Modal functions
const commonPaths = {
    pythonw: "C:\\Users\\nahid\\scoop\\apps\\python312\\current\\pythonw.exe",
    pwsh: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
    cmd: "C:\\Windows\\System32\\cmd.exe",
    powershell: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
};

function updateAddPathPlaceholder() {
    const executableType = document.getElementById('add-executable-type').value;
    const pathInput = document.getElementById('add-path');
    
    if (commonPaths[executableType]) {
        pathInput.value = commonPaths[executableType];
        pathInput.placeholder = commonPaths[executableType];
    } else {
        pathInput.placeholder = "Enter executable path";
    }
}

function updateEditPathPlaceholder() {
    const executableType = document.getElementById('edit-executable-type').value;
    const pathInput = document.getElementById('edit-path');
    
    if (commonPaths[executableType] && !pathInput.value) {
        pathInput.value = commonPaths[executableType];
    }
}

async function saveNewItem() {
    const formData = {
        name: document.getElementById('add-name').value.trim(),
        type: document.getElementById('add-type').value,
        path: document.getElementById('add-path').value.trim(),
        command: document.getElementById('add-command').value.trim(),
        executable_type: document.getElementById('add-executable-type').value
    };
    
    // Validate required fields
    if (!formData.name || !formData.path) {
        showStatus('Name and Path are required fields', 'error');
        return;
    }
    
    // Show loading state
    const saveBtn = document.querySelector('#add-modal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
        const result = await apiCall('/add', 'POST', formData);
        
        if (result.success) {
            showStatus('Item added successfully!', 'success');
            closeModal('add-modal');
            // Clear form
            document.getElementById('add-form').reset();
            updateAddPathPlaceholder();
            // Refresh the page to show new item
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showStatus(`Failed to add item: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error adding item: ${error.message}`, 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

async function openEditModal(itemName) {
    try {
        // Get item data
        const items = await apiCall('/api/items');
        const item = items.find(i => i.name === itemName);
        
        if (!item) {
            showStatus('Item not found', 'error');
            return;
        }
        
        // Populate form
        document.getElementById('edit-original-name').value = item.name;
        document.getElementById('edit-name').value = item.name;
        document.getElementById('edit-type').value = item.type;
        document.getElementById('edit-executable-type').value = item.ExecutableType || 'other';
        document.getElementById('edit-path').value = item.paths[0];
        document.getElementById('edit-command').value = item.Command || '';
        
        // Open modal
        openModal('edit-modal');
    } catch (error) {
        showStatus(`Error loading item data: ${error.message}`, 'error');
    }
}

async function saveEditItem() {
    const originalName = document.getElementById('edit-original-name').value;
    const formData = {
        name: document.getElementById('edit-name').value.trim(),
        type: document.getElementById('edit-type').value,
        path: document.getElementById('edit-path').value.trim(),
        command: document.getElementById('edit-command').value.trim(),
        executable_type: document.getElementById('edit-executable-type').value
    };
    
    // Validate required fields
    if (!formData.name || !formData.path) {
        showStatus('Name and Path are required fields', 'error');
        return;
    }
    
    // Show loading state
    const saveBtn = document.querySelector('#edit-modal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    saveBtn.disabled = true;
    
    try {
        const result = await apiCall(`/edit/${encodeURIComponent(originalName)}`, 'POST', formData);
        
        if (result.success) {
            showStatus('Item updated successfully!', 'success');
            closeModal('edit-modal');
            // Refresh the page to show updated item
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showStatus(`Failed to update item: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error updating item: ${error.message}`, 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}
</script>
{% endblock %}