{% extends "base.html" %}

{% block content %}
<div class="controls">
    <button onclick="openModal('add-modal')" class="btn btn-primary" title="Add New Item">
        <i class="fas fa-plus"></i>
    </button>
    <button onclick="scanStartupFolders()" class="btn btn-secondary" id="scan-btn" title="Scan Startup Folders">
        <i class="fas fa-search"></i>
    </button>
    <button onclick="refreshItems()" class="btn btn-secondary" id="refresh-btn" title="Refresh">
        <i class="fas fa-sync-alt"></i>
    </button>
    <button onclick="copyRegistryPath()" class="btn btn-secondary" title="Copy Registry Path">
        <i class="fas fa-copy"></i>
    </button>
    <button onclick="deleteMatchingShortcuts()" class="btn btn-danger" id="delete-matching-btn" title="Delete Matching Files">
        <i class="fas fa-trash-alt"></i>
    </button>
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search items..." onkeyup="filterItems()">
        <i class="fas fa-search search-icon"></i>
    </div>
</div>

<div class="status" id="status"></div>

<!-- Tab Controls (shown on smaller screens) -->
<div class="tab-controls">
    <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('commands')" id="commands-tab">
            <i class="fas fa-terminal"></i>
            <span>Commands ({{ commands|length }})</span>
        </button>
        <button class="tab-button" onclick="switchTab('apps')" id="apps-tab">
            <i class="fas fa-desktop"></i>
            <span>Apps ({{ apps|length }})</span>
        </button>
    </div>
</div>

<div class="sections">
    <div class="section active" id="commands-section">
        <h2 class="section-title">
            <i class="fas fa-terminal"></i> Commands ({{ commands|length }})
        </h2>
        <div class="section-content">
            <div id="commands-list">
            {% if commands %}
                {% for item in commands %}
                <div class="item" data-name="{{ item.name }}">
                    <div class="item-header">
                        <div class="item-name">
                            <button class="toggle-btn {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                    onclick="toggleStartup('{{ item.name }}', this)">
                                <i class="fas {{ 'fa-check-circle' if item.is_enabled else 'fa-circle' }}"></i>
                            </button>
                            <span class="item-title {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                  onclick="launchItem('{{ item.name }}')">
                                {{ item.name }}
                            </span>
                        </div>
                        <div class="item-actions">
                            <button onclick="openEditModal('{{ item.name }}')" class="btn btn-secondary btn-small">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteItem('{{ item.name }}')" class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div><strong>Type:</strong> {{ item.ExecutableType|title }}</div>
                        <div><strong>Path:</strong> <span class="path">{{ item.paths[0] }}</span></div>
                        {% if item.Command %}
                        <div><strong>Args:</strong> {{ item.Command }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-terminal"></i>
                    <p>No commands configured</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <div class="section" id="apps-section">
        <h2 class="section-title">
            <i class="fas fa-desktop"></i> Applications ({{ apps|length }})
        </h2>
        <div class="section-content">
            <div id="apps-list">
            {% if apps %}
                {% for item in apps %}
                <div class="item" data-name="{{ item.name }}">
                    <div class="item-header">
                        <div class="item-name">
                            <button class="toggle-btn {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                    onclick="toggleStartup('{{ item.name }}', this)">
                                <i class="fas {{ 'fa-check-circle' if item.is_enabled else 'fa-circle' }}"></i>
                            </button>
                            <span class="item-title {{ 'enabled' if item.is_enabled else 'disabled' }}" 
                                  onclick="launchItem('{{ item.name }}')">
                                {{ item.name }}
                            </span>
                        </div>
                        <div class="item-actions">
                            <button onclick="openEditModal('{{ item.name }}')" class="btn btn-secondary btn-small">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteItem('{{ item.name }}')" class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div><strong>Path:</strong> <span class="path">{{ item.paths[0] }}</span></div>
                        {% if item.Command %}
                        <div><strong>Args:</strong> {{ item.Command }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-desktop"></i>
                    <p>No applications configured</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="add-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-plus"></i> Add New Item
            </h2>
            <button class="modal-close" onclick="closeModal('add-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="add-form">
            <div class="form-group">
                <label class="form-label" for="add-name">
                    <i class="fas fa-tag"></i> Name *
                </label>
                <input type="text" id="add-name" class="form-input" placeholder="Enter item name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-type">
                    <i class="fas fa-list"></i> Type
                </label>
                <select id="add-type" class="form-select">
                    <option value="App">Application</option>
                    <option value="Command">Command</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-executable-type">
                    <i class="fas fa-cog"></i> Executable Type
                </label>
                <select id="add-executable-type" class="form-select" onchange="updateAddPathPlaceholder()">
                    <option value="other">Other</option>
                    <option value="pythonw">Python (pythonw)</option>
                    <option value="pwsh">PowerShell</option>
                    <option value="cmd">Command Prompt</option>
                    <option value="powershell">Windows PowerShell</option>
                    <option value="ahk_v2">AutoHotkey v2</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-path">
                    <i class="fas fa-folder"></i> Path *
                </label>
                <input type="text" id="add-path" class="form-input" placeholder="Enter executable path" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-command">
                    <i class="fas fa-terminal"></i> Arguments/Command
                </label>
                <input type="text" id="add-command" class="form-input" placeholder="Enter command line arguments (optional)">
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" onclick="saveNewItem()" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Item
            </button>
            <button type="button" onclick="closeModal('add-modal')" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-edit"></i> Edit Item
            </h2>
            <button class="modal-close" onclick="closeModal('edit-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="edit-form">
            <input type="hidden" id="edit-original-name">
            
            <div class="form-group">
                <label class="form-label" for="edit-name">
                    <i class="fas fa-tag"></i> Name *
                </label>
                <input type="text" id="edit-name" class="form-input" placeholder="Enter item name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-type">
                    <i class="fas fa-list"></i> Type
                </label>
                <select id="edit-type" class="form-select">
                    <option value="App">Application</option>
                    <option value="Command">Command</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-executable-type">
                    <i class="fas fa-cog"></i> Executable Type
                </label>
                <select id="edit-executable-type" class="form-select" onchange="updateEditPathPlaceholder()">
                    <option value="other">Other</option>
                    <option value="pythonw">Python (pythonw)</option>
                    <option value="pwsh">PowerShell</option>
                    <option value="cmd">Command Prompt</option>
                    <option value="powershell">Windows PowerShell</option>
                    <option value="ahk_v2">AutoHotkey v2</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-path">
                    <i class="fas fa-folder"></i> Path *
                </label>
                <input type="text" id="edit-path" class="form-input" placeholder="Enter executable path" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-command">
                    <i class="fas fa-terminal"></i> Arguments/Command
                </label>
                <input type="text" id="edit-command" class="form-input" placeholder="Enter command line arguments (optional)">
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" onclick="saveEditItem()" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Item
            </button>
            <button type="button" onclick="closeModal('edit-modal')" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function toggleStartup(itemName, button) {
    const item = button.closest('.item');
    const icon = button.querySelector('i');
    const title = item.querySelector('.item-title');
    
    // Show loading state
    item.classList.add('loading');
    icon.className = 'fas fa-spinner fa-spin';
    
    try {
        const result = await apiCall(`/api/toggle/${encodeURIComponent(itemName)}`, 'POST');
        
        if (result.success) {
            const isEnabled = result.action === 'enabled';
            
            // Update button state
            button.className = `toggle-btn ${isEnabled ? 'enabled' : 'disabled'}`;
            icon.className = `fas ${isEnabled ? 'fa-check-circle' : 'fa-circle'}`;
            
            // Update title state
            title.className = `item-title ${isEnabled ? 'enabled' : 'disabled'}`;
            
            showStatus(`${itemName} ${result.action}`, 'success');
        } else {
            showStatus(`Failed to toggle ${itemName}: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error toggling ${itemName}: ${error.message}`, 'error');
    } finally {
        item.classList.remove('loading');
    }
}

async function launchItem(itemName) {
    showStatus(`Launching ${itemName}...`, 'success');
    
    try {
        const result = await apiCall(`/api/launch/${encodeURIComponent(itemName)}`, 'POST');
        
        if (result.success) {
            showStatus(`${itemName} launched successfully`, 'success');
        } else {
            showStatus(`Failed to launch ${itemName}: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error launching ${itemName}: ${error.message}`, 'error');
    }
}

async function deleteItem(itemName) {
    if (!confirm(`Are you sure you want to delete '${itemName}'?`)) {
        return;
    }
    
    try {
        const result = await apiCall(`/api/delete/${encodeURIComponent(itemName)}`, 'DELETE');
        
        if (result.success) {
            // Remove item from DOM
            const item = document.querySelector(`[data-name="${itemName}"]`);
            if (item) {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '0';
                item.style.transform = 'translateX(-20px)';
                setTimeout(() => item.remove(), 300);
            }
            
            showStatus(`${itemName} deleted successfully`, 'success');
        } else {
            showStatus(`Failed to delete ${itemName}: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error deleting ${itemName}: ${error.message}`, 'error');
    }
}

async function refreshItems() {
    const refreshBtn = document.getElementById('refresh-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        // Refresh items without page reload
        setTimeout(() => {
            refreshItems();
        }, 500);
    } catch (error) {
        showStatus(`Error refreshing: ${error.message}`, 'error');
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

async function copyRegistryPath() {
    const registryPath = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run";
    
    try {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(registryPath);
            showStatus('Registry path copied to clipboard', 'success');
            return;
        }
        
        // Fallback to older method
        const textArea = document.createElement('textarea');
        textArea.value = registryPath;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
            showStatus('Registry path copied to clipboard', 'success');
        } else {
            // Final fallback - show the path for manual copying
            showRegistryPathModal(registryPath);
        }
    } catch (error) {
        console.error('Copy failed:', error);
        // Show the path for manual copying
        showRegistryPathModal(registryPath);
    }
}

function showRegistryPathModal(registryPath) {
    // Create a temporary modal to show the registry path
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-copy"></i> Registry Path
                </h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="margin: 20px 0;">
                <p style="margin-bottom: 10px; color: var(--text-secondary);">Copy this registry path manually:</p>
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-family: monospace; word-break: break-all; border: 1px solid var(--border);">
                    ${registryPath}
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="selectRegistryText()" class="btn btn-primary">
                    <i class="fas fa-mouse-pointer"></i> Select Text
                </button>
                <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    showStatus('Please copy the registry path manually', 'error');
}

function selectRegistryText() {
    const textDiv = document.querySelector('.modal.show div[style*="font-family: monospace"]');
    if (textDiv) {
        const range = document.createRange();
        range.selectNodeContents(textDiv);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

// Modal functions
const commonPaths = {
    pythonw: "C:\\Users\\nahid\\scoop\\apps\\python312\\current\\pythonw.exe",
    pwsh: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
    cmd: "C:\\Windows\\System32\\cmd.exe",
    powershell: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
    ahk_v2: "C:\\Program Files\\AutoHotkey\\v2\\AutoHotkey.exe"
};

function updateAddPathPlaceholder() {
    const executableType = document.getElementById('add-executable-type').value;
    const pathInput = document.getElementById('add-path');
    
    if (commonPaths[executableType]) {
        pathInput.value = commonPaths[executableType];
        pathInput.placeholder = commonPaths[executableType];
    } else {
        pathInput.placeholder = "Enter executable path";
    }
}

function updateEditPathPlaceholder() {
    const executableType = document.getElementById('edit-executable-type').value;
    const pathInput = document.getElementById('edit-path');
    
    if (commonPaths[executableType] && !pathInput.value) {
        pathInput.value = commonPaths[executableType];
    }
}

async function saveNewItem() {
    const formData = {
        name: document.getElementById('add-name').value.trim(),
        type: document.getElementById('add-type').value,
        path: document.getElementById('add-path').value.trim(),
        command: document.getElementById('add-command').value.trim(),
        executable_type: document.getElementById('add-executable-type').value
    };
    
    // Validate required fields
    if (!formData.name || !formData.path) {
        showStatus('Name and Path are required fields', 'error');
        return;
    }
    
    // Show loading state
    const saveBtn = document.querySelector('#add-modal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
        const result = await apiCall('/add', 'POST', formData);
        
        if (result.success) {
            showStatus('Item added successfully!', 'success');
            closeModal('add-modal');
            // Clear form
            document.getElementById('add-form').reset();
            updateAddPathPlaceholder();
            // Refresh items without page reload
            setTimeout(() => refreshItems(), 1000);
        } else {
            showStatus(`Failed to add item: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error adding item: ${error.message}`, 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

async function openEditModal(itemName) {
    try {
        // Get item data
        const items = await apiCall('/api/items');
        const item = items.find(i => i.name === itemName);
        
        if (!item) {
            showStatus('Item not found', 'error');
            return;
        }
        
        // Populate form
        document.getElementById('edit-original-name').value = item.name;
        document.getElementById('edit-name').value = item.name;
        document.getElementById('edit-type').value = item.type;
        document.getElementById('edit-executable-type').value = item.ExecutableType || 'other';
        document.getElementById('edit-path').value = item.paths[0];
        document.getElementById('edit-command').value = item.Command || '';
        
        // Open modal
        openModal('edit-modal');
    } catch (error) {
        showStatus(`Error loading item data: ${error.message}`, 'error');
    }
}

async function saveEditItem() {
    const originalName = document.getElementById('edit-original-name').value;
    const formData = {
        name: document.getElementById('edit-name').value.trim(),
        type: document.getElementById('edit-type').value,
        path: document.getElementById('edit-path').value.trim(),
        command: document.getElementById('edit-command').value.trim(),
        executable_type: document.getElementById('edit-executable-type').value
    };
    
    // Validate required fields
    if (!formData.name || !formData.path) {
        showStatus('Name and Path are required fields', 'error');
        return;
    }
    
    // Show loading state
    const saveBtn = document.querySelector('#edit-modal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    saveBtn.disabled = true;
    
    try {
        const result = await apiCall(`/edit/${encodeURIComponent(originalName)}`, 'POST', formData);
        
        if (result.success) {
            showStatus('Item updated successfully!', 'success');
            closeModal('edit-modal');
            // Refresh items without page reload
            setTimeout(() => refreshItems(), 1000);
        } else {
            showStatus(`Failed to update item: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error updating item: ${error.message}`, 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// Tab switching functionality
function switchTab(tabName) {
    console.log('Switching to tab:', tabName); // Debug log
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    const activeTab = document.getElementById(tabName + '-tab');
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // Update sections - be very explicit about hiding/showing
    const allSections = document.querySelectorAll('.section');
    allSections.forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
        section.style.visibility = 'hidden';
        section.style.opacity = '0';
    });
    
    // Small delay to ensure hiding is complete
    setTimeout(() => {
        // Show only the selected section
        const activeSection = document.getElementById(tabName + '-section');
        if (activeSection) {
            activeSection.classList.add('active');
            activeSection.style.display = 'block';
            activeSection.style.visibility = 'visible';
            activeSection.style.opacity = '1';
        }
        console.log('Active section:', activeSection); // Debug log
    }, 10);
}

// Search functionality
function filterItems() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    const allItems = document.querySelectorAll('.item');
    let commandsVisible = 0;
    let appsVisible = 0;
    
    allItems.forEach(item => {
        const itemName = item.querySelector('.item-title').textContent.toLowerCase();
        const itemPath = item.querySelector('.path').textContent.toLowerCase();
        const itemArgs = item.querySelector('.item-details div:last-child')?.textContent.toLowerCase() || '';
        
        // Check if search term matches name, path, or arguments
        const matches = itemName.includes(searchTerm) || 
                       itemPath.includes(searchTerm) || 
                       itemArgs.includes(searchTerm);
        
        if (matches || searchTerm === '') {
            item.style.display = 'block';
            item.style.opacity = '1';
            
            // Count visible items for each section
            const section = item.closest('.section');
            if (section && section.id === 'commands-section') {
                commandsVisible++;
            } else if (section && section.id === 'apps-section') {
                appsVisible++;
            }
        } else {
            item.style.display = 'none';
            item.style.opacity = '0';
        }
    });
    
    // Update section titles with filtered counts
    updateSectionCounts(commandsVisible, appsVisible);
    
    // Show empty state if no results
    showEmptyStateIfNeeded(commandsVisible, appsVisible);
}

function updateSectionCounts(commandsVisible, appsVisible) {
    // Update section titles
    const commandsTitle = document.querySelector('#commands-section .section-title');
    const appsTitle = document.querySelector('#apps-section .section-title');
    
    if (commandsTitle) {
        commandsTitle.innerHTML = `<i class="fas fa-terminal"></i> Commands (${commandsVisible})`;
    }
    
    if (appsTitle) {
        appsTitle.innerHTML = `<i class="fas fa-desktop"></i> Applications (${appsVisible})`;
    }
    
    // Update tab buttons if they exist
    const commandsTab = document.getElementById('commands-tab');
    const appsTab = document.getElementById('apps-tab');
    
    if (commandsTab) {
        commandsTab.innerHTML = `<i class="fas fa-terminal"></i><span>Commands (${commandsVisible})</span>`;
    }
    
    if (appsTab) {
        appsTab.innerHTML = `<i class="fas fa-desktop"></i><span>Apps (${appsVisible})</span>`;
    }
}

function showEmptyStateIfNeeded(commandsVisible, appsVisible) {
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    
    if (searchTerm === '') {
        // Remove any search empty states
        document.querySelectorAll('.search-empty-state').forEach(el => el.remove());
        return;
    }
    
    // Handle commands section
    const commandsList = document.getElementById('commands-list');
    let commandsEmptyState = commandsList.querySelector('.search-empty-state');
    
    if (commandsVisible === 0) {
        if (!commandsEmptyState) {
            commandsEmptyState = document.createElement('div');
            commandsEmptyState.className = 'search-empty-state empty-state';
            commandsEmptyState.innerHTML = `
                <i class="fas fa-search"></i>
                <p>No commands match "${searchTerm}"</p>
            `;
            commandsList.appendChild(commandsEmptyState);
        }
    } else if (commandsEmptyState) {
        commandsEmptyState.remove();
    }
    
    // Handle apps section
    const appsList = document.getElementById('apps-list');
    let appsEmptyState = appsList.querySelector('.search-empty-state');
    
    if (appsVisible === 0) {
        if (!appsEmptyState) {
            appsEmptyState = document.createElement('div');
            appsEmptyState.className = 'search-empty-state empty-state';
            appsEmptyState.innerHTML = `
                <i class="fas fa-search"></i>
                <p>No applications match "${searchTerm}"</p>
            `;
            appsList.appendChild(appsEmptyState);
        }
    } else if (appsEmptyState) {
        appsEmptyState.remove();
    }
}

// Startup folder scanning functionality
async function scanStartupFolders() {
    const scanBtn = document.getElementById('scan-btn');
    const originalText = scanBtn.innerHTML;
    
    scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
    scanBtn.disabled = true;
    
    try {
        const result = await apiCall('/api/scan-startup-folders');
        
        if (result.success) {
            if (result.items.length > 0) {
                showScanResultsModal(result.items);
            } else {
                showStatus('No new startup items found in folders', 'success');
            }
        } else {
            showStatus('Failed to scan startup folders', 'error');
        }
    } catch (error) {
        showStatus(`Error scanning folders: ${error.message}`, 'error');
    } finally {
        scanBtn.innerHTML = originalText;
        scanBtn.disabled = false;
    }
}

function showScanResultsModal(items) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'scan-results-modal';
    
    const itemsHtml = items.map((item, index) => `
        <div class="scan-item" style="background: var(--bg-tertiary); border-radius: 6px; padding: 12px; margin-bottom: 8px; border: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" id="item-${index}" checked style="transform: scale(1.2);">
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: var(--text-primary);">
                        <i class="fas ${item.type === 'App' ? 'fa-desktop' : 'fa-terminal'}"></i>
                        ${item.name}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                        <strong>Type:</strong> ${item.type} (${item.extension}) | 
                        <strong>Folder:</strong> ${item.folder}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-family: monospace; margin-top: 4px; word-break: break-all;">
                        <strong>Target:</strong> ${item.path}
                        ${item.original_shortcut ? `<br><strong>Shortcut:</strong> ${item.original_shortcut}` : ''}
                        ${item.command ? `<br><strong>Args:</strong> ${item.command}` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-search"></i> Found Startup Items (${items.length})
                </h2>
                <button class="modal-close" onclick="closeModal('scan-results-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="margin: 20px 0; max-height: 400px; overflow-y: auto;">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">
                    Select the items you want to add to your startup manager:
                </p>
                <div style="margin-bottom: 16px;">
                    <button onclick="toggleAllScanItems(true)" class="btn btn-secondary btn-small" style="margin-right: 8px;">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button onclick="toggleAllScanItems(false)" class="btn btn-secondary btn-small">
                        <i class="fas fa-square"></i> Deselect All
                    </button>
                </div>
                ${itemsHtml}
            </div>
            
            <div class="modal-footer">
                <button onclick="addSelectedItems()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Selected Items
                </button>
                <button onclick="closeModal('scan-results-modal')" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function toggleAllScanItems(checked) {
    const checkboxes = document.querySelectorAll('#scan-results-modal input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = checked);
}

async function addSelectedItems() {
    const modal = document.getElementById('scan-results-modal');
    const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        showStatus('No items selected', 'error');
        return;
    }
    
    const addBtn = modal.querySelector('.btn-primary');
    const originalText = addBtn.innerHTML;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    addBtn.disabled = true;
    
    let successCount = 0;
    let errorCount = 0;
    
    // Get the original scan data
    const result = await apiCall('/api/scan-startup-folders');
    const items = result.items;
    
    for (let i = 0; i < checkboxes.length; i++) {
        const checkbox = checkboxes[i];
        const index = parseInt(checkbox.id.split('-')[1]);
        const item = items[index];
        
        const formData = {
            name: item.name,
            type: item.type,
            path: item.path,
            command: item.command || '',
            executable_type: item.executable_type || 'other'
        };
        
        try {
            const addResult = await apiCall('/add', 'POST', formData);
            if (addResult.success) {
                successCount++;
                
                // Delete the shortcut after successfully adding it
                if (item.original_shortcut) {
                    try {
                        const deleteResult = await apiCall('/api/delete-shortcut', 'POST', {
                            shortcut_path: item.original_shortcut
                        });
                        if (!deleteResult.success) {
                            console.warn(`Failed to delete shortcut ${item.original_shortcut}:`, deleteResult.error);
                        }
                    } catch (deleteError) {
                        console.warn(`Error deleting shortcut ${item.original_shortcut}:`, deleteError);
                    }
                }
            } else {
                errorCount++;
                console.error(`Failed to add ${item.name}:`, addResult.error);
            }
        } catch (error) {
            errorCount++;
            console.error(`Error adding ${item.name}:`, error);
        }
    }
    
    // Close modal and show results
    closeModal('scan-results-modal');
    
    if (successCount > 0) {
        showStatus(`Successfully added ${successCount} item(s) and deleted shortcuts${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success');
        // Refresh items without page reload
        setTimeout(() => refreshItems(), 1000);
    } else {
        showStatus(`Failed to add items (${errorCount} errors)`, 'error');
    }
}

async function deleteMatchingShortcuts() {
    if (!confirm('This will delete all shortcuts from startup folders that match items already in your startup list. Continue?')) {
        return;
    }
    
    const deleteBtn = document.getElementById('delete-matching-btn');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    deleteBtn.disabled = true;
    
    try {
        const result = await apiCall('/api/delete-matching-shortcuts', 'POST');
        
        if (result.success) {
            const deletedCount = result.deleted_count;
            const errorCount = result.error_count;
            
            if (deletedCount > 0) {
                let message = `Successfully deleted ${deletedCount} matching shortcut(s)`;
                if (errorCount > 0) {
                    message += ` (${errorCount} errors)`;
                }
                showStatus(message, 'success');
                
                // Show details of deleted shortcuts
                if (result.deleted_shortcuts.length > 0) {
                    console.log('Deleted shortcuts:', result.deleted_shortcuts);
                }
            } else if (errorCount > 0) {
                showStatus(`Failed to delete shortcuts (${errorCount} errors)`, 'error');
            } else {
                showStatus('No matching shortcuts found to delete', 'info');
            }
            
            if (result.errors.length > 0) {
                console.error('Deletion errors:', result.errors);
            }
        } else {
            showStatus(`Error: ${result.error}`, 'error');
        }
    } catch (error) {
        showStatus(`Error deleting shortcuts: ${error.message}`, 'error');
    } finally {
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
        // Remove dynamically created modals
        if (modalId === 'scan-results-modal') {
            setTimeout(() => modal.remove(), 300);
        }
    }
}
</script>
{% endblock %}