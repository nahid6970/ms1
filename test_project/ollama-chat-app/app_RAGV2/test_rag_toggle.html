<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Toggle Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>RAG Settings Test</h2>
        
        <div class="card">
            <div class="card-body">
                <h5>RAG Configuration</h5>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="rag-enabled" checked>
                        <label class="form-check-label" for="rag-enabled">
                            <strong>Enable RAG</strong>
                        </label>
                    </div>
                    <small class="text-muted">When enabled, the AI will search your knowledge base for relevant context.</small>
                </div>

                <div class="mb-3">
                    <label for="rag-max-results-slider" class="form-label">
                        Max Context Chunks: <span id="rag-max-results-value">3</span>
                    </label>
                    <input type="range" class="form-range" min="1" max="10" step="1" id="rag-max-results-slider" value="3">
                </div>

                <div class="mb-3">
                    <button class="btn btn-primary" onclick="testRAGSettings()">Test Settings</button>
                    <button class="btn btn-secondary" onclick="resetRAGSettings()">Reset</button>
                </div>

                <div id="status" class="alert alert-info">
                    Settings will be displayed here...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const DEFAULT_RAG_SETTINGS = {
            rag_enabled: true,
            rag_max_results: 3
        };

        function saveRAGSettings() {
            const ragEnabled = document.getElementById('rag-enabled');
            const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
            
            if (ragEnabled && ragMaxResultsSlider) {
                const settings = {
                    rag_enabled: ragEnabled.checked,
                    rag_max_results: parseInt(ragMaxResultsSlider.value, 10)
                };
                
                console.log('Saving RAG settings:', settings);
                localStorage.setItem('ollamaRAGSettings', JSON.stringify(settings));
                
                // Save to server
                saveRAGSettingsToServer(settings);
                
                // Update status
                updateStatus(settings);
            }
        }

        async function saveRAGSettingsToServer(ragSettings) {
            try {
                const currentSettings = {
                    instructions: [],
                    rag_enabled: ragSettings.rag_enabled,
                    rag_max_results: ragSettings.rag_max_results
                };

                const response = await fetch('/api/settings/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: currentSettings })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('RAG settings saved to server successfully');
                    document.getElementById('status').innerHTML = 
                        '<div class="alert alert-success">Settings saved to server successfully!</div>';
                } else {
                    console.error('Failed to save RAG settings to server:', data);
                    document.getElementById('status').innerHTML = 
                        '<div class="alert alert-warning">Settings saved locally but failed to sync with server</div>';
                }
            } catch (error) {
                console.error('RAG settings save error:', error);
                document.getElementById('status').innerHTML = 
                    '<div class="alert alert-danger">Error saving settings: ' + error.message + '</div>';
            }
        }

        function loadRAGSettings() {
            let ragSettings = null;
            try {
                const localRAGSettings = localStorage.getItem('ollamaRAGSettings');
                if (localRAGSettings) {
                    ragSettings = JSON.parse(localRAGSettings);
                }
            } catch (error) {
                console.log('Error loading RAG settings:', error);
            }

            const settingsToApply = ragSettings || DEFAULT_RAG_SETTINGS;

            const ragEnabled = document.getElementById('rag-enabled');
            const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
            const ragMaxResultsValue = document.getElementById('rag-max-results-value');

            if (ragEnabled) {
                ragEnabled.checked = settingsToApply.rag_enabled !== false;
            }
            if (ragMaxResultsSlider && ragMaxResultsValue) {
                ragMaxResultsSlider.value = settingsToApply.rag_max_results || 3;
                ragMaxResultsValue.textContent = settingsToApply.rag_max_results || 3;
            }

            updateStatus(settingsToApply);
        }

        function resetRAGSettings() {
            const ragEnabled = document.getElementById('rag-enabled');
            const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
            
            if (ragEnabled) ragEnabled.checked = DEFAULT_RAG_SETTINGS.rag_enabled;
            if (ragMaxResultsSlider) ragMaxResultsSlider.value = DEFAULT_RAG_SETTINGS.rag_max_results;
            
            saveRAGSettings();
        }

        function testRAGSettings() {
            const ragEnabled = document.getElementById('rag-enabled');
            const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
            
            const currentSettings = {
                rag_enabled: ragEnabled.checked,
                rag_max_results: parseInt(ragMaxResultsSlider.value, 10)
            };
            
            updateStatus(currentSettings);
        }

        function updateStatus(settings) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <strong>Current Settings:</strong><br>
                RAG Enabled: <span class="badge ${settings.rag_enabled ? 'bg-success' : 'bg-danger'}">${settings.rag_enabled ? 'ON' : 'OFF'}</span><br>
                Max Results: <span class="badge bg-info">${settings.rag_max_results}</span>
            `;
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const ragEnabled = document.getElementById('rag-enabled');
            const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
            const ragMaxResultsValue = document.getElementById('rag-max-results-value');

            if (ragEnabled) {
                ragEnabled.addEventListener('change', function() {
                    console.log('RAG toggle changed to:', this.checked);
                    saveRAGSettings();
                });
            }

            if (ragMaxResultsSlider && ragMaxResultsValue) {
                ragMaxResultsSlider.addEventListener('input', function(e) {
                    ragMaxResultsValue.textContent = e.target.value;
                    console.log('RAG max results changed to:', e.target.value);
                    saveRAGSettings();
                });
            }

            // Load initial settings
            loadRAGSettings();
        });
    </script>
</body>
</html>