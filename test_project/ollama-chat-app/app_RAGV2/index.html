<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ollama Web UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <style>
    @import url("https://www.nerdfonts.com/assets/css/webfont.css");

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body {
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
    }

    .container-fluid {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }

    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      gap: 1rem;
    }

    .main-container {
      flex: 1;
      display: flex;
      gap: 1rem;
      min-height: 0;
    }

    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .code-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .panel-header {
      background-color: #e9ecef;
      padding: 0.5rem 1rem;
      border-top-left-radius: 0.375rem;
      border-top-right-radius: 0.375rem;
      font-weight: 600;
      border-bottom: 1px solid #dee2e6;
    }

    #chat-window,
    #code-window {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-top: none;
      padding: 1rem;
      background-color: white;
      border-bottom-left-radius: 0.375rem;
      border-bottom-right-radius: 0.375rem;
    }

    #code-window {
      background-color: #f8f9fa;
      font-family: 'JetBrains Mono', monospace;
    }

    .message {
      margin-bottom: 1rem;
    }

    .user-message {
      text-align: right;
    }

    .user-message .card-body {
      white-space: pre-wrap;
      text-align: left;
    }

    .assistant-message .card-body {
      background-color: #e9ecef;
    }

    .code-block {
      background-color: #2d2d2d;
      color: #e0e0e0;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      position: relative;
      overflow-x: auto;
    }

    .code-block code {
      display: block;
      white-space: pre-wrap;
      font-family: 'JetBrains Mono', monospace;
    }

    .code-language {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: rgba(255, 255, 255, 0.1);
      color: #ccc;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }

    .copy-button {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      z-index: 10;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #ccc;
    }

    .copy-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .header-select-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-select-group label {
      margin-bottom: 0;
      font-weight: 500;
    }

    .drag-over {
      background-color: #e3f2fd !important;
      border: 2px dashed #2196F3 !important;
    }

    .file-message .card {
      border-left: 4px solid #28a745;
    }

    .file-message .card-body i {
      font-size: 1.5rem;
      margin-right: 0.5rem;
    }

    /* Enhanced styling for code block notification */
    .code-block-notification {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin: 0.5rem 0;
      border-left: 4px solid #4c63d2;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideIn 0.3s ease-out;
    }

    .code-block-notification.static {
      animation: none;
    }

    .code-block-notification::before {
      content: "üìù";
      font-size: 1.1rem;
      opacity: 0.8;
    }

    .code-block-notification strong {
      color: #ffd700;
      font-weight: 600;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Alternative dark theme notification */
    .code-block-notification.dark {
      background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      border-left-color: #68d391;
      box-shadow: 0 2px 8px rgba(104, 211, 145, 0.2);
    }

    .code-block-notification.dark::before {
      content: "‚ö°";
    }

    .code-block-notification.dark strong {
      color: #68d391;
    }

    .ollama-header {
      background: linear-gradient(to right, #007bff, #0056b3);
      /* Blue gradient background */
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.375rem 0.375rem 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ollama-title {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .ollama-model-select-group label {
      color: rgba(255, 255, 255, 0.8);
    }

    .ollama-model-select {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 0.25rem;
      padding: 0.375rem 1.75rem 0.375rem 0.75rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      transition: all 0.3s ease;
    }

    .ollama-model-select:focus {
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
      outline: 0;
    }

    .ollama-model-select option {
      background-color: #0056b3;
      /* Darker blue for options */
      color: white;
    }

    .ollama-model-select option:hover {
      background-color: #007bff;
      /* Lighter blue on hover */
    }

    .ollama-header {
      background: linear-gradient(to right, #007bff, #0056b3);
      /* Blue gradient background */
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.375rem 0.375rem 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ollama-title {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .ollama-model-select-group label {
      color: rgba(255, 255, 255, 0.8);
    }

    .ollama-model-select {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 0.25rem;
      padding: 0.375rem 1.75rem 0.375rem 0.75rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      transition: all 0.3s ease;
    }

    .ollama-model-select:focus {
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
      outline: 0;
    }

    .ollama-model-select option {
      background-color: #0056b3;
      /* Darker blue for options */
      color: white;
    }

    .ollama-model-select option:hover {
      background-color: #007bff;
      /* Lighter blue on hover */
    }

    .ollama-header {
      background: linear-gradient(to right, #007bff, #0056b3);
      /* Blue gradient background */
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.375rem 0.375rem 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ollama-title {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .ollama-model-select-group label {
      color: rgba(255, 255, 255, 0.8);
    }

    .ollama-model-select {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 0.25rem;
      padding: 0.375rem 1.75rem 0.375rem 0.75rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      transition: all 0.3s ease;
    }

    .ollama-model-select:focus {
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
      outline: 0;
    }

    .ollama-model-select option {
      background-color: #0056b3;
      /* Darker blue for options */
      color: white;
    }

    .ollama-model-select option:hover {
      background-color: #007bff;
      /* Lighter blue on hover */
    }

    .ollama-header {
      background: linear-gradient(to right, #007bff, #0056b3);
      /* Blue gradient background */
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.375rem 0.375rem 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ollama-title {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .ollama-model-select-group label {
      color: rgba(255, 255, 255, 0.8);
    }

    .ollama-model-select {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 0.25rem;
      padding: 0.375rem 1.75rem 0.375rem 0.75rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      transition: all 0.3s ease;
    }

    .ollama-model-select:focus {
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
      outline: 0;
    }

    .ollama-model-select option {
      background-color: #0056b3;
      /* Darker blue for options */
      color: white;
    }

    .ollama-model-select option:hover {
      background-color: #007bff;
      /* Lighter blue on hover */
    }

    .ollama-header {
      background: linear-gradient(to right, #007bff, #0056b3);
      /* Blue gradient background */
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.375rem 0.375rem 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ollama-title {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .ollama-model-select-group label {
      color: rgba(255, 255, 255, 0.8);
    }

    .ollama-model-select {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 0.25rem;
      padding: 0.375rem 1.75rem 0.375rem 0.75rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      transition: all 0.3s ease;
    }

    .ollama-model-select:focus {
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
      outline: 0;
    }

    .ollama-model-select option {
      background-color: #0056b3;
      /* Darker blue for options */
      color: white;
    }

    .ollama-model-select option:hover {
      background-color: #007bff;
      /* Lighter blue on hover */
    }

    @media (max-width: 992px) {
      .main-container {
        flex-direction: column;
      }

      .chat-panel,
      .code-panel {
        min-height: 300px;
      }

      .header-select-group {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    #message-input {
      background-color: #d0ffc6;
      resize: none;
      overflow: hidden;
      min-height: 1.5em;
      max-height: 7.5em;
      line-height: 1.5em;
    }

    .input-group>button {
      height: 38px;
      max-height: 38px;
      align-self: center;
      flex-shrink: 0;
      border-radius: 2%;
    }

    .input-group>textarea {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .input-group>button:first-of-type {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .dropup .btn {
      height: 38px;
      max-height: 38px;
    }

    .clear-code-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      z-index: 10;
    }

    .shrink-button {
      position: absolute;
      bottom: 0.5rem;
      right: 4rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      z-index: 10;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #ccc;
    }

    .shrink-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .code-block.collapsed {
      max-height: 150px;
      overflow: hidden;
    }

    .code-block.collapsed::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(to bottom, transparent, #2d2d2d);
    }

    .code-block.collapsed .shrink-button::before {
      content: "‚á£";
    }

    .code-block:not(.collapsed) .shrink-button::before {
      content: "‚á°";
    }

    /* Centered compact input row */
    .input-row-center {
      max-width: 50%;
      margin: 0 auto;
      display: flex;
      gap: .5rem;
    }

    /* Let the textarea fill the available space */
    .input-row-center textarea {
      flex: 1 1 auto;
    }

    @media (max-width: 992px) {

      /* ‚Ä¶ existing rules ‚Ä¶ */
      .input-row-center {
        max-width: 100%;
        /* full width on small screens */
      }
    }

    .success-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 9999;
      /* Ensure it's on top of everything */
    }

    .success-notification.show {
      opacity: 1;
    }

    .success-notification .check-icon {
      font-size: 1.5em;
    }

    /* RAG-specific styles */
    .rag-document-card {
      border-left: 4px solid #007bff;
    }

    .rag-search-result {
      border-left: 3px solid #28a745;
      margin-bottom: 10px;
    }

    .rag-distance-badge {
      font-size: 0.8em;
    }

    /* RAG Status styles */
    .rag-status-ready {
      background-color: #d1e7dd !important;
      border-color: #badbcc !important;
      color: #0f5132 !important;
    }

    .rag-status-error {
      background-color: #f8d7da !important;
      border-color: #f5c2c7 !important;
      color: #842029 !important;
    }

    .rag-status-warning {
      background-color: #fff3cd !important;
      border-color: #ffecb5 !important;
      color: #664d03 !important;
    }

    .rag-status-icon {
      font-size: 1.2em;
      margin-right: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="card">
      <div class="card-header ollama-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h1 class="m-0 ollama-title">Ollama Web UI</h1>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-light" id="rag-btn" title="RAG System">üìö RAG</button>
          <select id="model-select" class="form-select form-select-sm ollama-model-select"></select>
          <button class="btn btn-sm btn-outline-light" id="settings-btn"><i class="nf nf-md-cog"></i></button>
        </div>
      </div>
      <div class="card-body">
        <div class="main-container">
          <div class="chat-panel">
            <div class="panel-header"><i class="nf nf-md-chat"></i> Conversation</div>
            <div id="chat-window"></div>
          </div>
          <div class="code-panel">
            <div class="panel-header position-relative">
              <i class="nf nf-md-code_greater_than"></i> Code Output
              <button id="clear-code" class="btn btn-sm btn-outline-secondary clear-code-btn">Clear</button>
            </div>
            <div id="code-window">
              <div class="text-muted text-center mt-5">
                <i class="nf nf-md-code_tags" style="font-size: 3rem;"></i>
                <p>Code blocks will appear here</p>
              </div>
            </div>
          </div>
        </div>

        <form id="chat-form">
          <div class="input-row-center">
            <textarea id="message-input" class="form-control" placeholder="Type your message..." rows="3"
              required></textarea>
            <div class="d-flex flex-column gap-1">
              <div class="dropup">
                <button class="btn btn-info dropdown-toggle" type="button" id="suggestionsDropdown"
                  data-bs-toggle="dropdown" aria-expanded="false">
                  Suggestions
                </button>
                <ul class="dropdown-menu" aria-labelledby="suggestionsDropdown" id="suggestionsList">
                  <!-- Suggestions will be loaded dynamically -->
                </ul>
              </div>
              <button type="button" class="btn btn-outline-secondary" onclick="openFileUpload()" title="Upload Files">
                <i class="nf nf-mdi-folder_open"></i>
              </button>
            </div>
            <input type="file" id="fileInput" multiple style="display: none;"
              accept=".txt,.py,.js,.html,.css,.json,.md,.ps1,.sh,.java,.cpp,.c,.cs,.php,.rb,.go,.rs,.kt,.swift,.xml,.yaml,.yml">
            <button type="submit" class="btn btn-primary"><i class="nf nf-md-send"></i></button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Suggestions Management Modal -->
  <div class="modal fade" id="suggestionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üí° Manage Suggestions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Add New Suggestion -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">‚ûï Add New Suggestion</h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="newSuggestionText" class="form-label">Suggestion Text:</label>
                <input type="text" class="form-control" id="newSuggestionText"
                  placeholder="e.g., Create a Python calculator">
              </div>
              <button class="btn btn-success" onclick="addNewSuggestion()">Add Suggestion</button>
            </div>
          </div>

          <!-- Existing Suggestions -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">üìù Existing Suggestions</h6>
            </div>
            <div class="card-body">
              <div id="existingSuggestions">
                <!-- Existing suggestions will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="resetToDefaults()">Reset to Defaults</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RAG Management Modal -->
  <div class="modal fade" id="ragModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üìö RAG System Management</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Navigation Tabs -->
          <ul class="nav nav-tabs mb-4" id="ragTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="rag-status-tab" data-bs-toggle="tab" data-bs-target="#rag-status"
                type="button">Status</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="rag-add-tab" data-bs-toggle="tab" data-bs-target="#rag-add" type="button">Add
                Documents</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="rag-search-tab" data-bs-toggle="tab" data-bs-target="#rag-search"
                type="button">Search</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="rag-manage-tab" data-bs-toggle="tab" data-bs-target="#rag-manage"
                type="button">Manage</button>
            </li>
          </ul>

          <div class="tab-content" id="ragTabContent">
            <!-- Status Tab -->
            <div class="tab-pane fade show active" id="rag-status" role="tabpanel">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">üîç System Status</h6>
                  <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="checkRAGSystemStatus()"
                      title="Refresh Status">
                      <i class="nf nf-md-refresh"></i> Refresh
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="testRAGConnection()"
                      title="Test RAG Connection">
                      <i class="nf nf-md-test_tube"></i> Test
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="ragSystemStatus">
                    <div class="d-flex align-items-center">
                      <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                      <span>Checking RAG system status...</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mt-4">
                <div class="card-header">
                  <h6 class="mb-0">üí° How RAG Works</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <strong>üî§ Embedding Model:</strong><br>
                        <code>nomic-embed-text</code><br>
                        <span class="text-muted">Converts documents to vectors for search</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <strong>ü§ñ Chat Models:</strong><br>
                        <code>gemma2:1b</code>, <code>qwen2.5:8b</code><br>
                        <span class="text-muted">Generate responses using RAG context</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <strong>üîÑ Process:</strong>
                        <ol class="mb-0 ps-3 small">
                          <li>Add documents ‚Üí vectors created</li>
                          <li>Ask question ‚Üí relevant docs found</li>
                          <li>Chat model ‚Üí uses context to respond</li>
                        </ol>
                      </div>
                    </div>
                  </div>
                  <div class="alert alert-success mt-3">
                    <strong>‚ú® Tip:</strong> Any chat model you select will automatically use your knowledge base! Just
                    add documents here, then ask questions in the main chat.
                  </div>
                </div>
              </div>
            </div>

            <!-- Add Documents Tab -->
            <div class="tab-pane fade" id="rag-add" role="tabpanel">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">üìÅ Add Documents to Knowledge Base</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="text-center p-4 border rounded bg-light">
                        <i class="nf nf-mdi-file_plus" style="font-size: 3rem; color: #007bff;"></i>
                        <h5 class="mt-3">Add Single File</h5>
                        <p class="text-muted">Select a single document to add</p>
                        <button class="btn btn-primary" onclick="ragBrowseFile()">
                          <i class="nf nf-mdi-folder_open"></i> Choose File
                        </button>
                        <input type="file" id="ragFileInput" style="display: none;"
                          accept=".txt,.md,.py,.js,.html,.css,.json,.xml,.yaml,.yml,.csv,.sql,.sh,.ps1,.bat,.cmd,.java,.cpp,.c,.cs,.php,.rb,.go,.rs,.kt,.swift,.scala,.r,.perl,.lua,.dart">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="text-center p-4 border rounded bg-light">
                        <i class="nf nf-mdi-folder_plus" style="font-size: 3rem; color: #28a745;"></i>
                        <h5 class="mt-3">Add Entire Folder</h5>
                        <p class="text-muted">Select a folder to add all files</p>
                        <button class="btn btn-success" onclick="ragBrowseFolder()">
                          <i class="nf nf-mdi-folder_open"></i> Choose Folder
                        </button>
                        <input type="file" id="ragFolderInput" style="display: none;" webkitdirectory directory
                          multiple>
                      </div>
                    </div>
                  </div>

                  <!-- File Details Form (Hidden by default) -->
                  <div id="ragFileDetails" class="mt-4" style="display: none;">
                    <div class="card border-primary">
                      <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">üìù File Details</h6>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-8">
                            <div class="mb-3">
                              <label class="form-label">Selected Path:</label>
                              <input type="text" class="form-control" id="ragSelectedPath" readonly>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Category:</label>
                              <select class="form-select" id="ragCategory">
                                <option value="general">General</option>
                                <option value="code">Code</option>
                                <option value="documentation">Documentation</option>
                                <option value="configuration">Configuration</option>
                                <option value="notes">Notes</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        <div class="d-flex gap-2">
                          <button class="btn btn-success" id="ragConfirmAdd">
                            <i class="nf nf-md-check"></i> Add to Knowledge Base
                          </button>
                          <button class="btn btn-outline-secondary" onclick="ragCancelAdd()">
                            <i class="nf nf-md-close"></i> Cancel
                          </button>
                        </div>
                        <div id="ragAddProgress" class="mt-3" style="display: none;">
                          <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                          </div>
                          <small class="text-muted">Processing files...</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Supported Files Info -->
                  <div class="mt-4">
                    <div class="alert alert-info">
                      <strong>üìã Supported File Types:</strong>
                      <div class="small mt-1">
                        <span class="badge bg-secondary me-1">.txt</span>
                        <span class="badge bg-secondary me-1">.md</span>
                        <span class="badge bg-secondary me-1">.py</span>
                        <span class="badge bg-secondary me-1">.js</span>
                        <span class="badge bg-secondary me-1">.html</span>
                        <span class="badge bg-secondary me-1">.css</span>
                        <span class="badge bg-secondary me-1">.json</span>
                        <span class="badge bg-secondary me-1">.xml</span>
                        <span class="badge bg-secondary me-1">.yaml</span>
                        <span class="badge bg-secondary me-1">.sql</span>
                        <span class="badge bg-secondary me-1">.java</span>
                        <span class="badge bg-secondary me-1">.cpp</span>
                        <span class="badge bg-secondary me-1">.cs</span>
                        <span class="badge bg-secondary me-1">.php</span>
                        <span class="badge bg-secondary me-1">.go</span>
                        <span class="badge bg-secondary me-1">.rs</span>
                        <span class="badge bg-secondary me-1">and more...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Search Tab -->
            <div class="tab-pane fade" id="rag-search" role="tabpanel">
              <div class="card">
                <div class="card-header">
                  <h6>Search Documents</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="ragSearchQuery" class="form-label">Search Query</label>
                    <input type="text" class="form-control" id="ragSearchQuery"
                      placeholder="Enter your search query...">
                  </div>
                  <div class="mb-3">
                    <label for="ragNumResults" class="form-label">Number of Results</label>
                    <select class="form-select" id="ragNumResults">
                      <option value="3">3</option>
                      <option value="5" selected>5</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                  <button class="btn btn-primary" onclick="ragSearchDocuments()">Search</button>
                  <div id="ragSearchResults" class="mt-4"></div>
                </div>
              </div>
            </div>



            <!-- Manage Tab -->
            <div class="tab-pane fade" id="rag-manage" role="tabpanel">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6>Document Collection</h6>
                  <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="ragLoadDocuments()">Refresh</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="ragClearCollection()">Clear All</button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="ragDocumentsList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modelSelect = document.getElementById("model-select");

      // Add to your DOMContentLoaded event listener
      const chatWindow = document.getElementById("chat-window");

      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        chatWindow.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // Add visual feedback for drag over
      ['dragenter', 'dragover'].forEach(eventName => {
        chatWindow.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        chatWindow.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        chatWindow.classList.add('drag-over');
      }

      function unhighlight(e) {
        chatWindow.classList.remove('drag-over');
      }

      async function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = (e) => {
            const content = e.target.result;
            resolve({
              name: file.name,
              type: file.type,
              size: file.size,
              content: content
            });
          };

          reader.onerror = () => reject(reader.error);

          const textExtensions = ['.py', '.ps1', '.html', '.txt', '.md', '.json', '.js', '.css'];
          const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

          if (file.type.startsWith('text/') || textExtensions.includes(fileExtension)) {
            reader.readAsText(file);
          } else {
            // For binary files
            resolve({
              name: file.name,
              type: file.type,
              size: file.size,
              content: '[Binary file - content not displayed]'
            });
          }
        });
      }

      chatWindow.addEventListener('drop', handleDrop, false);

      async function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        for (let file of files) {
          try {
            const fileData = await readFileContent(file);
            displayFileMessage(fileData);
          } catch (error) {
            console.error('Error reading file:', error);
          }
        }
      }

      function getFileIcon(fileName) {
        const extension = fileName.toLowerCase().split('.').pop();
        const iconMap = {
          'py': 'nf nf-dev-python',
          'js': 'nf nf-dev-javascript_badge',
          'ts': 'nf nf-dev-typescript_badge',
          'html': 'nf nf-dev-html5',
          'css': 'nf nf-dev-css3',
          'java': 'nf nf-dev-java',
          'cpp': 'nf nf-dev-cpp',
          'c': 'nf nf-dev-c',
          'cs': 'nf nf-dev-csharp',
          'php': 'nf nf-dev-php',
          'rb': 'nf nf-dev-ruby',
          'go': 'nf nf-dev-go',
          'rs': 'nf nf-dev-rust',
          'kt': 'nf nf-dev-kotlin',
          'swift': 'nf nf-dev-swift',
          'scala': 'nf nf-dev-scala',
          'r': 'nf nf-dev-r',
          'perl': 'nf nf-dev-perl',
          'lua': 'nf nf-dev-lua',
          'dart': 'nf nf-dev-dart',
          'ps1': 'nf nf-dev-powershell',
          'sh': 'nf nf-dev-shell',
          'bash': 'nf nf-dev-shell',
          'bat': 'nf nf-dev-terminal',
          'cmd': 'nf nf-dev-terminal',
          'json': 'nf nf-mdi-json',
          'xml': 'nf nf-mdi-xml',
          'yaml': 'nf nf-mdi-yaml',
          'yml': 'nf nf-mdi-yaml',
          'csv': 'nf nf-mdi-file_delimited',
          'sql': 'nf nf-mdi-database',
          'md': 'nf nf-dev-markdown',
          'txt': 'nf nf-mdi-file_document',
          'pdf': 'nf nf-mdi-file_pdf',
          'doc': 'nf nf-mdi-file_word',
          'docx': 'nf nf-mdi-file_word',
          'png': 'nf nf-mdi-file_image',
          'jpg': 'nf nf-mdi-file_image',
          'jpeg': 'nf nf-mdi-file_image',
          'gif': 'nf nf-mdi-file_image',
          'svg': 'nf nf-mdi-svg',
          'zip': 'nf nf-mdi-zip_box',
          'rar': 'nf nf-mdi-zip_box',
          '7z': 'nf nf-mdi-zip_box',
          'tar': 'nf nf-mdi-zip_box',
          'ini': 'nf nf-mdi-settings',
          'conf': 'nf nf-mdi-settings',
          'config': 'nf nf-mdi-settings',
          'env': 'nf nf-mdi-settings',
          'default': 'nf nf-mdi-file'
        };

        return iconMap[extension] || iconMap['default'];
      }

      function displayFileMessage(fileData) {
        const fileMessage = `**File uploaded:** ${fileData.name} (${formatFileSize(fileData.size)})\n\n`;

        // Create a special file message
        const messageElement = document.createElement("div");
        messageElement.classList.add("message", "user-message", "file-message");

        const messageContent = document.createElement('div');
        messageContent.classList.add('d-flex', 'align-items-center', 'justify-content-end');

        const card = document.createElement("div");
        card.classList.add("card", "d-inline-block");
        card.style.maxWidth = "80%";

        const cardBody = document.createElement("div");
        cardBody.classList.add("card-body");

        // Get appropriate file icon
        const fileIconClass = getFileIcon(fileData.name);

        // File header with icon
        const fileHeader = document.createElement("div");
        fileHeader.innerHTML = `<i class="${fileIconClass}"></i> <strong>${fileData.name}</strong> <small class="text-muted">(${formatFileSize(fileData.size)})</small>`;
        cardBody.appendChild(fileHeader);

        card.appendChild(cardBody);
        messageContent.appendChild(card);
        messageElement.appendChild(messageContent);

        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        // Add to conversation history - only include actual content, not hidden messages
        const historyContent = fileData.content === '[Content hidden for security]' ||
          fileData.content === '[Binary file - content not displayed]'
          ? `File uploaded: ${fileData.name}`
          : `${fileMessage}\`\`\`\n${fileData.content}\n\`\`\``;

        conversationHistory.push({
          role: "user",
          content: historyContent
        });
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      const codeWindow = document.getElementById("code-window");
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message-input");
      const clearCodeButton = document.getElementById("clear-code");
      const settingsBtn = document.getElementById("settings-btn");
      const ragBtn = document.getElementById("rag-btn");
      const ragModal = new bootstrap.Modal(document.getElementById('ragModal'));
      const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
      const maxTokensSlider = document.getElementById('max-tokens-slider');
      const maxTokensValue = document.getElementById('max-tokens-value');
      const contextWindowSlider = document.getElementById('context-window-slider');
      const contextWindowValue = document.getElementById('context-window-value');
      const temperatureSlider = document.getElementById('temperature-slider');
      const temperatureValue = document.getElementById('temperature-value');
      const topPSlider = document.getElementById('top-p-slider');
      const topPValue = document.getElementById('top-p-value');
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      });
      let conversationHistory = [];
      let codeBlocks = [];

      // Model memory functions
      function saveSelectedModel(modelName) {
        localStorage.setItem('selectedOllamaModel', modelName);
      }

      function loadSelectedModel() {
        return localStorage.getItem('selectedOllamaModel');
      }

      function showSuccessNotification(message) {
        const notification = document.getElementById('success-notification');
        const notificationMessage = document.getElementById('notification-message');
        notificationMessage.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
        }, 2000);
      }

      // Model parameter settings
      const DEFAULT_MODEL_SETTINGS = {
        num_predict: 2048,
        num_ctx: 4096,
        temperature: 0.8,
        top_p: 0.9
      };

      function saveModelSettings() {
        const settings = {
          num_predict: parseInt(maxTokensSlider.value, 10),
          num_ctx: parseInt(contextWindowSlider.value, 10),
          temperature: parseFloat(temperatureSlider.value),
          top_p: parseFloat(topPSlider.value)
        };
        localStorage.setItem('ollamaModelSettings', JSON.stringify(settings));
        saveSettingsToServer(); // Save to server
      }

      async function saveSettingsToServer() {
        const modelSettings = JSON.parse(localStorage.getItem('ollamaModelSettings')) || DEFAULT_MODEL_SETTINGS;
        const ragSettings = JSON.parse(localStorage.getItem('ollamaRAGSettings')) || DEFAULT_RAG_SETTINGS;
        const instructions = currentInstructions || [];

        const settings = {
          instructions: instructions,
          num_predict: modelSettings.num_predict,
          num_ctx: modelSettings.num_ctx,
          temperature: modelSettings.temperature,
          top_p: modelSettings.top_p,
          rag_enabled: ragSettings.rag_enabled,
          rag_max_results: ragSettings.rag_max_results
        };

        try {
          const response = await fetch('/api/settings/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings })
          });

          const data = await response.json();
          if (data.success) {
            showSuccessNotification('Settings saved successfully!');
          } else {
            alert('Failed to save settings to server');
          }
        } catch (error) {
          console.error('Settings save error:', error);
          alert('Settings saved locally but failed to sync with server');
        }
      }

      function loadModelSettings() {
        const savedSettings = JSON.parse(localStorage.getItem('ollamaModelSettings'));
        const settingsToApply = savedSettings || DEFAULT_MODEL_SETTINGS;

        maxTokensSlider.value = settingsToApply.num_predict;
        maxTokensValue.textContent = settingsToApply.num_predict;
        contextWindowSlider.value = settingsToApply.num_ctx;
        contextWindowValue.textContent = settingsToApply.num_ctx;
        temperatureSlider.value = settingsToApply.temperature;
        temperatureValue.textContent = settingsToApply.temperature;
        topPSlider.value = settingsToApply.top_p;
        topPValue.textContent = settingsToApply.top_p;
      }

      window.resetModelSettings = function () {
        maxTokensSlider.value = DEFAULT_MODEL_SETTINGS.num_predict;
        contextWindowSlider.value = DEFAULT_MODEL_SETTINGS.num_ctx;
        temperatureSlider.value = DEFAULT_MODEL_SETTINGS.temperature;
        topPSlider.value = DEFAULT_MODEL_SETTINGS.top_p;
        saveModelSettings();
        loadModelSettings(); // Update displayed values
      };

      // RAG Settings Management
      const DEFAULT_RAG_SETTINGS = {
        rag_enabled: true,
        rag_max_results: 3
      };

      function saveRAGSettings() {
        const ragEnabled = document.getElementById('rag-enabled');
        const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');

        if (ragEnabled && ragMaxResultsSlider) {
          const settings = {
            rag_enabled: ragEnabled.checked,
            rag_max_results: parseInt(ragMaxResultsSlider.value, 10)
          };
          localStorage.setItem('ollamaRAGSettings', JSON.stringify(settings));
          saveSettingsToServer(); // Save to server
        }
      }



      async function loadRAGSettings() {
        const localSettings = JSON.parse(localStorage.getItem('ollamaRAGSettings'));
        const settingsToApply = localSettings || DEFAULT_RAG_SETTINGS;

        const ragEnabled = document.getElementById('rag-enabled');
        const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
        const ragMaxResultsValue = document.getElementById('rag-max-results-value');

        console.log('Loading RAG settings:', settingsToApply);

        if (ragEnabled) {
          ragEnabled.checked = settingsToApply.rag_enabled !== false; // Default to true
        }
        if (ragMaxResultsSlider && ragMaxResultsValue) {
          ragMaxResultsSlider.value = settingsToApply.rag_max_results || 3;
          ragMaxResultsValue.textContent = settingsToApply.rag_max_results || 3;
        }

        // Load knowledge base status
        loadRAGStatus();
      }

      async function loadRAGStatus() {
        const statusDiv = document.getElementById('rag-status');
        if (!statusDiv) return;

        try {
          const response = await fetch('/api/rag/documents');
          if (response.ok) {
            const data = await response.json();
            const docCount = data.documents.length;
            const totalChunks = data.documents.reduce((sum, doc) => sum + doc.chunk_count, 0);

            statusDiv.innerHTML = `
              <div class="d-flex justify-content-between">
                <span><strong>${docCount}</strong> documents</span>
                <span><strong>${totalChunks}</strong> chunks</span>
              </div>
              <small class="text-muted">Knowledge base is ${docCount > 0 ? 'ready' : 'empty'}</small>
            `;
          } else {
            statusDiv.innerHTML = '<span class="text-warning">‚ö†Ô∏è Unable to load status</span>';
          }
        } catch (error) {
          statusDiv.innerHTML = '<span class="text-danger">‚ùå Connection error</span>';
        }
      }

      window.resetRAGSettings = function () {
        const ragEnabled = document.getElementById('rag-enabled');
        const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');

        if (ragEnabled) ragEnabled.checked = DEFAULT_RAG_SETTINGS.rag_enabled;
        if (ragMaxResultsSlider) ragMaxResultsSlider.value = DEFAULT_RAG_SETTINGS.rag_max_results;

        saveRAGSettings();
        loadRAGSettings();
      };

      // RAG Settings Event Listeners - Initialize after DOM is loaded
      function initializeRAGEventListeners() {
        const ragEnabled = document.getElementById('rag-enabled');
        const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
        const ragMaxResultsValue = document.getElementById('rag-max-results-value');

        if (ragEnabled) {
          ragEnabled.addEventListener('change', function () {
            console.log('RAG toggle changed to:', this.checked);
            saveRAGSettings();
          });
        }

        if (ragMaxResultsSlider && ragMaxResultsValue) {
          ragMaxResultsSlider.addEventListener('input', function (e) {
            ragMaxResultsValue.textContent = e.target.value;
            console.log('RAG max results changed to:', e.target.value);
            saveRAGSettings();
          });
        }
      }

      settingsBtn.addEventListener("click", () => {
        loadModelSettings();
        loadRAGSettings();
        // Small delay to ensure DOM elements are ready
        setTimeout(initializeRAGEventListeners, 100);
        settingsModal.show();
      });

      ragBtn.addEventListener("click", () => {
        checkRAGSystemStatus();
        ragLoadDocuments();
        ragModal.show();
      });

      maxTokensSlider.addEventListener('input', (e) => {
        maxTokensValue.textContent = e.target.value;
        saveModelSettings();
      });

      contextWindowSlider.addEventListener('input', (e) => {
        contextWindowValue.textContent = e.target.value;
        saveModelSettings();
      });

      temperatureSlider.addEventListener('input', (e) => {
        temperatureValue.textContent = e.target.value;
        saveModelSettings();
      });

      topPSlider.addEventListener('input', (e) => {
        topPValue.textContent = e.target.value;
        saveModelSettings();
      });

      // RAG Settings Event Listeners
      document.addEventListener('DOMContentLoaded', () => {
        const ragEnabled = document.getElementById('rag-enabled');
        const ragMaxResultsSlider = document.getElementById('rag-max-results-slider');
        const ragMaxResultsValue = document.getElementById('rag-max-results-value');

        if (ragEnabled) {
          ragEnabled.addEventListener('change', saveRAGSettings);
        }

        if (ragMaxResultsSlider && ragMaxResultsValue) {
          ragMaxResultsSlider.addEventListener('input', (e) => {
            ragMaxResultsValue.textContent = e.target.value;
            saveRAGSettings();
          });
        }
      });

      function autoGrowTextarea(el) {
        el.style.height = "auto";
        const maxHeight = parseFloat(getComputedStyle(el).maxHeight);
        el.style.height = Math.min(el.scrollHeight, maxHeight) + "px";
      }
      messageInput.addEventListener("input", () => autoGrowTextarea(messageInput));
      window.addEventListener("load", () => autoGrowTextarea(messageInput));

      clearCodeButton.addEventListener("click", () => {
        codeWindow.innerHTML = `
          <div class="text-muted text-center mt-5">
            <i class="nf nf-md-code_tags" style="font-size: 3rem;"></i>
            <p>Code blocks will appear here</p>
          </div>
        `;
        codeBlocks = [];
      });

      codeWindow.addEventListener("click", (e) => {
        const copyButton = e.target.closest(".copy-button");
        if (copyButton) {
          const codeBlock = copyButton.closest(".code-block");
          const code = codeBlock.querySelector("code");
          navigator.clipboard.writeText(code.textContent)
            .then(() => { copyButton.textContent = "‚úîÔ∏è"; setTimeout(() => copyButton.textContent = "Copy", 1500); })
            .catch(() => { copyButton.textContent = "Failed"; setTimeout(() => copyButton.textContent = "Copy", 1500); });
        }
      });

      async function fetchModels() {
        try {
          const response = await fetch("/api/tags");
          const data = await response.json();
          const savedModel = loadSelectedModel();
          let modelFound = false;

          data.models.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.name;
            option.textContent = model.name;
            modelSelect.appendChild(option);

            // Check if this is the previously saved model
            if (savedModel && model.name === savedModel) {
              option.selected = true;
              modelFound = true;
            }
          });

          // If saved model wasn't found but we have models, select the first one
          if (!modelFound && data.models.length > 0) {
            modelSelect.selectedIndex = 0;
            saveSelectedModel(data.models[0].name);
          }
        } catch (error) {
          console.error("Error fetching models:", error);
          alert("Could not fetch models. Make sure Ollama is running.");
        }
      }

      // Add event listener for model selection changes
      modelSelect.addEventListener('change', (e) => {
        saveSelectedModel(e.target.value);
      });

      function extractAndDisplayCode(text) {
        const codeRegex = /```(\w+)?\n([\s\S]*?)```/g;
        let match;
        const extractedCodes = [];
        while ((match = codeRegex.exec(text)) !== null) {
          const language = match[1] || 'text';
          const code = match[2];
          extractedCodes.push({ language, code });
        }
        if (extractedCodes.length > 0) {
          const placeholder = codeWindow.querySelector('.text-muted.text-center');
          if (placeholder) placeholder.remove();
          const existingBlocks = Array.from(codeWindow.querySelectorAll('.code-block'));
          extractedCodes.forEach(({ language, code }) => {
            const isDuplicate = existingBlocks.some(block => {
              const blockLanguage = block.querySelector('.code-language').textContent;
              const blockCode = block.querySelector('code').textContent;
              return blockLanguage === language && blockCode === code;
            });
            if (!isDuplicate) {
              const codeBlockElement = document.createElement("div");
              codeBlockElement.className = "code-block";
              codeBlockElement.innerHTML = `
                <div class="code-language">${language}</div>
                <button class="copy-button btn btn-sm">Copy</button>
                <button class="shrink-button btn btn-sm"></button>
                <code class="language-${language}">${escapeHtml(code)}</code>
              `;
              const shrinkBtn = codeBlockElement.querySelector('.shrink-button');
              shrinkBtn.addEventListener('click', () => codeBlockElement.classList.toggle('collapsed'));
              codeWindow.appendChild(codeBlockElement);
              hljs.highlightElement(codeBlockElement.querySelector('code'));
              codeBlocks.push({ language, code });
            }
          });
          codeWindow.scrollTop = codeWindow.scrollHeight;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatMessageText(text) {
        const textWithoutCode = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language) => {
          // Create a styled notification without animation during streaming
          return `<div class="code-block-notification static">Code block <strong>(${language || 'text'})</strong> moved to code panel</div>`;
        });
        return marked.parse(textWithoutCode);
      }

      function displayMessage(sender, message, index, modelName) {
        const messageElement = document.createElement("div");
        messageElement.classList.add("message", sender === "user" ? "user-message" : "assistant-message");
        if (index !== undefined) messageElement.dataset.index = index;

        const messageContent = document.createElement('div');
        const contentClasses = ['d-flex', 'align-items-center'];
        if (sender === 'user') contentClasses.push('justify-content-end');
        messageContent.classList.add(...contentClasses);

        const card = document.createElement("div");
        card.classList.add("card", "d-inline-block");
        const cardBody = document.createElement("div");
        cardBody.classList.add("card-body");

        if (sender === "assistant") {
          if (modelName) {
            const modelNameElement = document.createElement('div');
            modelNameElement.style.fontWeight = 'bold';
            modelNameElement.style.marginBottom = '0.5rem';
            modelNameElement.textContent = `Model: ${modelName}`;
            cardBody.appendChild(modelNameElement);
          }
          const messageTextElement = document.createElement('div');
          messageTextElement.className = 'message-text';
          messageTextElement.innerHTML = formatMessageText(message);
          cardBody.appendChild(messageTextElement);
        } else cardBody.textContent = message;

        card.appendChild(cardBody);
        messageContent.appendChild(card);

        if (sender === "user") {
          const editButton = document.createElement("button");
          editButton.innerHTML = '<i class="nf nf-md-pencil"></i>';
          editButton.className = "btn btn-sm btn-outline-secondary edit-button ms-2";
          editButton.onclick = () => editMessage(index);
          messageContent.appendChild(editButton);
        }

        messageElement.appendChild(messageContent);

        if (sender === "assistant") {
          const footer = document.createElement('div');
          footer.className = 'd-flex justify-content-start align-items-center mt-2';
          const stats = document.createElement('span');
          stats.className = 'text-muted me-2';
          stats.style.fontSize = '0.8rem';
          const reloadButton = document.createElement("button");
          reloadButton.innerHTML = '<i class="nf nf-md-reload"></i>';
          reloadButton.className = "btn btn-sm btn-outline-secondary reload-button";
          reloadButton.onclick = () => reloadResponse(index);
          const continueButton = document.createElement("button");
          continueButton.innerHTML = '<i class="nf nf-md-play"></i>';
          continueButton.className = "btn btn-sm btn-outline-secondary continue-button ms-2";
          continueButton.onclick = () => continueResponse(index);
          footer.appendChild(stats);
          footer.appendChild(reloadButton);
          footer.appendChild(continueButton);
          messageElement.appendChild(footer);
        }

        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return cardBody;
      }

      function editMessage(index) {
        const messageElement = document.querySelector(`.message[data-index='${index}']`);
        const originalContent = conversationHistory[index].content;
        const editContainer = document.createElement('div');
        editContainer.className = 'edit-container mt-2';
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control';
        textarea.value = originalContent;
        textarea.rows = 3;
        autoGrowTextarea(textarea);
        textarea.addEventListener("input", () => autoGrowTextarea(textarea));
        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save & Submit';
        saveButton.className = 'btn btn-sm btn-primary mt-2';
        saveButton.onclick = () => saveMessage(index, textarea.value);
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.className = 'btn btn-sm btn-secondary mt-2 ms-2';
        cancelButton.onclick = () => cancelEdit(index);
        editContainer.appendChild(textarea);
        editContainer.appendChild(saveButton);
        editContainer.appendChild(cancelButton);
        const messageContent = messageElement.querySelector('.d-flex');
        messageContent.style.display = 'none';
        messageElement.appendChild(editContainer);
        textarea.focus();
      }

      function cancelEdit(index) {
        const messageElement = document.querySelector(`.message[data-index='${index}']`);
        const editContainer = messageElement.querySelector('.edit-container');
        if (editContainer) editContainer.remove();
        const messageContent = messageElement.querySelector('.d-flex');
        messageContent.style.display = 'flex';
      }

      async function continueResponse(index) {
        if (index === undefined || index < 1) return;
        messageInput.value = "continue";
        chatForm.requestSubmit();
      }

      async function reloadResponse(index) {
        if (index === undefined || index < 1) return;
        const userMessageToResend = conversationHistory[index - 1];
        conversationHistory.splice(index - 1);
        const messages = document.querySelectorAll('.message');
        messages.forEach(msg => {
          const msgIndex = parseInt(msg.dataset.index, 10);
          if (msgIndex >= index - 1) msg.remove();
        });
        conversationHistory.push(userMessageToResend);
        displayMessage("user", userMessageToResend.content, conversationHistory.length - 1);
        await sendChatRequest(conversationHistory);
      }

      async function saveMessage(index, newContent) {
        if (newContent.trim() === "") return;
        conversationHistory[index].content = newContent;
        conversationHistory.splice(index + 1);
        const messages = document.querySelectorAll('.message');
        messages.forEach(msg => {
          const msgIndex = parseInt(msg.dataset.index, 10);
          if (msgIndex > index) msg.remove();
        });
        const messageElement = document.querySelector(`.message[data-index='${index}']`);
        const cardBody = messageElement.querySelector('.card-body');
        cardBody.textContent = newContent;
        cancelEdit(index);
        await sendChatRequest(conversationHistory);
      }

      async function sendChatRequest(history, isContinuation = false) {
        const selectedModel = modelSelect.value;
        if (!selectedModel) { alert("Please select a model first."); return; }

        let assistantMessageElement, assistantMessageTextElement, assistantResponse = "", lastMessageIndex;

        if (isContinuation) {
          lastMessageIndex = history.length - 1;
          assistantMessageElement = document.querySelector(`.message[data-index='${lastMessageIndex}']`);
          if (!assistantMessageElement) { console.error("Could not find the message element to continue."); return; }
          assistantMessageTextElement = assistantMessageElement.querySelector('.message-text');
          assistantResponse = conversationHistory[lastMessageIndex].content;
        } else {
          const cardBody = displayMessage("assistant", "", history.length, selectedModel);
          assistantMessageElement = cardBody.closest('.message');
          assistantMessageTextElement = cardBody.querySelector('.message-text');
        }

        let finalData;
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: selectedModel,
              messages: history,
              stream: true,
              options: {
                num_predict: parseInt(maxTokensSlider.value, 10),
                num_ctx: parseInt(contextWindowSlider.value, 10),
                temperature: parseFloat(temperatureSlider.value),
                top_p: parseFloat(topPSlider.value)
              },
              system_instructions: currentInstructions.filter(instr => instr.enabled)
            }),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");
            for (const line of lines) {
              if (line) {
                const parsed = JSON.parse(line);
                if (parsed.done) finalData = parsed;
                else if (parsed.message && parsed.message.content) assistantResponse += parsed.message.content;
                const shouldScroll = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight < 100;
                assistantMessageTextElement.innerHTML = formatMessageText(assistantResponse);
                extractAndDisplayCode(assistantResponse);
                if (shouldScroll) chatWindow.scrollTop = chatWindow.scrollHeight;
              }
            }
          }

          if (isContinuation) conversationHistory[lastMessageIndex].content = assistantResponse;
          else { history.push({ role: "assistant", content: assistantResponse }); assistantMessageElement.dataset.index = history.length - 1; }

          if (finalData) {
            const durationInSeconds = (finalData.total_duration / 1e9).toFixed(2);
            const tokens = finalData.eval_count;
            const statsElement = assistantMessageElement.querySelector('.text-muted');
            if (statsElement) statsElement.textContent = `Generated in ${durationInSeconds}s / ${tokens} tokens`;
          }
        } catch (error) {
          console.error("Error during chat:", error);
          assistantMessageTextElement.innerHTML = "Error communicating with Ollama.";
        }
      }

      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); chatForm.requestSubmit(); }
      });

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        conversationHistory.push({ role: "user", content: message });
        displayMessage("user", message, conversationHistory.length - 1);
        messageInput.value = "";
        autoGrowTextarea(messageInput);
        await sendChatRequest(conversationHistory);
      });

      // Settings Management
      let currentInstructions = [];
      let editingInstructionId = null;

      // Load settings from localStorage
      function loadSettings() {
        const saved = localStorage.getItem('ollamaSettings');
        if (saved) {
          const settings = JSON.parse(saved);
          currentInstructions = settings.instructions || [];
        }
        updateInstructionsList();
      }

      // Save settings to localStorage and server
      window.saveSettings = async function () {
        const settings = {
          instructions: currentInstructions,
        };

        // Save to localStorage
        localStorage.setItem('ollamaSettings', JSON.stringify(settings));

        // Save all settings to server
        await saveSettingsToServer();
      }

      // Instructions Management
      window.addNewInstruction = function () {
        editingInstructionId = null;
        document.getElementById('instructionModalTitle').textContent = 'Add Instruction';
        document.getElementById('instruction-name').value = '';
        document.getElementById('instruction-content').value = '';
        new bootstrap.Modal(document.getElementById('instructionModal')).show();
      }

      window.editInstruction = function (id) {
        const instruction = currentInstructions.find(i => i.id === id);
        if (instruction) {
          editingInstructionId = id;
          document.getElementById('instructionModalTitle').textContent = 'Edit Instruction';
          document.getElementById('instruction-name').value = instruction.name;
          document.getElementById('instruction-content').value = instruction.content;
          new bootstrap.Modal(document.getElementById('instructionModal')).show();
        }
      }

      window.saveInstruction = function () {
        const name = document.getElementById('instruction-name').value.trim();
        const content = document.getElementById('instruction-content').value.trim();

        if (!name || !content) {
          alert('Please fill in both name and content');
          return;
        }

        if (editingInstructionId) {
          // Edit existing
          const instruction = currentInstructions.find(i => i.id === editingInstructionId);
          instruction.name = name;
          instruction.content = content;
        } else {
          // Add new
          currentInstructions.push({
            id: Date.now().toString(),
            name: name,
            content: content,
            enabled: true
          });
        }

        updateInstructionsList();
        saveSettings(); // Save settings after adding/editing an instruction
        bootstrap.Modal.getInstance(document.getElementById('instructionModal')).hide();
      }

      window.toggleInstruction = function (id) {
        const instruction = currentInstructions.find(i => i.id === id);
        if (instruction) {
          instruction.enabled = !instruction.enabled;
          updateInstructionsList();
          saveSettings(); // Save settings after toggling an instruction
        }
      }

      window.deleteInstruction = function (id) {
        if (confirm('Are you sure you want to delete this instruction?')) {
          currentInstructions = currentInstructions.filter(i => i.id !== id);
          updateInstructionsList();
          saveSettings(); // Save settings after deleting an instruction
        }
      }

      function updateInstructionsList() {
        const container = document.getElementById('instructions-list');
        if (currentInstructions.length === 0) {
          container.innerHTML = '<div class="text-muted text-center py-3">No instructions configured</div>';
          return;
        }

        let html = '';
        currentInstructions.forEach(instruction => {
          html += `
            <div class="card mb-2">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                      <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" ${instruction.enabled ? 'checked' : ''} 
                               onchange="toggleInstruction('${instruction.id}')">
                      </div>
                      <h6 class="mb-0">${instruction.name}</h6>
                    </div>
                    <p class="text-muted small mb-0">${instruction.content.substring(0, 100)}${instruction.content.length > 100 ? '...' : ''}</p>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editInstruction('${instruction.id}')">Edit</button>
                    <button class="btn btn-outline-danger" onclick="deleteInstruction('${instruction.id}')">Delete</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      }

      // Load settings on page load
      loadSettings();
      loadModelSettings();

      fetchModels();

      document.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', function (e) {
          e.preventDefault();
          if (messageInput.value !== '') {
            messageInput.value += ' ';
          }
          messageInput.value += this.dataset.suggestion;
          autoGrowTextarea(messageInput);
        });
      });
    });

    // ===== SUGGESTIONS MANAGEMENT =====

    // Default suggestions
    const defaultSuggestions = [
      "give me a example of python script",
      "make a goodlooking webpage",
      "create a simple calculator",
      "build a todo list app",
      "write a PowerShell script",
      "design a responsive navbar"
    ];

    // Load suggestions from localStorage or use defaults
    function loadSuggestions() {
      const saved = localStorage.getItem('chatSuggestions');
      return saved ? JSON.parse(saved) : [...defaultSuggestions];
    }

    // Save suggestions to localStorage
    function saveSuggestions(suggestions) {
      localStorage.setItem('chatSuggestions', JSON.stringify(suggestions));
    }

    // Render suggestions dropdown
    function renderSuggestions() {
      const suggestions = loadSuggestions();
      const suggestionsList = document.getElementById('suggestionsList');

      suggestionsList.innerHTML = '';

      // Add suggestions
      suggestions.forEach((suggestion, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<a class="dropdown-item suggestion-item" href="#" data-suggestion="${suggestion}">${suggestion}</a>`;
        suggestionsList.appendChild(li);
      });

      // Add divider and manage option
      if (suggestions.length > 0) {
        const divider = document.createElement('li');
        divider.innerHTML = '<hr class="dropdown-divider">';
        suggestionsList.appendChild(divider);
      }

      const manageItem = document.createElement('li');
      manageItem.innerHTML = '<a class="dropdown-item text-primary" href="#" onclick="openSuggestionsManager()"><i class="nf nf-md-cog"></i> Manage Suggestions</a>';
      suggestionsList.appendChild(manageItem);

      // Add click handlers for suggestions
      document.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const suggestion = e.target.getAttribute('data-suggestion');
          document.getElementById('message-input').value = suggestion;
          document.getElementById('message-input').focus();
        });
      });
    }

    // Open suggestions manager modal
    function openSuggestionsManager() {
      renderExistingSuggestions();
      const modal = new bootstrap.Modal(document.getElementById('suggestionsModal'));
      modal.show();
    }

    // Render existing suggestions in the modal
    function renderExistingSuggestions() {
      const suggestions = loadSuggestions();
      const container = document.getElementById('existingSuggestions');

      if (suggestions.length === 0) {
        container.innerHTML = '<p class="text-muted">No suggestions yet. Add some above!</p>';
        return;
      }

      container.innerHTML = '';

      suggestions.forEach((suggestion, index) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'suggestion-item-edit mb-2 p-2 border rounded';
        suggestionDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <input type="text" class="form-control me-2" value="${suggestion}" id="suggestion-${index}">
            <button class="btn btn-sm btn-outline-primary me-1" onclick="updateSuggestion(${index})">üíæ</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSuggestion(${index})">üóëÔ∏è</button>
          </div>
        `;
        container.appendChild(suggestionDiv);
      });
    }

    // Add new suggestion
    function addNewSuggestion() {
      const input = document.getElementById('newSuggestionText');
      const text = input.value.trim();

      if (!text) {
        alert('Please enter a suggestion text');
        return;
      }

      const suggestions = loadSuggestions();

      // Check for duplicates
      if (suggestions.includes(text)) {
        alert('This suggestion already exists');
        return;
      }

      suggestions.push(text);
      saveSuggestions(suggestions);

      input.value = '';
      renderSuggestions();
      renderExistingSuggestions();

      // Show success message
      showNotification('Suggestion added successfully!');
    }

    // Update existing suggestion
    function updateSuggestion(index) {
      const input = document.getElementById(`suggestion-${index}`);
      const newText = input.value.trim();

      if (!newText) {
        alert('Suggestion cannot be empty');
        return;
      }

      const suggestions = loadSuggestions();

      // Check for duplicates (excluding current item)
      const otherSuggestions = suggestions.filter((_, i) => i !== index);
      if (otherSuggestions.includes(newText)) {
        alert('This suggestion already exists');
        return;
      }

      suggestions[index] = newText;
      saveSuggestions(suggestions);

      renderSuggestions();
      renderExistingSuggestions();

      showNotification('Suggestion updated successfully!');
    }

    // Delete suggestion
    function deleteSuggestion(index) {
      if (!confirm('Are you sure you want to delete this suggestion?')) {
        return;
      }

      const suggestions = loadSuggestions();
      suggestions.splice(index, 1);
      saveSuggestions(suggestions);

      renderSuggestions();
      renderExistingSuggestions();

      showNotification('Suggestion deleted successfully!');
    }

    // Reset to default suggestions
    function resetToDefaults() {
      if (!confirm('This will replace all your suggestions with the defaults. Are you sure?')) {
        return;
      }

      saveSuggestions([...defaultSuggestions]);
      renderSuggestions();
      renderExistingSuggestions();

      showNotification('Suggestions reset to defaults!');
    }

    // Show notification
    function showNotification(message) {
      // Create a simple toast notification
      const toast = document.createElement('div');
      toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible';
      toast.style.zIndex = '9999';
      toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      document.body.appendChild(toast);

      // Auto remove after 3 seconds
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }

    // ===== FILE UPLOAD FUNCTIONALITY =====

    // Open file upload dialog
    function openFileUpload() {
      document.getElementById('fileInput').click();
    }

    // Handle file selection
    function handleFileSelection(event) {
      const files = event.target.files;
      if (files.length === 0) return;

      // Process each selected file
      Array.from(files).forEach(async file => {
        try {
          const fileData = await readFileContent(file);
          displayFileMessage(fileData);
        } catch (error) {
          showNotification(`Error reading file: ${file.name}`, 'error');
        }
      });

      // Clear the input so the same file can be selected again
      event.target.value = '';
    }

    // Initialize suggestions and file upload on page load
    document.addEventListener('DOMContentLoaded', () => {
      renderSuggestions();

      // Add Enter key support for new suggestion input
      document.getElementById('newSuggestionText').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addNewSuggestion();
        }
      });

      // Add file input change handler
      document.getElementById('fileInput').addEventListener('change', handleFileSelection);
    });

    // ===== RAG FUNCTIONALITY =====

    // Check RAG system status
    async function checkRAGSystemStatus() {
      const statusDiv = document.getElementById('ragSystemStatus');

      // Show checking status
      statusDiv.className = 'alert alert-info mb-3';
      statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          <span>Checking RAG system status...</span>
        </div>
      `;

      let ragEndpoints = {
        search: false,
        addFile: false,
        documents: false,
        clear: false
      };

      let errorDetails = [];

      // Check each RAG endpoint
      try {
        const searchResponse = await fetch('/api/rag/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: 'test', n_results: 1 })
        });
        ragEndpoints.search = searchResponse.status !== 404;
        if (!ragEndpoints.search && searchResponse.status === 404) {
          errorDetails.push('Search endpoint not found');
        }
      } catch (e) {
        errorDetails.push(`Search endpoint error: ${e.message}`);
      }

      try {
        const docsResponse = await fetch('/api/rag/documents');
        ragEndpoints.documents = docsResponse.status !== 404;
        if (!ragEndpoints.documents && docsResponse.status === 404) {
          errorDetails.push('Documents endpoint not found');
        }
      } catch (e) {
        errorDetails.push(`Documents endpoint error: ${e.message}`);
      }

      // Check if any RAG endpoints are working
      const workingEndpoints = Object.values(ragEndpoints).filter(Boolean).length;

      if (workingEndpoints === 0) {
        // No RAG endpoints found - check requirements
        await checkRAGRequirements(statusDiv, errorDetails);
      } else if (workingEndpoints < 2) {
        // Partial functionality
        statusDiv.className = 'alert alert-warning rag-status-warning mb-3';
        statusDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <span class="rag-status-icon">‚ö†Ô∏è</span>
            <div>
              <strong>RAG System Partially Available</strong>
              <div class="small">
                Some endpoints working (${workingEndpoints}/4). Issues: ${errorDetails.join(', ')}
                <br><strong>Try:</strong> Restart your RAG server or check server logs
              </div>
            </div>
          </div>
        `;
      } else {
        // System appears to be working
        try {
          // Try to get actual status if available
          const statusResponse = await fetch('/api/rag/status');
          if (statusResponse.ok) {
            const data = await statusResponse.json();
            statusDiv.className = 'alert alert-success rag-status-ready mb-3';
            statusDiv.innerHTML = `
              <div class="d-flex align-items-center">
                <span class="rag-status-icon">‚úÖ</span>
                <div>
                  <strong>RAG System Ready</strong>
                  <div class="small">
                    Embedding Model: ${data.embedding_model || 'Available'} | 
                    Documents: ${data.document_count || 0} | 
                    Vector Store: ${data.vector_store_status || 'Ready'}
                  </div>
                </div>
              </div>
            `;
          } else {
            throw new Error('Status endpoint not available');
          }
        } catch (e) {
          // Endpoints work but no detailed status
          statusDiv.className = 'alert alert-success rag-status-ready mb-3';
          statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
              <span class="rag-status-icon">‚úÖ</span>
              <div>
                <strong>RAG System Available</strong>
                <div class="small">
                  Core endpoints responding (${workingEndpoints}/4) | Ready to use
                </div>
              </div>
            </div>
          `;
        }
      }
    }

    // Check specific RAG requirements
    async function checkRAGRequirements(statusDiv, errorDetails = []) {
      let missingComponents = [];
      let installInstructions = [];

      try {
        // Check if Ollama is running
        const ollamaResponse = await fetch('/api/tags');
        if (!ollamaResponse.ok) {
          missingComponents.push('Ollama server');
          installInstructions.push('Start Ollama server');
        } else {
          // Check if embedding model is available
          const models = await ollamaResponse.json();
          const hasEmbeddingModel = models.models?.some(model =>
            model.name.includes('embed') ||
            model.name.includes('nomic') ||
            model.name.includes('mxbai')
          );

          if (!hasEmbeddingModel) {
            missingComponents.push('Embedding model');
            installInstructions.push('Install embedding model: <code>ollama pull nomic-embed-text</code>');
          }
        }
      } catch (e) {
        missingComponents.push('Ollama connection');
        installInstructions.push('Ensure Ollama is running and accessible');
      }

      // Check RAG server endpoints
      const ragEndpointsToCheck = ['/api/rag/search', '/api/rag/documents', '/api/rag/add_file'];
      let ragServerWorking = false;

      for (const endpoint of ragEndpointsToCheck) {
        try {
          const response = await fetch(endpoint);
          if (response.status !== 404) {
            ragServerWorking = true;
            break;
          }
        } catch (e) {
          // Continue checking other endpoints
        }
      }

      if (!ragServerWorking) {
        missingComponents.push('RAG server');
        installInstructions.push('Start RAG server - check if your backend supports RAG endpoints');
        if (errorDetails.length > 0) {
          installInstructions.push(`Errors: ${errorDetails.join(', ')}`);
        }
      }

      // Display results
      if (missingComponents.length === 0) {
        statusDiv.className = 'alert alert-warning rag-status-warning mb-3';
        statusDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <span class="rag-status-icon">‚ö†Ô∏è</span>
            <div>
              <strong>RAG System Connection Issue</strong>
              <div class="small">Components appear available but connection failed. Try refreshing.</div>
            </div>
          </div>
        `;
      } else {
        statusDiv.className = 'alert alert-danger rag-status-error mb-3';
        statusDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <span class="rag-status-icon">‚ùå</span>
            <div>
              <strong>Missing RAG Components</strong>
              <div class="small">
                Missing: ${missingComponents.join(', ')}
                <ul class="mb-0 mt-1">
                  ${installInstructions.map(instruction => `<li>${instruction}</li>`).join('')}
                  <li>Install vector database (ChromaDB): <code>pip install chromadb</code></li>
                  <li>Install sentence transformers: <code>pip install sentence-transformers</code></li>
                </ul>
              </div>
            </div>
          </div>
        `;
      }
    }

    // Test RAG connection with detailed feedback
    async function testRAGConnection() {
      const statusDiv = document.getElementById('ragSystemStatus');

      statusDiv.className = 'alert alert-info mb-3';
      statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          <span>Testing RAG connection...</span>
        </div>
      `;

      const tests = [
        { name: 'Documents List', url: '/api/rag/documents', method: 'GET' },
        { name: 'Search Test', url: '/api/rag/search', method: 'POST', body: { query: 'test', n_results: 1 } },
        { name: 'Add File Test', url: '/api/rag/add_file', method: 'POST', body: { file_path: 'test.txt', metadata: {} } },
        { name: 'Clear Test', url: '/api/rag/clear', method: 'POST', body: {} }
      ];

      let results = [];

      for (const test of tests) {
        try {
          const options = {
            method: test.method,
            headers: { 'Content-Type': 'application/json' }
          };

          if (test.body) {
            options.body = JSON.stringify(test.body);
          }

          const response = await fetch(test.url, options);
          const status = response.status;

          if (status === 404) {
            results.push(`‚ùå ${test.name}: Endpoint not found (404)`);
          } else if (status >= 200 && status < 300) {
            results.push(`‚úÖ ${test.name}: Working (${status})`);
          } else if (status >= 400 && status < 500) {
            results.push(`‚ö†Ô∏è ${test.name}: Client error (${status}) - endpoint exists but request invalid`);
          } else if (status === 500 && test.name === 'Add File Test') {
            results.push(`‚ö†Ô∏è ${test.name}: Expected error (${status}) - endpoint working, test data invalid`);
          } else {
            results.push(`‚ùå ${test.name}: Server error (${status})`);
          }
        } catch (error) {
          results.push(`‚ùå ${test.name}: Connection failed - ${error.message}`);
        }
      }

      const workingTests = results.filter(r => r.includes('‚úÖ')).length;
      const partialTests = results.filter(r => r.includes('‚ö†Ô∏è')).length;

      let alertClass, icon, title;
      if (workingTests >= 2) {
        alertClass = 'alert alert-success rag-status-ready mb-3';
        icon = '‚úÖ';
        title = 'RAG Connection Test: PASSED';
      } else if (workingTests > 0 || partialTests > 0) {
        alertClass = 'alert alert-warning rag-status-warning mb-3';
        icon = '‚ö†Ô∏è';
        title = 'RAG Connection Test: PARTIAL';
      } else {
        alertClass = 'alert alert-danger rag-status-error mb-3';
        icon = '‚ùå';
        title = 'RAG Connection Test: FAILED';
      }

      statusDiv.className = alertClass;
      statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <span class="rag-status-icon">${icon}</span>
          <div>
            <strong>${title}</strong>
            <div class="small">
              <div class="mt-1">
                ${results.join('<br>')}
              </div>
              <div class="mt-2">
                <strong>Summary:</strong> ${workingTests} working, ${partialTests} partial, ${results.length - workingTests - partialTests} failed
              </div>
              ${workingTests >= 3 ? `
                <div class="mt-2 text-success">
                  <strong>‚úÖ RAG Ready:</strong> Your embedding model works automatically with any chat model you select.
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // File browser functions
    function ragBrowseFile() {
      document.getElementById('ragFileInput').click();
    }

    function ragBrowseFolder() {
      document.getElementById('ragFolderInput').click();
    }

    // Handle file selection from browser
    function ragHandleFileSelection(event) {
      const files = event.target.files;
      if (files.length > 0) {
        const file = files[0];

        // Show file details form
        document.getElementById('ragFileDetails').style.display = 'block';
        document.getElementById('ragSelectedPath').value = file.name;

        // Auto-detect category based on file extension
        const extension = file.name.toLowerCase().split('.').pop();
        const categoryMap = {
          'py': 'code',
          'js': 'code',
          'html': 'code',
          'css': 'code',
          'java': 'code',
          'cpp': 'code',
          'c': 'code',
          'cs': 'code',
          'php': 'code',
          'rb': 'code',
          'go': 'code',
          'rs': 'code',
          'kt': 'code',
          'swift': 'code',
          'md': 'documentation',
          'txt': 'documentation',
          'json': 'configuration',
          'xml': 'configuration',
          'yaml': 'configuration',
          'yml': 'configuration'
        };

        const suggestedCategory = categoryMap[extension] || 'general';
        document.getElementById('ragCategory').value = suggestedCategory;

        // Store file for later processing
        window.selectedRAGFile = file;
        window.selectedRAGType = 'file';
      }
    }

    // Handle folder selection from browser
    function ragHandleFolderSelection(event) {
      const files = event.target.files;
      if (files.length > 0) {
        // Get the common path from the first file
        const firstFile = files[0];
        const pathParts = firstFile.webkitRelativePath.split('/');
        const folderName = pathParts[0];

        // Show file details form
        document.getElementById('ragFileDetails').style.display = 'block';
        document.getElementById('ragSelectedPath').value = `${folderName} (${files.length} files)`;

        // Auto-suggest category based on folder name
        const folderLower = folderName.toLowerCase();
        let suggestedCategory = 'general';

        if (folderLower.includes('doc')) suggestedCategory = 'documentation';
        else if (folderLower.includes('src') || folderLower.includes('code')) suggestedCategory = 'code';
        else if (folderLower.includes('config')) suggestedCategory = 'configuration';
        else if (folderLower.includes('test')) suggestedCategory = 'notes';

        document.getElementById('ragCategory').value = suggestedCategory;

        // Store files for later processing
        window.selectedRAGFiles = files;
        window.selectedRAGType = 'folder';
        window.selectedRAGFolderName = folderName;

        // Show file count
        showNotification(`Selected folder with ${files.length} files`);
      }
    }

    // Cancel adding files
    function ragCancelAdd() {
      document.getElementById('ragFileDetails').style.display = 'none';
      document.getElementById('ragSelectedPath').value = '';
      document.getElementById('ragCategory').value = 'general';
      window.selectedRAGFile = null;
      window.selectedRAGFiles = null;
      window.selectedRAGType = null;
      window.selectedRAGFolderName = null;
    }

    // Confirm adding files to RAG
    async function ragConfirmAdd() {
      const category = document.getElementById('ragCategory').value;
      const progressDiv = document.getElementById('ragAddProgress');
      const progressBar = progressDiv.querySelector('.progress-bar');

      if (!window.selectedRAGType) {
        alert('No files selected');
        return;
      }

      // Show progress
      progressDiv.style.display = 'block';
      progressBar.style.width = '10%';

      try {
        if (window.selectedRAGType === 'file') {
          // Handle single file
          const file = window.selectedRAGFile;
          const fileContent = await readFileAsText(file);

          progressBar.style.width = '50%';

          const response = await fetch('/api/rag/add_file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              file_path: file.name,
              content: fileContent,
              metadata: { category, added_at: new Date().toISOString() }
            })
          });

          progressBar.style.width = '100%';

          const data = await response.json();
          if (data.success) {
            alert(`File added successfully! Created ${data.chunk_ids?.length || 1} chunks.`);
            ragCancelAdd();
            ragLoadDocuments();
          } else {
            alert('Failed to add file: ' + (data.error || 'Unknown error'));
          }
        } else if (window.selectedRAGType === 'folder') {
          // Handle folder
          const files = window.selectedRAGFiles;
          let successCount = 0;
          let totalChunks = 0;

          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const progress = ((i + 1) / files.length) * 100;
            progressBar.style.width = `${progress}%`;

            try {
              const fileContent = await readFileAsText(file);
              const response = await fetch('/api/rag/add_file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  file_path: file.webkitRelativePath || file.name,
                  content: fileContent,
                  metadata: { category, added_at: new Date().toISOString() }
                })
              });

              const data = await response.json();
              if (data.success) {
                successCount++;
                totalChunks += data.chunk_ids?.length || 1;
              }
            } catch (error) {
              console.error(`Error processing file ${file.name}:`, error);
            }
          }

          alert(`Folder processed!\nFiles added: ${successCount}/${files.length}\nTotal chunks created: ${totalChunks}`);
          ragCancelAdd();
          ragLoadDocuments();
        }
      } catch (error) {
        console.error('Error adding files:', error);
        alert('Failed to add files: ' + error.message);
      } finally {
        // Hide progress after 2 seconds
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
      }
    }

    // Helper function to read file as text
    async function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
      });
    }

    // Search documents
    async function ragSearchDocuments() {
      const query = document.getElementById('ragSearchQuery').value;
      const numResults = document.getElementById('ragNumResults').value;

      if (!query.trim()) {
        alert('Please enter a search query');
        return;
      }

      try {
        const response = await fetch('/api/rag/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, n_results: parseInt(numResults) })
        });

        const data = await response.json();
        ragDisplaySearchResults(data.results);
      } catch (error) {
        console.error('Search error:', error);
        alert('Search failed: ' + error.message);
      }
    }

    function ragDisplaySearchResults(results) {
      const container = document.getElementById('ragSearchResults');

      if (!results || results.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No results found</div>';
        return;
      }

      let html = '<h6>Search Results:</h6>';
      results.forEach((result, index) => {
        const distance = (result.distance * 100).toFixed(1);
        html += `
          <div class="card rag-search-result">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-title">Result ${index + 1}</h6>
                <span class="badge bg-secondary rag-distance-badge">Distance: ${distance}%</span>
              </div>
              <p class="card-text">${result.content.substring(0, 300)}${result.content.length > 300 ? '...' : ''}</p>
              <small class="text-muted">
                ${result.metadata.filename || 'Unknown file'} | 
                Chunk ${result.metadata.chunk_index + 1}/${result.metadata.chunk_count}
              </small>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // Add file
    async function ragAddFile() {
      const filePath = document.getElementById('ragFilePath').value;
      const category = document.getElementById('ragFileCategory').value;

      if (!filePath.trim()) {
        alert('Please enter a file path');
        return;
      }

      const metadata = {
        category: category || 'general',
        added_at: new Date().toISOString()
      };

      try {
        const response = await fetch('/api/rag/add_file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_path: filePath, metadata })
        });

        const data = await response.json();
        if (data.success) {
          alert(`File added successfully! Created ${data.chunk_ids.length} chunks.`);
          document.getElementById('ragFilePath').value = '';
          document.getElementById('ragFileCategory').value = '';
        }
      } catch (error) {
        console.error('Add file error:', error);
        alert('Failed to add file: ' + error.message);
      }
    }

    // Add folder
    async function ragAddFolder() {
      const folderPath = document.getElementById('ragFolderPath').value;
      const category = document.getElementById('ragFolderCategory').value;
      const recursive = document.getElementById('ragRecursiveFolder').checked;
      const extensions = document.getElementById('ragFileExtensions').value;

      if (!folderPath.trim()) {
        alert('Please enter a folder path');
        return;
      }

      const fileExtensions = extensions.split(',').map(ext => ext.trim()).filter(ext => ext);
      if (fileExtensions.length === 0) {
        alert('Please specify at least one file extension');
        return;
      }

      const metadata = {
        category: category || 'general',
        added_at: new Date().toISOString()
      };

      // Show progress
      const progressDiv = document.getElementById('ragFolderProgress');
      const progressBar = progressDiv.querySelector('.progress-bar');
      progressDiv.style.display = 'block';
      progressBar.style.width = '10%';

      try {
        const response = await fetch('/api/rag/add_directory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            directory_path: folderPath,
            metadata,
            recursive,
            file_extensions: fileExtensions
          })
        });

        progressBar.style.width = '50%';

        const data = await response.json();

        progressBar.style.width = '100%';

        if (data.success) {
          const totalFiles = Object.keys(data.added_files).length;
          const totalChunks = Object.values(data.added_files).reduce((sum, chunks) => sum + chunks.length, 0);

          alert(`Folder added successfully!\nFiles processed: ${totalFiles}\nTotal chunks created: ${totalChunks}`);

          document.getElementById('ragFolderPath').value = '';
          document.getElementById('ragFolderCategory').value = '';
          ragLoadDocuments(); // Refresh the documents list
        } else {
          alert('Failed to add folder: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Add folder error:', error);
        alert('Failed to add folder: ' + error.message);
      } finally {
        // Hide progress after 2 seconds
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
      }
    }

    // Load documents
    async function ragLoadDocuments() {
      try {
        const response = await fetch('/api/rag/documents');
        const data = await response.json();
        ragDisplayDocuments(data.documents);
      } catch (error) {
        console.error('Load documents error:', error);
        alert('Failed to load documents: ' + error.message);
      }
    }

    function ragDisplayDocuments(documents) {
      const container = document.getElementById('ragDocumentsList');

      if (!documents || documents.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No documents in collection</div>';
        return;
      }

      let html = '';
      documents.forEach(doc => {
        html += `
          <div class="card rag-document-card mb-3">
            <div class="card-body">
              <h6 class="card-title">${doc.metadata.title || doc.filename}</h6>
              <p class="card-text">
                <strong>Chunks:</strong> ${doc.chunk_count} | 
                <strong>File:</strong> ${doc.filename}
              </p>
              <small class="text-muted">
                Added: ${doc.metadata.added_at ? new Date(doc.metadata.added_at).toLocaleString() : 'Unknown'}
                ${doc.metadata.tags ? ' | Tags: ' + doc.metadata.tags.join(', ') : ''}
              </small>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // Clear collection
    async function ragClearCollection() {
      if (!confirm('Are you sure you want to clear all documents? This cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch('/api/rag/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();
        if (data.success) {
          alert('Collection cleared successfully!');
          ragLoadDocuments();
        }
      } catch (error) {
        console.error('Clear collection error:', error);
        alert('Failed to clear collection: ' + error.message);
      }
    }

    // Enter key support for RAG search and file input handlers
    document.addEventListener('DOMContentLoaded', () => {
      const ragSearchQuery = document.getElementById('ragSearchQuery');
      if (ragSearchQuery) {
        ragSearchQuery.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            ragSearchDocuments();
          }
        });
      }

      // Add file input event listeners
      const ragFileInput = document.getElementById('ragFileInput');
      if (ragFileInput) {
        ragFileInput.addEventListener('change', ragHandleFileSelection);
      }

      const ragFolderInput = document.getElementById('ragFolderInput');
      if (ragFolderInput) {
        ragFolderInput.addEventListener('change', ragHandleFolderSelection);
      }

      // Add confirm button event listener
      const ragConfirmBtn = document.getElementById('ragConfirmAdd');
      if (ragConfirmBtn) {
        ragConfirmBtn.addEventListener('click', ragConfirmAdd);
      }
    });

  </script>
  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Settings Tabs -->
          <ul class="nav nav-tabs mb-3" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="model-settings-tab" data-bs-toggle="tab"
                data-bs-target="#model-settings" type="button">Model</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="instructions-tab" data-bs-toggle="tab" data-bs-target="#instructions"
                type="button">Instructions</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="rag-tab" data-bs-toggle="tab" data-bs-target="#rag-settings"
                type="button">RAG</button>
            </li>
          </ul>

          <div class="tab-content" id="settingsTabContent">
            <!-- Model Settings Tab -->
            <div class="tab-pane fade show active" id="model-settings" role="tabpanel">
              <div class="mb-3">
                <label for="max-tokens-slider" class="form-label">
                  <i class="nf nf-fa-info_circle text-muted me-2" data-bs-toggle="tooltip" data-bs-placement="right"
                    title="How long the next answer can be.">
                  </i>Max Tokens: <span id="max-tokens-value">2048</span>
                </label>
                <input type="range" class="form-range" min="512" max="8192" step="512" id="max-tokens-slider"
                  value="2048">
              </div>
              <div class="mb-3">
                <label for="context-window-slider" class="form-label">
                  <i class="nf nf-fa-info_circle text-muted me-2" data-bs-toggle="tooltip" data-bs-placement="right"
                    title="How much of the past conversation the model remembers.">
                  </i>Context Window Size: <span id="context-window-value">4096</span>
                </label>
                <input type="range" class="form-range" min="2048" max="16384" step="2048" id="context-window-slider"
                  value="4096">
              </div>
              <div class="mb-3">
                <label for="temperature-slider" class="form-label">
                  <i class="nf nf-fa-info_circle text-muted me-2" data-bs-toggle="tooltip" data-bs-placement="right"
                    title="Controls the randomness of the output. Higher is more creative.">
                  </i>Temperature: <span id="temperature-value">0.8</span>
                </label>
                <input type="range" class="form-range" min="0" max="2" step="0.1" id="temperature-slider" value="0.8">
              </div>
              <div class="mb-3">
                <label for="top-p-slider" class="form-label">
                  <i class="nf nf-fa-info_circle text-muted me-2" data-bs-toggle="tooltip" data-bs-placement="right"
                    title="Controls nucleus sampling. Higher values consider more words.">
                  </i>Top P: <span id="top-p-value">0.9</span>
                </label>
                <input type="range" class="form-range" min="0" max="1" step="0.05" id="top-p-slider" value="0.9">
              </div>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetModelSettings()">Reset to
                  Defaults</button>
              </div>
            </div>

            <!-- Instructions Tab -->
            <div class="tab-pane fade" id="instructions" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6>System Instructions</h6>
                <button class="btn btn-sm btn-primary" onclick="addNewInstruction()">+ Add New</button>
              </div>
              <div id="instructions-list">
                <!-- Instructions will be loaded here -->
              </div>

              <!-- Add/Edit Instruction Modal -->
              <div class="modal fade" id="instructionModal" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="instructionModalTitle">Add Instruction</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="instruction-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="instruction-name"
                          placeholder="e.g., Code Assistant, Creative Writer">
                      </div>
                      <div class="mb-3">
                        <label for="instruction-content" class="form-label">Content</label>
                        <textarea class="form-control" id="instruction-content" rows="8"
                          placeholder="Enter your system instruction here..."></textarea>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-primary" onclick="saveInstruction()">Save</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- RAG Settings Tab -->
            <div class="tab-pane fade" id="rag-settings" role="tabpanel">
              <div class="mb-4">
                <h6>RAG (Retrieval-Augmented Generation) Settings</h6>
                <p class="text-muted small">Configure how the AI uses your knowledge base to enhance responses.</p>
              </div>

              <div class="mb-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="rag-enabled" checked>
                  <label class="form-check-label" for="rag-enabled">
                    <strong>Enable RAG</strong>
                  </label>
                </div>
                <small class="text-muted">When enabled, the AI will search your knowledge base for relevant context
                  before responding.</small>
              </div>

              <div class="mb-3">
                <label for="rag-max-results-slider" class="form-label">
                  <i class="nf nf-fa-info_circle text-muted me-2" data-bs-toggle="tooltip" data-bs-placement="right"
                    title="Maximum number of relevant chunks to include as context for each query.">
                  </i>Max Context Chunks: <span id="rag-max-results-value">3</span>
                </label>
                <input type="range" class="form-range" min="1" max="10" step="1" id="rag-max-results-slider" value="3">
                <small class="text-muted">Higher values provide more context but may slow down responses.</small>
              </div>

              <div class="mb-3">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">üìö Knowledge Base Status</h6>
                    <div id="rag-status">
                      <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span>Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between">
                <a href="rag_interface.html" class="btn btn-outline-primary" target="_blank">
                  üìö Manage Knowledge Base
                </a>
                <button type="button" class="btn btn-outline-secondary" onclick="resetRAGSettings()">Reset to
                  Defaults</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<div id="success-notification" class="success-notification">
  <span class="check-icon">‚úîÔ∏è</span> <span id="notification-message"></span>
</div>